<!-- app/templates/new_patient.html -->
{% extends "base.html" %}

{% block title %}{{ _('New Patient') }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Progress Steps -->
            <div class="progress-steps mb-4">
                <div class="step active" id="step1-indicator">
                    <div class="step-number">1</div>
                    <div class="step-title">{{ _('Patient Data') }}</div>
                </div>
                <div class="step" id="step2-indicator">
                    <div class="step-number">2</div>
                    <div class="step-title">{{ _('Clinical History') }}</div>
                </div>
                <div class="step" id="step3-indicator">
                    <div class="step-number">3</div>
                    <div class="step-title">{{ _('Portal Access') }}</div>
                </div>
            </div>

            <form action="{{ url_for('main.new_patient') }}" method="POST" id="newPatientForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Step 1: Patient Data (Now First) -->
                <div class="step-content active" id="step1">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-person-circle me-2"></i>
                                {{ _('Patient Data') }}
                            </h5>
                            <small class="opacity-75">{{ _('Start by entering basic patient information') }}</small>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label">{{ _('Full Name') }} <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                                <div class="col-md-6">
                                                            <label for="date_of_birth" class="form-label">{{ _('Date of Birth') }} <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" 
                               min="1900-01-01" max="2025-12-31" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="patient_contact_email" class="form-label">{{ _('Email Address') }}</label>
                                    <input type="email" class="form-control" id="patient_contact_email" name="patient_contact_email" placeholder="{{ _('patient@example.com') }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="patient_contact_phone" class="form-label">{{ _('Phone Number') }}</label>
                                    <input type="tel" class="form-control" id="patient_contact_phone" name="patient_contact_phone" placeholder="{{ _('+34 600 123 456') }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="status" class="form-label">{{ _('Status') }}</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="Active">{{ _('Active') }}</option>
                                        <option value="Inactive">{{ _('Inactive') }}</option>
                                        <option value="Completed">{{ _('Treatment Completed') }}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="address_line1" class="form-label">{{ _('Address Line 1') }}</label>
                                    <input type="text" class="form-control" id="address_line1" name="address_line1" placeholder="{{ _('Street address') }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="address_line2" class="form-label">{{ _('Address Line 2') }}</label>
                                    <input type="text" class="form-control" id="address_line2" name="address_line2" placeholder="{{ _('Apartment, suite, etc.') }}">
                                </div>
                                <div class="col-md-4">
                                    <label for="city" class="form-label">{{ _('City') }}</label>
                                    <input type="text" class="form-control" id="city" name="city">
                                </div>
                                <div class="col-md-4">
                                    <label for="postcode" class="form-label">{{ _('Postal Code') }}</label>
                                    <input type="text" class="form-control" id="postcode" name="postcode">
                                </div>
                                <div class="col-md-4">
                                    <label for="preferred_location" class="form-label">{{ _('Preferred Treatment Location') }}</label>
                                    <select class="form-select" id="preferred_location" name="preferred_location">
                                        <option value="">{{ _('Select location') }}</option>
                                        {% for location in current_user.locations %}
                                        <option value="{{ location.name }}">{{ location.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="anamnesis_gender" class="form-label">{{ _('Gender') }}</label>
                                    <select class="form-select" id="anamnesis_gender" name="anamnesis_gender">
                                        <option value="">{{ _('Select...') }}</option>
                                        <option value="male">{{ _('Male') }}</option>
                                        <option value="female">{{ _('Female') }}</option>
                                        <option value="other">{{ _('Other') }}</option>
                                        <option value="prefer_not_to_say">{{ _('Prefer not to say') }}</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="anamnesis_occupation" class="form-label">{{ _('Occupation') }}</label>
                                    <input type="text" class="form-control" id="anamnesis_occupation" name="anamnesis_occupation" 
                                           placeholder="{{ _('Current job or profession') }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="anamnesis_physical_activity" class="form-label">{{ _('Activity Level') }}</label>
                                    <select class="form-select" id="anamnesis_physical_activity" name="anamnesis_physical_activity">
                                        <option value="">{{ _('Select...') }}</option>
                                        <option value="sedentary">ü™ë {{ _('Sedentary') }}</option>
                                        <option value="light">üö∂ {{ _('Light') }}</option>
                                        <option value="moderate">üèÉ {{ _('Moderate') }}</option>
                                        <option value="active">üí™ {{ _('Very active') }}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="anamnesis_emergency_contact" class="form-label">{{ _('Emergency Contact') }}</label>
                                    <input type="text" class="form-control" id="anamnesis_emergency_contact" name="anamnesis_emergency_contact" placeholder="{{ _('Name and phone number') }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="anamnesis_sleep" class="form-label">{{ _('Sleep Quality') }}</label>
                                    <select class="form-select" id="anamnesis_sleep" name="anamnesis_sleep">
                                        <option value="">{{ _('Select...') }}</option>
                                        <option value="excellent">üò¥ {{ _('Excellent (7-9h, refreshing)') }}</option>
                                        <option value="good">üòä {{ _('Good (6-8h, mostly refreshing)') }}</option>
                                        <option value="fair">üòê {{ _('Fair (5-7h, sometimes tired)') }}</option>
                                        <option value="poor">üòµ {{ _('Poor (<6h, often tired)') }}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="anamnesis_work_posture" class="form-label">{{ _('Work Environment') }}</label>
                                    <select class="form-select" id="anamnesis_work_posture" name="anamnesis_work_posture">
                                        <option value="">{{ _('Select...') }}</option>
                                        <option value="desk">üíª {{ _('Desk job (computer work)') }}</option>
                                        <option value="standing">üßç {{ _('Standing work') }}</option>
                                        <option value="physical">üèóÔ∏è {{ _('Physical labor') }}</option>
                                        <option value="mixed">üîÑ {{ _('Mixed (sitting/standing)') }}</option>
                                        <option value="driving">üöó {{ _('Driving/Transport') }}</option>
                                        <option value="healthcare">üè• {{ _('Healthcare worker') }}</option>
                                        <option value="retired">üè° {{ _('Retired') }}</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="anamnesis_stress_level" class="form-label">{{ _('Stress Level (1-10)') }}</label>
                                    <input type="range" class="form-range" id="anamnesis_stress_level" name="anamnesis_stress_level" min="1" max="10" 
                                           oninput="updateStressDisplay(this.value)">
                                    <div class="d-flex justify-content-between">
                                        <small>üòå 1</small>
                                        <small id="stress-display">5</small>
                                        <small>üò∞ 10</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="anamnesis_diet_habits" class="form-label">{{ _('Dietary Habits') }}</label>
                                    <textarea class="form-control" id="anamnesis_diet_habits" name="anamnesis_diet_habits" rows="2" 
                                              placeholder="{{ _('Any dietary restrictions, special habits, or lifestyle factors affecting health...') }}"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="anamnesis_allergies" class="form-label">{{ _('Allergies') }}</label>
                                    <textarea class="form-control" id="anamnesis_allergies" name="anamnesis_allergies" rows="2" 
                                              placeholder="{{ _('Other allergies or specific reactions...') }}"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('main.index') }}" class="btn btn-secondary">{{ _('Cancel') }}</a>
                        <button type="button" class="btn btn-primary" onclick="nextStep(2)" id="step1-next">
                            {{ _('Next: Clinical History') }} <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Clinical History (Anamnesis) - Now Second -->
                <div class="step-content" id="step2">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-journal-medical me-2"></i>
                                {{ _('Clinical History (Anamnesis)') }}
                            </h5>
                            <small class="opacity-75">{{ _('Complete the clinical assessment step by step') }}</small>
                        </div>
                        <div class="card-body p-4">
                            
                            <!-- Progress Indicator -->
                            <div class="anamnesis-progress mb-4">
                                <div class="progress-header d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">{{ _('Assessment Progress') }}</span>
                                    <span class="badge bg-primary" id="progress-percentage">0%</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" id="anamnesis-progress-bar" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Essential Information (Always visible) -->
                            <div class="essential-info mb-4">
                                <h6 class="section-title">
                                    <i class="bi bi-exclamation-circle-fill text-danger me-2"></i>
                                    {{ _('Essential Information') }}
                                    <span class="required-badge">{{ _('Required') }}</span>
                                </h6>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="anamnesis_chief_complaint" class="form-label fw-semibold">
                                            <i class="bi bi-chat-dots text-primary me-1"></i>
                                            {{ _('Chief Complaint') }} <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" id="anamnesis_chief_complaint" name="anamnesis_chief_complaint" 
                                                  rows="3" required
                                                  placeholder="{{ _('What is the main reason for this visit? (e.g., Lower back pain for 2 weeks...)') }}"
                                                  onchange="updateProgress()"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="anamnesis_pain_scale" class="form-label fw-semibold">
                                            <i class="bi bi-thermometer-half text-warning me-1"></i>
                                            {{ _('Current Pain Level') }} <span class="text-danger">*</span>
                                        </label>
                                        <div class="pain-scale-container">
                                            <input type="range" class="form-range" id="anamnesis_pain_scale" name="anamnesis_pain_scale" 
                                                   min="0" max="10" value="0" required
                                                   oninput="updatePainDisplay(this.value); updateProgress()">
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <small class="text-muted">üòä 0</small>
                                                <div class="text-center">
                                                    <span id="pain-display" class="badge bg-success fs-6">0</span>
                                                    <div><small id="pain-description">{{ _('No pain') }}</small></div>
                                                </div>
                                                <small class="text-muted">üòµ 10</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3 mt-2">
                                    <div class="col-md-4">
                                        <label for="anamnesis_onset_date" class="form-label fw-semibold">
                                            <i class="bi bi-calendar-event text-info me-1"></i>
                                            {{ _('When did it start?') }}
                                        </label>
                                        <input type="date" class="form-control" id="anamnesis_onset_date" name="anamnesis_onset_date" 
                                               onchange="updateProgress()">
                                    </div>
                                    <div class="col-md-8">
                                        <label for="anamnesis_mechanism" class="form-label fw-semibold">
                                            <i class="bi bi-gear text-secondary me-1"></i>
                                            {{ _('How did it happen?') }}
                                        </label>
                                        <input type="text" class="form-control" id="anamnesis_mechanism" name="anamnesis_mechanism" 
                                               placeholder="{{ _('e.g., Lifting heavy box, fell down stairs, gradual onset...') }}"
                                               onchange="updateProgress()">
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Sections -->
                            <div class="accordion anamnesis-accordion" id="anamnesisAccordion">
                                
                                <!-- Personal Information -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                data-bs-target="#personalInfo" aria-expanded="false">
                                            <i class="bi bi-person-circle text-primary me-2"></i>
                                            <span class="fw-semibold">{{ _('Personal Information') }}</span>
                                            <span class="badge bg-light text-dark ms-2" id="personal-info-status">{{ _('Optional') }}</span>
                                        </button>
                                    </h2>
                                    <div id="personalInfo" class="accordion-collapse collapse" data-bs-parent="#anamnesisAccordion">
                                        <div class="accordion-body">
                                            <div class="row g-3">
                                                <div class="col-md-4">
                                                    <label for="anamnesis_gender" class="form-label">{{ _('Gender') }}</label>
                                                    <select class="form-select" id="anamnesis_gender" name="anamnesis_gender" onchange="updateProgress()">
                                                        <option value="">{{ _('Select...') }}</option>
                                                        <option value="male">{{ _('Male') }}</option>
                                                        <option value="female">{{ _('Female') }}</option>
                                                        <option value="other">{{ _('Other') }}</option>
                                                        <option value="prefer_not_to_say">{{ _('Prefer not to say') }}</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="anamnesis_occupation" class="form-label">{{ _('Occupation') }}</label>
                                                    <input type="text" class="form-control" id="anamnesis_occupation" name="anamnesis_occupation" 
                                                           placeholder="{{ _('Current job or profession') }}" onchange="updateProgress()">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="anamnesis_physical_activity" class="form-label">{{ _('Activity Level') }}</label>
                                                    <select class="form-select" id="anamnesis_physical_activity" name="anamnesis_physical_activity" onchange="updateProgress()">
                                                        <option value="">{{ _('Select...') }}</option>
                                                        <option value="sedentary">ü™ë {{ _('Sedentary') }}</option>
                                                        <option value="light">üö∂ {{ _('Light') }}</option>
                                                        <option value="moderate">üèÉ {{ _('Moderate') }}</option>
                                                        <option value="active">üí™ {{ _('Very active') }}</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Medical History -->
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                data-bs-target="#medicalHistory" aria-expanded="false">
                                            <i class="bi bi-heart-pulse text-danger me-2"></i>
                                            <span class="fw-semibold">{{ _('Medical History') }}</span>
                                            <span class="badge bg-warning text-dark ms-2">{{ _('Important') }}</span>
                                        </button>
                                    </h2>
                                    <div id="medicalHistory" class="accordion-collapse collapse" data-bs-parent="#anamnesisAccordion">
                                        <div class="accordion-body">
                                            <div class="mb-3">
                                                <label class="form-label fw-semibold">{{ _('Previous Conditions') }}</label>
                                                <div class="condition-grid">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="history_diabetes" name="history_conditions" value="diabetes" onchange="updateProgress()">
                                                        <label class="form-check-label" for="history_diabetes">{{ _('Diabetes') }}</label>
                                                </div>
                                                        <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="history_hypertension" name="history_conditions" value="hypertension" onchange="updateProgress()">
                                                        <label class="form-check-label" for="history_hypertension">{{ _('Hypertension') }}</label>
                                                </div>
                                                        <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="history_heart_disease" name="history_conditions" value="heart_disease" onchange="updateProgress()">
                                                        <label class="form-check-label" for="history_heart_disease">{{ _('Heart Disease') }}</label>
                                                </div>
                                                        <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="history_arthritis" name="history_conditions" value="arthritis" onchange="updateProgress()">
                                                        <label class="form-check-label" for="history_arthritis">{{ _('Arthritis') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_none" name="history_conditions" value="none" onchange="toggleNoConditions(this); updateProgress()">
                                                    <label class="form-check-label fw-semibold" for="history_none">{{ _('No previous conditions') }}</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="anamnesis_medications" class="form-label">{{ _('Current Medications') }}</label>
                                            <textarea class="form-control" id="anamnesis_medications" name="anamnesis_medications" 
                                                      rows="2" placeholder="{{ _('List any medications, supplements, or treatments...') }}"
                                                      onchange="updateProgress()"></textarea>
                                    </div>

                                        <div class="mb-3">
                                            <label class="form-label">{{ _('Allergies') }}</label>
                                            <div class="allergy-grid">
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_medications" name="allergies" value="medications" onchange="updateProgress()">
                                                    <label class="form-check-label" for="allergy_medications">{{ _('Medications') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_latex" name="allergies" value="latex" onchange="updateProgress()">
                                                    <label class="form-check-label" for="allergy_latex">{{ _('Latex') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_food" name="allergies" value="food" onchange="updateProgress()">
                                                    <label class="form-check-label" for="allergy_food">{{ _('Food') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_none" name="allergies" value="none" onchange="toggleNoAllergies(this); updateProgress()">
                                                    <label class="form-check-label fw-semibold" for="allergy_none">{{ _('No known allergies') }}</label>
                                                    </div>
                                                    </div>
                                                </div>
                                        </div>
                                </div>
                            </div>

                            <!-- Pain Details -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#painDetails" aria-expanded="false">
                                        <i class="bi bi-lightning-fill text-warning me-2"></i>
                                        <span class="fw-semibold">{{ _('Pain & Symptoms Details') }}</span>
                                        <span class="badge bg-info ms-2">{{ _('Helpful') }}</span>
                                    </button>
                                </h2>
                                <div id="painDetails" class="accordion-collapse collapse" data-bs-parent="#anamnesisAccordion">
                                    <div class="accordion-body">
                                        <div class="row g-3">
                                                <div class="col-md-6">
                                                <label for="anamnesis_pain_location" class="form-label">{{ _('Pain Location') }}</label>
                                                <select class="form-select" id="anamnesis_pain_location" name="anamnesis_pain_location" onchange="updateProgress()">
                                                    <option value="">{{ _('Select location...') }}</option>
                                                    <option value="neck">ü¶í {{ _('Neck') }}</option>
                                                    <option value="shoulder">ü§∑ {{ _('Shoulder') }}</option>
                                                    <option value="upper_back">üéí {{ _('Upper back') }}</option>
                                                    <option value="lower_back">üèÉ‚Äç‚ôÇÔ∏è {{ _('Lower back') }}</option>
                                                    <option value="hip">ü¶¥ {{ _('Hip') }}</option>
                                                    <option value="knee">ü¶µ {{ _('Knee') }}</option>
                                                    <option value="ankle">ü¶∂ {{ _('Ankle/Foot') }}</option>
                                                    <option value="other">{{ _('Other') }}</option>
                                                </select>
                                                    </div>
                                            <div class="col-md-6">
                                                <label class="form-label">{{ _('Pain Type') }}</label>
                                                <div class="pain-type-grid">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="pain_sharp" name="pain_characteristics" value="sharp" onchange="updateProgress()">
                                                        <label class="form-check-label" for="pain_sharp">‚ö° {{ _('Sharp') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="pain_dull" name="pain_characteristics" value="dull" onchange="updateProgress()">
                                                        <label class="form-check-label" for="pain_dull">üü§ {{ _('Dull') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="pain_burning" name="pain_characteristics" value="burning" onchange="updateProgress()">
                                                        <label class="form-check-label" for="pain_burning">üî• {{ _('Burning') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="pain_throbbing" name="pain_characteristics" value="throbbing" onchange="updateProgress()">
                                                        <label class="form-check-label" for="pain_throbbing">üíì {{ _('Throbbing') }}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row g-3 mt-3">
                                            <div class="col-md-6">
                                                <label for="anamnesis_pain_triggers" class="form-label">{{ _('What makes it worse?') }}</label>
                                                <textarea class="form-control" id="anamnesis_pain_triggers" name="anamnesis_pain_triggers" 
                                                          rows="2" placeholder="{{ _('Movement, sitting, weather...') }}"
                                                          onchange="updateProgress()"></textarea>
                                        </div>
                                                    <div class="col-md-6">
                                                <label for="anamnesis_pain_relievers" class="form-label">{{ _('What makes it better?') }}</label>
                                                <textarea class="form-control" id="anamnesis_pain_relievers" name="anamnesis_pain_relievers" 
                                                          rows="2" placeholder="{{ _('Rest, heat, cold, medication...') }}"
                                                          onchange="updateProgress()"></textarea>
                                                </div>
                                                </div>
                                                </div>
                                        </div>
                                </div>
                                
                            <!-- Functional Assessment -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#functionalAssessment" aria-expanded="false">
                                        <i class="bi bi-activity text-success me-2"></i>
                                        <span class="fw-semibold">{{ _('Functional Assessment') }}</span>
                                        <span class="badge bg-light text-dark ms-2">{{ _('Optional') }}</span>
                                    </button>
                                </h2>
                                <div id="functionalAssessment" class="accordion-collapse collapse" data-bs-parent="#anamnesisAccordion">
                                    <div class="accordion-body">
                                        <div class="mb-3">
                                            <label class="form-label">{{ _('Current Limitations') }}</label>
                                            <div class="limitations-grid">
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_walking" name="functional_limitations" value="walking" onchange="updateProgress()">
                                                    <label class="form-check-label" for="limit_walking">üö∂ {{ _('Walking') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_sitting" name="functional_limitations" value="sitting" onchange="updateProgress()">
                                                    <label class="form-check-label" for="limit_sitting">ü™ë {{ _('Sitting') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_lifting" name="functional_limitations" value="lifting" onchange="updateProgress()">
                                                    <label class="form-check-label" for="limit_lifting">üèãÔ∏è {{ _('Lifting') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_sleep" name="functional_limitations" value="sleep" onchange="updateProgress()">
                                                    <label class="form-check-label" for="limit_sleep">üò¥ {{ _('Sleep') }}</label>
                                                    </div>
                                                    <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_none" name="functional_limitations" value="none" onchange="toggleNoLimitations(this); updateProgress()">
                                                    <label class="form-check-label fw-semibold" for="limit_none">{{ _('No limitations') }}</label>
                                                    </div>
                                                    </div>
                                                </div>

                                        <div class="mb-3">
                                            <label for="anamnesis_additional_notes" class="form-label">{{ _('Additional Notes') }}</label>
                                            <textarea class="form-control" id="anamnesis_additional_notes" name="anamnesis_additional_notes" 
                                                      rows="3" placeholder="{{ _('Any other relevant information...') }}"
                                                      onchange="updateProgress()"></textarea>
                                            </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>

                            <!-- Hidden field to store compiled anamnesis -->
                            <input type="hidden" id="compiled_anamnesis" name="anamnesis">
                            
                                        <!-- Smart Summary -->
            <div class="anamnesis-summary mt-4 p-3 bg-light rounded" id="anamnesis-summary" style="display: none;">
                <h6 class="text-primary mb-2">
                    <i class="bi bi-check-circle-fill me-2"></i>{{ _('Assessment Summary') }}
                </h6>
                <div id="summary-content" class="small text-muted"></div>
            </div>
        </div>
    </div>

    <!-- Navigation buttons for Step 2 -->
    <div class="d-flex justify-content-between mt-4">
        <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
            <i class="bi bi-arrow-left"></i> {{ _('Back: Patient Data') }}
        </button>
        <button type="button" class="btn btn-primary" onclick="nextStep(3)" id="step2-next">
            {{ _('Next: Portal Access') }} <i class="bi bi-arrow-right"></i>
        </button>
    </div>
</div>

                    <!-- Step 3: Portal Access -->
                    <div class="step-content" id="step3">
                        <h5 class="mb-3">{{ _('Patient Portal Access (Optional)') }}</h5>
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> 
                            <strong>{{ _('This step is completely optional.') }}</strong> 
                            {{ _('If you do not want the patient to have portal access, simply click "Create Patient" without filling anything.') }}
                        </div>
                        <p class="text-muted">{{ _('Enter an email and password if you want the patient to be able to log in and view their exercise prescriptions.') }}</p>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patient_email" class="form-label">{{ _('Login Email') }} <span class="text-muted">{{ _('(Optional)') }}</span></label>
                                <input type="email" class="form-control" id="patient_email" name="patient_email" placeholder="{{ _('patient@example.com') }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patient_password" class="form-label">{{ _('Password') }} <span class="text-muted">{{ _('(Only if you provide email)') }}</span></label>
                                <input type="password" class="form-control" id="patient_password" name="patient_password" placeholder="{{ _('Set initial password') }}">
                                <small class="form-text text-muted">{{ _('Leave blank if login email is not provided.') }}</small>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
                                <i class="bi bi-arrow-left"></i> {{ _('Back: Clinical History') }}
                            </button>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary" onclick="skipPortalAccess()">
                                    <i class="bi bi-skip-forward"></i> {{ _('Skip Portal') }}
                                </button>
                                <button type="submit" class="btn btn-success" onclick="return validatePortalAccess()">
                                    <i class="bi bi-check-circle"></i> {{ _('Create Patient') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 60%;
    width: 80%;
    height: 2px;
    background-color: #dee2e6;
    z-index: 1;
}

.step.active:not(:last-child)::after {
    background-color: #0d6efd;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #dee2e6;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    z-index: 2;
    position: relative;
    background-color: white;
    border: 2px solid #dee2e6;
}

.step.active .step-number {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.step.completed .step-number {
    background-color: #198754;
    color: white;
    border-color: #198754;
}

.step-title {
    font-size: 0.9rem;
    color: #6c757d;
    text-align: center;
}

.step.active .step-title {
    color: #0d6efd;
    font-weight: 600;
}

.step.completed .step-title {
    color: #198754;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}
</style>

<script>
let currentStep = 1;
let isSkippingPortal = false; // Variable global para controlar cuando saltamos el portal

// ==== INTERACTIVE FUNCTIONS FOR SEXY ANAMNESIS ====

// Quick diagnosis selection auto-fill (disabled - diagnosis field not available)
function fillDiagnosisFromQuick() {
    const quickSelect = document.getElementById('quick_diagnosis');
    const diagnosisField = document.getElementById('diagnosis');
    
    // Diagnosis field not available in current form structure
    if (false && quickSelect.value && diagnosisField) {
        const diagnosisMap = {
            'tendinopathy': 'Tendinopat√≠a',
            'grade2_sprain': 'Esguince Grado II',
            'grade1_sprain': 'Esguince Grado I',
            'muscle_strain': 'Distensi√≥n Muscular',
            'joint_stiffness': 'Rigidez Articular',
            'chronic_pain': 'Dolor Cr√≥nico',
            'lower_back_pain': 'Lumbalgia',
            'cervical_pain': 'Cervicalgia',
            'herniated_disc': 'Hernia Discal',
            'sciatica': 'Ci√°tica',
            'whiplash': 'Latigazo Cervical',
            'runners_knee': 'Rodilla del Corredor',
            'tennis_elbow': 'Codo de Tenista',
            'shoulder_impingement': 'S√≠ndrome de Pinzamiento del Hombro',
            'acl_injury': 'Lesi√≥n del LCA',
            'rotator_cuff': 'Lesi√≥n del Manguito Rotador',
            'post_surgery_knee': 'Rehabilitaci√≥n Post-Cirug√≠a de Rodilla',
            'post_surgery_shoulder': 'Rehabilitaci√≥n Post-Cirug√≠a de Hombro',
            'post_surgery_hip': 'Rehabilitaci√≥n Post-Cirug√≠a de Cadera'
        };
        
        diagnosisField.value = diagnosisMap[quickSelect.value] || quickSelect.value;
    }
}

// Pain scale visual feedback
function updatePainDisplay(value) {
    const display = document.getElementById('pain-display');
    const description = document.getElementById('pain-description');
    
    const painDescriptions = {
        0: 'Sin dolor',
        1: 'Dolor muy leve',
        2: 'Dolor leve', 
        3: 'Dolor moderado',
        4: 'Dolor notable',
        5: 'Dolor fuerte',
        6: 'Dolor intenso',
        7: 'Dolor severo',
        8: 'Dolor muy severo',
        9: 'Dolor insoportable',
        10: 'Peor dolor imaginable'
    };
    
    display.textContent = value;
    description.textContent = painDescriptions[value] || 'Dolor';
    
    // Change color based on pain level
    display.className = 'badge fs-6 ' + (
        value <= 2 ? 'bg-success' :
        value <= 4 ? 'bg-warning' :
        value <= 6 ? 'bg-warning text-dark' :
        value <= 8 ? 'bg-danger' : 'bg-dark'
    );
}

// Stress level display
function updateStressDisplay(value) {
    document.getElementById('stress-display').textContent = value;
}

// Show activity details when activity level is selected
function showActivityDetails(value) {
    const detailsDiv = document.getElementById('activity-details');
    if (value && value !== '') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

// Surgery management
function addSurgery() {
    const container = document.getElementById('surgeries-container');
    if (!container) return;
    
    const newSurgery = document.createElement('div');
    newSurgery.className = 'surgery-entry row mb-2';
    newSurgery.innerHTML = 
        '<div class="col-md-6">' +
            '<input type="text" class="form-control" name="surgery_description[]" placeholder="{{ _("Type of surgery") }}">' +
        '</div>' +
        '<div class="col-md-4">' +
            '<input type="date" class="form-control" name="surgery_date[]">' +
        '</div>' +
        '<div class="col-md-2">' +
            '<button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSurgery(this)">' +
                '<i class="bi bi-trash"></i>' +
            '</button>' +
        '</div>';
    container.appendChild(newSurgery);
}

function removeSurgery(button) {
    button.closest('.surgery-entry').remove();
}

// Allergy management
function toggleNoAllergies(checkbox) {
    const allergyCheckboxes = document.querySelectorAll('input[name="allergies"]:not(#allergy_none)');
    if (checkbox.checked) {
        allergyCheckboxes.forEach(cb => cb.checked = false);
    }
}

// Family history management
function toggleNoFamilyHistory(checkbox) {
    const familyCheckboxes = document.querySelectorAll('input[name="family_conditions"]:not(#family_none)');
    if (checkbox.checked) {
        familyCheckboxes.forEach(cb => cb.checked = false);
    }
}

// Function to compile all anamnesis fields into one (updated for simplified form)
function compileAnamnesis() {
    // Helper function to safely get element value
    function safeGetValue(elementId) {
        const element = document.getElementById(elementId);
        return element ? element.value.trim() : '';
    }
    
    // Helper function to get selected checkboxes
    function getSelectedCheckboxes(name) {
        const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
        return Array.from(checkboxes).map(cb => cb.value).filter(value => value && value !== 'none');
    }
    
    // Calculate age from date of birth
    function calculateAge(birthDate) {
        if (!birthDate) return '';
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age.toString();
    }

    // Create simplified anamnesis data structure for new form
    const anamnesisData = {
        // Essential Information (always included)
        anamnesis_chief_complaint: safeGetValue('anamnesis_chief_complaint'),
        anamnesis_pain_scale: safeGetValue('anamnesis_pain_scale'),
        anamnesis_onset_date: safeGetValue('anamnesis_onset_date'),
        anamnesis_mechanism: safeGetValue('anamnesis_mechanism'),
        
        // Personal Information
        anamnesis_gender: safeGetValue('anamnesis_gender'),
        anamnesis_occupation: safeGetValue('anamnesis_occupation'),
        anamnesis_physical_activity: safeGetValue('anamnesis_physical_activity'),
        
        // Medical History
            history_conditions: getSelectedCheckboxes('history_conditions'),
        anamnesis_medications: safeGetValue('anamnesis_medications'),
        allergies: getSelectedCheckboxes('allergies'),
        
        // Pain Details
        anamnesis_pain_location: safeGetValue('anamnesis_pain_location'),
        pain_characteristics: getSelectedCheckboxes('pain_characteristics'),
        anamnesis_pain_triggers: safeGetValue('anamnesis_pain_triggers'),
        anamnesis_pain_relievers: safeGetValue('anamnesis_pain_relievers'),
        
        // Functional Assessment
        functional_limitations: getSelectedCheckboxes('functional_limitations'),
        anamnesis_additional_notes: safeGetValue('anamnesis_additional_notes'),
        
        // Metadata
        form_version: '2.0_simplified',
        created_date: new Date().toISOString(),
        patient_age: calculateAge(safeGetValue('date_of_birth'))
    };

    // Create both structured JSON and formatted text for backwards compatibility
    let compiledText = '';
    
    // Essential Information (always shown)
    if (anamnesisData.anamnesis_chief_complaint || anamnesisData.anamnesis_pain_scale) {
        compiledText += '=== INFORMACI√ìN ESENCIAL ===\n';
        if (anamnesisData.anamnesis_chief_complaint) compiledText += `Motivo principal: ${anamnesisData.anamnesis_chief_complaint}\n`;
        if (anamnesisData.anamnesis_pain_scale) compiledText += `Escala de dolor: ${anamnesisData.anamnesis_pain_scale}/10\n`;
        if (anamnesisData.anamnesis_onset_date) compiledText += `Fecha de inicio: ${anamnesisData.anamnesis_onset_date}\n`;
        if (anamnesisData.anamnesis_mechanism) compiledText += `Mecanismo: ${anamnesisData.anamnesis_mechanism}\n`;
        compiledText += '\n';
    }
    
    // Personal Information
    if (anamnesisData.anamnesis_gender || anamnesisData.anamnesis_occupation || anamnesisData.anamnesis_physical_activity) {
        compiledText += '=== INFORMACI√ìN PERSONAL ===\n';
        if (anamnesisData.anamnesis_gender) compiledText += `G√©nero: ${anamnesisData.anamnesis_gender}\n`;
        if (anamnesisData.anamnesis_occupation) compiledText += `Ocupaci√≥n: ${anamnesisData.anamnesis_occupation}\n`;
        if (anamnesisData.anamnesis_physical_activity) compiledText += `Nivel de actividad: ${anamnesisData.anamnesis_physical_activity}\n`;
        compiledText += '\n';
    }
    
    // Medical History
    if (anamnesisData.history_conditions.length > 0 || anamnesisData.anamnesis_medications || anamnesisData.allergies.length > 0) {
        compiledText += '=== HISTORIA M√âDICA ===\n';
        if (anamnesisData.history_conditions.length > 0) {
            compiledText += `Condiciones previas: ${anamnesisData.history_conditions.join(', ')}\n`;
        }
        if (anamnesisData.anamnesis_medications) compiledText += `Medicamentos actuales: ${anamnesisData.anamnesis_medications}\n`;
        if (anamnesisData.allergies.length > 0) {
            compiledText += `Alergias: ${anamnesisData.allergies.join(', ')}\n`;
        }
        compiledText += '\n';
    }
    
    // Pain Details
    if (anamnesisData.anamnesis_pain_location || anamnesisData.pain_characteristics.length > 0 || anamnesisData.anamnesis_pain_triggers || anamnesisData.anamnesis_pain_relievers) {
        compiledText += '=== DETALLES DEL DOLOR ===\n';
        if (anamnesisData.anamnesis_pain_location) compiledText += `Localizaci√≥n: ${anamnesisData.anamnesis_pain_location}\n`;
        if (anamnesisData.pain_characteristics.length > 0) {
            compiledText += `Caracter√≠sticas: ${anamnesisData.pain_characteristics.join(', ')}\n`;
        }
        if (anamnesisData.anamnesis_pain_triggers) compiledText += `Factores agravantes: ${anamnesisData.anamnesis_pain_triggers}\n`;
        if (anamnesisData.anamnesis_pain_relievers) compiledText += `Factores aliviantes: ${anamnesisData.anamnesis_pain_relievers}\n`;
        compiledText += '\n';
    }
    
    // Functional Assessment
    if (anamnesisData.functional_limitations.length > 0 || anamnesisData.anamnesis_additional_notes) {
        compiledText += '=== EVALUACI√ìN FUNCIONAL ===\n';
        if (anamnesisData.functional_limitations.length > 0) {
            compiledText += `Limitaciones funcionales: ${anamnesisData.functional_limitations.join(', ')}\n`;
        }
        if (anamnesisData.anamnesis_additional_notes) compiledText += `Notas adicionales: ${anamnesisData.anamnesis_additional_notes}\n`;
        compiledText += '\n';
    }
    
    // If no sections were filled, at least add the chief complaint if it exists
    if (!compiledText && anamnesisData.anamnesis_chief_complaint) {
        compiledText = `MOTIVO DE CONSULTA: ${anamnesisData.anamnesis_chief_complaint}\n`;
    }
    
    // Create final compiled data (JSON with formatted text for backwards compatibility)
    const finalData = {
        ...anamnesisData,
        formatted_text: compiledText
    };
    
    // Set the compiled anamnesis in the hidden field (store as JSON)
    const compiledField = document.getElementById('compiled_anamnesis');
    if (compiledField) {
        compiledField.value = JSON.stringify(finalData, null, 2);
        console.log('DEBUG: Anamnesis compiled successfully. Length:', JSON.stringify(finalData).length);
    } else {
        console.error('ERROR: compiled_anamnesis field not found!');
    }
    
    return JSON.stringify(finalData, null, 2);
}

function nextStep(step) {
    // Validate current step
    if (currentStep === 1) {
        // Check required patient data fields first
        const name = document.getElementById('name').value.trim();
        const dob = document.getElementById('date_of_birth').value;
        const email = document.getElementById('patient_contact_email').value.trim();
        const phone = document.getElementById('patient_contact_phone').value.trim();
        
        // Debug: Log field values
        console.log('Validation Debug:');
        console.log('Name:', name, '(length:', name.length, ')');
        console.log('DOB:', dob, '(length:', dob.length, ')');
        console.log('Email:', email, '(length:', email.length, ')');
        console.log('Phone:', phone, '(length:', phone.length, ')');
        
        let missingFields = [];
        if (!name) missingFields.push('Nombre');
        if (!dob) missingFields.push('Fecha de Nacimiento');
        // Contact is not required anymore since we have separate email/phone fields
        
        if (missingFields.length > 0) {
            // DON'T clear any form data - just show alert and stay on current step
            alert('Faltan los siguientes campos obligatorios: ' + missingFields.join(', '));
            // Focus on the first missing field
            if (!name) document.getElementById('name').focus();
            else if (!dob) document.getElementById('date_of_birth').focus();
            return; // Stay on current step without clearing data
        }
        
        // No additional validation needed for Step 1 to Step 2
        // Chief complaint validation will happen when moving from Step 2 to Step 3
    }
    
    if (currentStep === 2) {
        // Check if at least the chief complaint is filled before going to Step 3
        const chiefComplaint = document.getElementById('anamnesis_chief_complaint').value.trim();
        if (!chiefComplaint) {
            alert('{{ _("Please complete at least the main reason for consultation before proceeding.") }}');
            // Focus on chief complaint field but don't clear any data
            document.getElementById('anamnesis_chief_complaint').focus();
            return; // Stay on current step without clearing data
        }
        // Compile anamnesis data
        compileAnamnesis();
    }
    
    // Hide current step
    document.getElementById('step' + currentStep).classList.remove('active');
    document.getElementById('step' + currentStep + '-indicator').classList.remove('active');
    document.getElementById('step' + currentStep + '-indicator').classList.add('completed');
    
    // Show next step
    currentStep = step;
    document.getElementById('step' + currentStep).classList.add('active');
    document.getElementById('step' + currentStep + '-indicator').classList.add('active');
}

function prevStep(step) {
    // Hide current step
    document.getElementById('step' + currentStep).classList.remove('active');
    document.getElementById('step' + currentStep + '-indicator').classList.remove('active');
    
    // Show previous step
    currentStep = step;
    document.getElementById('step' + currentStep).classList.add('active');
    document.getElementById('step' + currentStep + '-indicator').classList.add('active');
    document.getElementById('step' + currentStep + '-indicator').classList.remove('completed');
}

// Form validation before submit
document.getElementById('newPatientForm').addEventListener('submit', function(e) {
    // If we're skipping portal, don't validate
    if (window.isSkippingPortal) {
        window.isSkippingPortal = false; // Reset flag
        return true; // Allow submission
    }
    
    // Compile anamnesis one more time before submitting
    const compiledAnamnesis = compileAnamnesis();
    
    // Check required patient data fields
    const name = document.getElementById('name').value.trim();
    const dob = document.getElementById('date_of_birth').value;
    
    // Debug: Log field values on submit
    console.log('Submit Validation Debug:');
    console.log('Name:', name, '(length:', name.length, ')');
    console.log('DOB:', dob, '(length:', dob.length, ')');
    
    let missingFields = [];
    if (!name) missingFields.push('{{ _("Full Name") }}');
    if (!dob) missingFields.push('{{ _("Date of Birth") }}');
    
    if (missingFields.length > 0) {
        e.preventDefault();
        alert('{{ _("Please fill in all required patient data fields: ") }}' + missingFields.join(', '));
        // Go to step 1 but preserve all form data
        prevStep(1);
        // Focus on the first missing field
        if (!name) document.getElementById('name').focus();
        else if (!dob) document.getElementById('date_of_birth').focus();
        return false;
    }
    
    // Check if at least the chief complaint is filled
    const chiefComplaint = document.getElementById('anamnesis_chief_complaint').value.trim();
    if (!chiefComplaint) {
        e.preventDefault();
        alert('{{ _("Main reason for consultation is required before creating a patient record.") }}');
        prevStep(2); // Go to clinical history step but preserve all data
        document.getElementById('anamnesis_chief_complaint').focus();
        return false;
    }
});

// Add tab completion indicators
document.addEventListener('DOMContentLoaded', function() {
    // Add change listeners to mark tabs as completed
    const tabs = [
        'personal-data', 'chief-complaint', 'medical-history', 
        'family-history', 'lifestyle', 'current-pain', 'functional-exam'
    ];
    
    tabs.forEach(function(tabId) {
        const tabPane = document.getElementById(tabId);
        const inputs = tabPane.querySelectorAll('input, textarea, select');
        
        inputs.forEach(function(input) {
            input.addEventListener('change', function() {
                updateTabCompletion(tabId);
            });
        });
    });
});

function updateTabCompletion(tabId) {
    const tabPane = document.getElementById(tabId);
    const inputs = tabPane.querySelectorAll('input, textarea, select');
    const tab = document.getElementById(tabId + '-tab');
    
    let hasContent = false;
    inputs.forEach(function(input) {
        if (input.value.trim() !== '') {
            hasContent = true;
        }
    });
    
    if (hasContent) {
        tab.classList.add('text-success');
        if (!tab.querySelector('.bi-check-circle')) {
            const icon = document.createElement('i');
            icon.className = 'bi bi-check-circle ms-1';
            tab.appendChild(icon);
        }
    } else {
        tab.classList.remove('text-success');
        const checkIcon = tab.querySelector('.bi-check-circle');
        if (checkIcon) {
            checkIcon.remove();
        }
    }
}

// Basic form functionality
function addSurgery() {
    const container = document.getElementById('surgeries-container');
    if (!container) return;
    
    const newSurgery = document.createElement('div');
    newSurgery.className = 'surgery-entry row mb-2';
    newSurgery.innerHTML = 
        '<div class="col-md-6">' +
            '<input type="text" class="form-control" name="surgery_description[]" placeholder="{{ _("Type of surgery") }}">' +
        '</div>' +
        '<div class="col-md-4">' +
            '<input type="date" class="form-control" name="surgery_date[]">' +
        '</div>' +
        '<div class="col-md-2">' +
            '<button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSurgery(this)">' +
                '<i class="bi bi-trash"></i>' +
            '</button>' +
        '</div>';
    container.appendChild(newSurgery);
}

function removeSurgery(button) {
    button.closest('.surgery-entry').remove();
}

function fillDiagnosisFromQuick() {
    const quickSelect = document.getElementById('quick_diagnosis');
    const diagnosisField = document.getElementById('diagnosis');
    
    // Diagnosis field not available in current form structure
    if (false && quickSelect.value && diagnosisField) {
        const diagnosisMap = {
            'tendinopathy': 'Tendinopat√≠a',
            'grade2_sprain': 'Esguince Grado II',
            'grade1_sprain': 'Esguince Grado I',
            'muscle_strain': 'Distensi√≥n Muscular',
            'joint_stiffness': 'Rigidez Articular',
            'chronic_pain': 'Dolor Cr√≥nico',
            'lower_back_pain': 'Lumbalgia',
            'cervical_pain': 'Cervicalgia',
            'herniated_disc': 'Hernia Discal',
            'sciatica': 'Ci√°tica',
            'whiplash': 'Latigazo Cervical',
            'runners_knee': 'Rodilla del Corredor',
            'tennis_elbow': 'Codo de Tenista',
            'shoulder_impingement': 'S√≠ndrome de Pinzamiento del Hombro',
            'acl_injury': 'Lesi√≥n del LCA',
            'rotator_cuff': 'Lesi√≥n del Manguito Rotador',
            'post_surgery_knee': 'Rehabilitaci√≥n Post-Cirug√≠a de Rodilla',
            'post_surgery_shoulder': 'Rehabilitaci√≥n Post-Cirug√≠a de Hombro',
            'post_surgery_hip': 'Rehabilitaci√≥n Post-Cirug√≠a de Cadera'
        };
        
        diagnosisField.value = diagnosisMap[quickSelect.value] || quickSelect.value;
    }
}

// Portal access validation and management
function validatePortalAccess() {
    const email = document.getElementById('patient_email').value.trim();
    const password = document.getElementById('patient_password').value.trim();
    
    // If email is provided but no password, show error
    if (email && !password) {
        alert('Si proporcionas un email para el portal, tambi√©n debes proporcionar una contrase√±a.');
        document.getElementById('patient_password').focus();
        return false;
    }
    
    // If password is provided but no email, show error
    if (password && !email) {
        alert('Si proporcionas una contrase√±a, tambi√©n debes proporcionar un email para el portal.');
        document.getElementById('patient_email').focus();
        return false;
    }
    
    // Everything is fine - either both provided or both empty
    return true;
}

function skipPortalAccess() {
    // Clear portal fields
    document.getElementById('patient_email').value = '';
    document.getElementById('patient_password').value = '';
    
    // Compile anamnesis before submitting
    compileAnamnesis();
    
    // Set flag to bypass validation
    window.isSkippingPortal = true;
    
    // Submit the form
    document.getElementById('newPatientForm').submit();
}

// New improved anamnesis functionality
function updateProgress() {
    const progressBar = document.getElementById('anamnesis-progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const summary = document.getElementById('anamnesis-summary');
    const summaryContent = document.getElementById('summary-content');
    
    // Calculate completion percentage
    const essentialFields = [
        'anamnesis_chief_complaint',
        'anamnesis_pain_scale'
    ];
    
    const optionalFields = [
        'anamnesis_onset_date',
        'anamnesis_mechanism',
        'anamnesis_gender',
        'anamnesis_occupation',
        'anamnesis_physical_activity',
        'anamnesis_medications',
        'anamnesis_pain_location'
    ];
    
    let completedEssential = 0;
    let completedOptional = 0;
    
    // Check essential fields
    essentialFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value.trim() !== '') {
            completedEssential++;
        }
    });
    
    // Check optional fields
    optionalFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && field.value.trim() !== '') {
            completedOptional++;
        }
    });
    
    // Check checkboxes
    const checkboxGroups = ['history_conditions', 'allergies', 'pain_characteristics', 'functional_limitations'];
    checkboxGroups.forEach(groupName => {
        const checkboxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
        if (checkboxes.length > 0) {
            completedOptional++;
        }
    });
    
    // Calculate percentage (essential fields count more)
    const essentialWeight = 60; // 60% for essential fields
    const optionalWeight = 40;  // 40% for optional fields
    
    const essentialPercent = (completedEssential / essentialFields.length) * essentialWeight;
    const optionalPercent = (completedOptional / (optionalFields.length + checkboxGroups.length)) * optionalWeight;
    
    const totalPercent = Math.round(essentialPercent + optionalPercent);
    
    // Update progress bar
    progressBar.style.width = totalPercent + '%';
    progressPercentage.textContent = totalPercent + '%';
    
    // Update progress bar color based on completion
    if (totalPercent < 30) {
        progressBar.className = 'progress-bar bg-danger';
    } else if (totalPercent < 70) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }
    
    // Show summary if significant progress
    if (totalPercent > 20) {
        summary.style.display = 'block';
        updateSummary();
    } else {
        summary.style.display = 'none';
    }
    
    // Compile anamnesis
    compileAnamnesis();
}

function updateSummary() {
    const summaryContent = document.getElementById('summary-content');
    let summaryText = '';
    
    const chiefComplaint = document.getElementById('anamnesis_chief_complaint').value.trim();
    const painScale = document.getElementById('anamnesis_pain_scale').value;
    const onsetDate = document.getElementById('anamnesis_onset_date').value;
    const mechanism = document.getElementById('anamnesis_mechanism').value.trim();
    
    if (chiefComplaint) {
        summaryText += `<strong>{{ _('Chief Complaint') }}:</strong> ${chiefComplaint}<br>`;
    }
    
    if (painScale > 0) {
        summaryText += `<strong>{{ _('Pain Level') }}:</strong> ${painScale}/10<br>`;
    }
    
    if (onsetDate) {
        summaryText += `<strong>{{ _('Onset') }}:</strong> ${onsetDate}<br>`;
    }
    
    if (mechanism) {
        summaryText += `<strong>{{ _('Mechanism') }}:</strong> ${mechanism}<br>`;
    }
    
    summaryContent.innerHTML = summaryText || '{{ _("Continue filling out the form to see a summary...") }}';
}

function updatePainDisplay(value) {
    const display = document.getElementById('pain-display');
    const description = document.getElementById('pain-description');
    
    display.textContent = value;
    
    // Update color and description based on pain level
    if (value == 0) {
        display.className = 'badge bg-success fs-6';
        description.textContent = '{{ _("No pain") }}';
    } else if (value <= 3) {
        display.className = 'badge bg-info fs-6';
        description.textContent = '{{ _("Mild pain") }}';
    } else if (value <= 6) {
        display.className = 'badge bg-warning fs-6';
        description.textContent = '{{ _("Moderate pain") }}';
    } else {
        display.className = 'badge bg-danger fs-6';
        description.textContent = '{{ _("Severe pain") }}';
    }
}

// Toggle functions for exclusive checkboxes
function toggleNoConditions(checkbox) {
    if (checkbox.checked) {
        const otherCheckboxes = document.querySelectorAll('input[name="history_conditions"]:not(#history_none)');
        otherCheckboxes.forEach(cb => cb.checked = false);
    }
    updateProgress();
}

function toggleNoAllergies(checkbox) {
    if (checkbox.checked) {
        const otherCheckboxes = document.querySelectorAll('input[name="allergies"]:not(#allergy_none)');
        otherCheckboxes.forEach(cb => cb.checked = false);
    }
    updateProgress();
}

function toggleNoLimitations(checkbox) {
    if (checkbox.checked) {
        const otherCheckboxes = document.querySelectorAll('input[name="functional_limitations"]:not(#limit_none)');
        otherCheckboxes.forEach(cb => cb.checked = false);
    }
    updateProgress();
}

// Initialize progress tracking
document.addEventListener('DOMContentLoaded', function() {
    updateProgress();
    updatePainDisplay(0);
    
    // Add event listeners to all form fields
    const allInputs = document.querySelectorAll('#anamnesis-form input, #anamnesis-form select, #anamnesis-form textarea');
    allInputs.forEach(input => {
        input.addEventListener('change', updateProgress);
        input.addEventListener('input', updateProgress);
    });
});

</script>

<style>
/* Improved Anamnesis Styles */
.bg-gradient-primary {
    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
}

.section-title {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.required-badge {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    margin-left: auto;
    font-weight: 500;
}

.anamnesis-progress {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.progress {
    border-radius: 20px;
    overflow: hidden;
}

.progress-bar {
    transition: width 0.3s ease, background-color 0.3s ease;
}

.anamnesis-accordion .accordion-button {
    padding: 1rem 1.25rem;
    background: #f8f9fa;
    border: none;
    border-radius: 8px !important;
    margin-bottom: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.anamnesis-accordion .accordion-button:not(.collapsed) {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.anamnesis-accordion .accordion-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.anamnesis-accordion .accordion-item {
    border: none;
    margin-bottom: 1rem;
}

.anamnesis-accordion .accordion-collapse {
    border-radius: 8px;
    overflow: hidden;
}

.anamnesis-accordion .accordion-body {
    background: white;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.condition-grid, .allergy-grid, .pain-type-grid, .limitations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.form-check {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.form-check:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.form-check-input:checked + .form-check-label {
    font-weight: 600;
    color: #0d6efd;
}

.pain-scale-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
}

.form-range {
    margin: 0.5rem 0;
}

.anamnesis-summary {
    border-left: 4px solid #28a745;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.essential-info {
    background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid #feb2b2;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .condition-grid, .allergy-grid, .pain-type-grid, .limitations-grid {
        grid-template-columns: 1fr;
    }
    
    .anamnesis-accordion .accordion-button {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
    
    .essential-info {
        padding: 1rem;
    }
}

/* Enhanced form styling */
.form-control:focus, .form-select:focus {
    border-color: #4285f4;
    box-shadow: 0 0 0 0.2rem rgba(66, 133, 244, 0.25);
}

.btn {
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.card {
    border-radius: 16px;
    overflow: hidden;
}

.badge {
    font-weight: 500;
}
</style>

{% endblock %}
