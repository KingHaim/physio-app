{% extends "base.html" %}

{% block title %}{{ patient.name }} - {{ _('Patient Details') }}{% endblock %}

{% block content %}
<div class="container py-4">
    {% if not today is defined %}
        <div class="alert alert-warning">
            <strong>{{ _('Warning:') }}</strong> {{ _("The 'today' variable is not defined. Some features may not work correctly.") }}
        </div>
    {% endif %}

    <!-- Add this after the flash messages section -->
    {% if session.get('auto_completed_treatments') %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        {{ session.get('auto_completed_treatments') }} {{ _('past treatment(s) were automatically marked as completed.') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Close') }}"></button>
    </div>
    {% endif %}

    <!-- Patient Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-3">{{ patient.name }}</h1>
            <div class="patient-info mb-3">
                <p class="mb-1"><strong>{{ _('Date of Birth:') }}</strong> {{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else _('Not provided') }}</p>
                <p class="mb-1"><strong>{{ _('Contact:') }}</strong> {{ patient.contact }}</p>
                <p class="mb-1"><strong>{{ _('Status:') }}</strong> <span class="badge bg-{{ 'primary' if patient.status == 'Active' else 'secondary' }}">{{ patient.status }}</span></p>
            </div>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="d-flex flex-column flex-md-row gap-2 justify-content-md-end">
                <a href="{{ url_for('main.edit_patient', id=patient.id) }}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> {{ _('Edit Patient') }}
                </a>
                <a href="{{ url_for('main.new_treatment_page', patient_id=patient.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> {{ _('Add Treatment') }}
                </a>
                <a href="{{ url_for('main.new_recurring_appointment', patient_id=patient.id) }}" class="btn btn-secondary">
                    <i class="bi bi-calendar-plus"></i> {{ _('Add Recurring') }}
                </a>
                <button id="generateReportBtn" class="btn btn-info">
                    <i class="bi bi-file-earmark-text"></i> {{ _('Generate AI Report') }}
                </button>
                <button id="generateExerciseBtn" class="btn btn-warning">
                    <i class="bi bi-clipboard-heart"></i> {{ _('Generate Exercise Homework') }}
                </button>
                <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-file-text"></i> {{ _('View Latest Report') }}
                </a>
            </div>
        </div>
    </div>

    <!-- Recurring Appointments Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            {% if patient.recurring_appointments %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-calendar-repeat"></i> {{ _('Recurring Appointments') }}</h5>
                    <a href="{{ url_for('main.new_recurring_appointment', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> {{ _('Add Rule') }}
                    </a>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for rule in patient.recurring_appointments %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">
                                        {{ rule.treatment_type }} 
                                        - {{ rule.recurrence_type|replace('-', ' ')|title }}
                                    </h6>
                                    <small>
                                        <span class="badge bg-{{ 'success' if rule.is_active else 'secondary' }}">
                                            {{ 'Active' if rule.is_active else 'Inactive' }}
                                        </span>
                                    </small>
                                </div>
                                <p class="mb-1">
                                    {{ _('Starts:') }} {{ rule.start_date.strftime('%Y-%m-%d') }} 
                                    {% if rule.end_date %} | {{ _('Ends:') }} {{ rule.end_date.strftime('%Y-%m-%d') }} {% endif %}
                                    | {{ _('Time:') }} {{ rule.time_of_day.strftime('%H:%M') }}
                                </p>
                                <small class="text-muted">{{ _('Location:') }} {{ rule.location or 'N/A' }} | {{ _('Fee:') }} {{ ('€' + "{:.2f}".format(rule.fee_charged)) if rule.fee_charged else 'N/A' }}</small>
                                <div class="mt-2">
                                    <a href="{{ url_for('main.edit_recurring_appointment', id=rule.id) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i> {{ _('Edit') }}</a>
                                    <form action="{{ url_for('main.delete_recurring_appointment', id=rule.id) }}" method="POST" style="display: inline-block;" onsubmit="return confirm('{{ _('Are you sure you want to delete this recurring rule?') }}');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> {{ _('Delete') }}</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Diagnosis and Treatment Plan -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clipboard-pulse"></i> {{ _('Diagnosis') }}</h5>
                </div>
                <div class="card-body">
                    <p>{{ patient.diagnosis }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-journal-medical"></i> {{ _('Treatment Plan') }}</h5>
                </div>
                <div class="card-body">
                    <p>{{ patient.treatment_plan }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Treatment History Section -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> {{ _('Past Treatments') }}</h5>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newTreatmentModal">
                        <i class="bi bi-plus-circle"></i> {{ _('Add Past Treatment') }}
                    </button>
                </div>
                <div class="card-body">
                    <!-- Bulk Action Controls - Moved above table -->
                    <div id="bulkActions" class="mb-3 p-3 bg-light rounded" style="display: none;"> 
                        <h6>{{ _('Bulk Actions for Selected') }} (<span id="selectedCount">0</span>):</h6>
                        <div class="row gx-2 gy-2">
                            <div class="col-auto">
                                <div class="btn-group btn-group-sm" role="group" aria-label="{{ _('Set Location') }}">
                                    <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="location" data-value="CostaSpine Clinic">{{ _('Set Loc: CostaSpine') }}</button>
                                    <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="location" data-value="Home Visit">{{ _('Set Loc: Home Visit') }}</button>
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="btn-group btn-group-sm" role="group" aria-label="{{ _('Set Payment Method') }}">
                                    <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="payment_method" data-value="Cash">{{ _('Set Pmt: Cash') }}</button>
                                    <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="payment_method" data-value="Card">{{ _('Set Pmt: Card') }}</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug information to check patient treatments are loaded -->
                    <p class="text-muted small">{{ _('Total treatments for this patient:') }} {{ treatments|length }}</p>
                    <!-- Note about past treatments -->
                    <p class="text-muted small">{{ _('Showing treatments completed on or before today') }} ({{ today.strftime('%Y-%m-%d') }})</p>
                    
                    <!-- Simple, direct treatment listing without modals -->
                    {% if treatments|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover" id="treatmentsTable">
                                <thead>
                                    <tr>
                                        <th><input class="form-check-input" type="checkbox" id="selectAllCheckbox"></th>
                                        <th>{{ _('Date') }}</th>
                                        <th>{{ _('Type') }}</th>
                                        <th>{{ _('Status') }}</th>
                                        <th>{{ _('Pain Level') }}</th>
                                        <th>{{ _('Fee (€)') }}</th>
                                        <th>{{ _('Payment') }}</th>
                                        <th>{{ _('Actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set has_past_treatments = false %}
                                    {% for treatment in treatments|sort(attribute='created_at', reverse=true) %}
                                        {% if treatment.created_at and treatment.created_at <= today %}
                                        {% set has_past_treatments = true %}
                                        <tr id="treatment-row-{{ treatment.id }}">
                                            <td><input class="form-check-input treatment-checkbox" type="checkbox" value="{{ treatment.id }}"></td>
                                            <td>{{ treatment.created_at.strftime('%Y-%m-%d %H:%M') if treatment.created_at else 'N/A' }}</td>
                                            <td>{{ treatment.treatment_type or 'N/A' }}</td>
                                            <td>
                                                <span class="badge {% if treatment.status == 'Completed' %}bg-primary{% elif treatment.status == 'Scheduled' %}bg-info text-dark{% elif treatment.status == 'Cancelled' %}bg-danger{% else %}bg-secondary{% endif %} status-badge" id="status-{{ treatment.id }}">
                                                    {{ treatment.status or 'N/A' }}
                                                </span>
                                            </td>
                                            <td>{{ treatment.pain_level if treatment.pain_level is not none else 'N/A' }}/10</td>
                                            <td class="fee-column">
                                                <div class="input-group input-group-sm">
                                                    <input type="number" class="form-control form-control-sm fee-input" id="fee-input-{{ treatment.id }}" value="{{ treatment.fee_charged if treatment.fee_charged is not none else '' }}" placeholder="Fee" step="0.01" style="width: 70px;">
                                                    <button class="btn btn-outline-secondary btn-sm set-fee-btn" data-treatment-id="{{ treatment.id }}" type="button" title="Set Fee">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                </div>
                                                <small id="fee-status-{{ treatment.id }}" class="text-muted d-block mt-1"></small>
                                            </td>
                                            <td class="payment-column">
                                                <span id="payment-status-{{ treatment.id }}" class="d-block mb-1">
                                                    {% if treatment.payment_method %}
                                                        Paid - {{ treatment.payment_method }}
                                                    {% else %}
                                                        Unpaid
                                                    {% endif %}
                                                </span>
                                                {% if not treatment.payment_method %}
                                                <div class="btn-group btn-group-sm payment-buttons" id="payment-buttons-{{ treatment.id }}">
                                                    <button class="btn btn-outline-success btn-sm set-payment-btn" data-treatment-id="{{ treatment.id }}" data-method="Cash">Cash</button>
                                                    <button class="btn btn-outline-primary btn-sm set-payment-btn" data-treatment-id="{{ treatment.id }}" data-method="Card">Card</button>
                                                </div>
                                                {% endif %}
                                                <small id="payment-update-status-{{ treatment.id }}" class="text-muted d-block mt-1"></small>
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    <a href="{{ url_for('main.view_treatment', id=treatment.id) }}" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-eye"></i> View
                                                    </a>
                                                    <a href="{{ url_for('main.edit_treatment', id=treatment.id) }}" class="btn btn-sm btn-secondary">
                                                        <i class="bi bi-pencil"></i> Edit
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No treatments found for this patient.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Section -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> Reports</h5>
                    <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-eye"></i> View Reports
                    </a>
                </div>
                <div class="card-body">
                    {% if patient.reports %}
                        <div class="list-group">
                            {% for report in patient.reports|sort(attribute='generated_date', reverse=true) %}
                                <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}?report_id={{ report.id }}" 
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ report.report_type }}</h6>
                                        <small>{{ report.generated_date.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <small>Click to view this report</small>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No reports generated yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Treatment Detail Modal -->
<div class="modal fade" id="treatmentDetailModal" tabindex="-1" aria-labelledby="treatmentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="treatmentDetailModalLabel">Treatment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Date:</strong> <span id="treatmentDate"></span></p>
                        <p><strong>Description:</strong> <span id="treatmentDescription"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Pain Level:</strong> <span id="treatmentPainLevel"></span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Progress Notes</h6>
                        <div class="p-3 bg-light rounded">
                            <p id="treatmentNotes" class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="editTreatmentBtn" href="#" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Edit Treatment
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- New Treatment Modal -->
<div class="modal fade" id="newTreatmentModal" tabindex="-1" aria-labelledby="newTreatmentModalLabel" aria-hidden="true" data-is-first-visit="{{ is_first_visit|tojson|safe }}">
    <!-- Modal content here -->
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTreatmentModalLabel">Add Treatment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="treatmentForm">
                    <div class="mb-3">
                        <label for="treatment_type" class="form-label">Description</label>
                        <input type="text" class="form-control" id="treatment_type" name="treatment_type">
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="hidden" id="date" name="date">
                    </div>
                    <div class="mb-3">
                        <label for="pain_level" class="form-label">Pain Level (0-10)</label>
                        <input type="number" class="form-control" id="pain_level" name="pain_level" min="0" max="10">
                        <small class="text-muted">Optional: Leave blank if not applicable</small>
                    </div>
                    <div class="mb-3">
                        <label for="movement_restriction" class="form-label">Movement Restriction</label>
                        <textarea class="form-control" id="movement_restriction" name="movement_restriction" rows="3"></textarea>
                    </div>
                    
                    <!-- Body Chart Section -->
                    <div class="mb-3">
                        <label class="form-label">Body Chart</label>
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Add Trigger Points</h6>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-danger active" data-point-type="active">Active</button>
                                        <button type="button" class="btn btn-outline-warning" data-point-type="latent">Latent</button>
                                        <button type="button" class="btn btn-outline-info" data-point-type="satellite">Satellite</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="body-map-container">
                                    <img src="{{ url_for('static', filename='images/bodychart.svg') }}" class="body-map" id="bodyMapImageAdd" alt="Body chart">
                                    <svg class="body-map-overlay" id="bodyMapOverlayAdd" viewBox="0 0 500 800" xmlns="http://www.w3.org/2000/svg">
                                        <g id="addTriggerPoints"></g>
                                    </svg>
                                </div>
                                <div class="text-muted small mt-2">Click on the body map to add trigger points</div>
                                
                                <!-- Trigger Points Table -->
                                <div class="mt-3">
                                    <h6>Trigger Points</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Type</th>
                                                    <th>Muscle</th>
                                                    <th>Intensity</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="addPointsTableBody">
                                                <!-- Trigger points will be added here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden input to store trigger points data -->
                    <input type="hidden" id="addTriggerPointsData" name="trigger_points_data" value="[]">
                    
                    <div class="mb-3">
                        <label for="assessment" class="form-label">Assessment</label>
                        <textarea class="form-control" id="assessment" name="assessment" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Progress Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="" disabled selected>Select status</option>
                            <option value="Scheduled">Scheduled</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="treatment_type" class="form-label">Treatment Type</label>
                        <input type="text" class="form-control" id="treatment_type" name="treatment_type" required>
                    </div>
                    <div class="mb-3">
                        <label for="provider" class="form-label">Provider</label>
                        <input type="text" class="form-control" id="provider" name="provider">
                    </div>

                    {# ADDED Hidden fields for pre-filled data #}
                    <input type="hidden" id="location" name="location">
                    <input type="hidden" id="visit_type" name="visit_type">
                    <input type="hidden" id="fee_charged" name="fee_charged">
                    {# Payment method is generally set after, so no hidden field needed here #}
                    
                    <!-- Calendly Integration Section -->
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Calendly Integration</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <strong>Note:</strong> Your appointment can be booked through Calendly scheduling.
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="syncWithCalendly" name="sync_with_calendly" value="true">
                                    <label class="form-check-label" for="syncWithCalendly">
                                        <strong>Enable Calendly scheduling for this appointment</strong>
                                    </label>
                                </div>
                                
                                <!-- Calendly options that appear when checkbox is checked -->
                                <div id="calendlyOptions" class="mt-3" style="display: none;">
                                    <div class="mb-3">
                                        <label for="calendlyEventType" class="form-label">Event Type</label>
                                        <select class="form-select" id="calendlyEventType" name="calendly_event_type">
                                            <option value="" selected>Select Calendly event type</option>
                                            <option value="initial-consultation">Initial Consultation (30 min)</option>
                                            <option value="follow-up">Follow-up Session (45 min)</option>
                                            <option value="therapy-session">Therapy Session (60 min)</option>
                                        </select>
                                        <small class="text-muted">Select the appropriate event type from your Calendly account</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="calendlyLocation" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="calendlyLocation" name="calendly_location" placeholder="e.g. Office, Video Call">
                                        <small class="text-muted">Where will this appointment take place?</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="calendlyAppointmentDate" class="form-label">Preferred Date (Optional)</label>
                                        <input type="date" class="form-control" id="calendlyAppointmentDate" name="appointment_date">
                                        <small class="text-muted">If you have a preferred date in mind, otherwise Calendly will show available slots</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Add Treatment</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- New Exercise Prescription Modal -->
<div class="modal fade" id="exercisePrescriptionModal" tabindex="-1" aria-labelledby="exercisePrescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exercisePrescriptionModalLabel">AI Generated Exercise Prescription</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="exercisePrescriptionBody">
        {# Prescription content will be loaded here #}
        <p>Generating exercise prescription...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        {# Optional: Add a print button later #}
        {# <button type="button" class="btn btn-primary" onclick="window.print();">Print</button> #}
      </div>
    </div>
  </div>
</div>

<style>
    .upcoming-session {
        background-color: #f8f9fa;
        transition: background-color 0.2s;
    }
    
    .upcoming-session:hover {
        background-color: #e9ecef;
    }
    
    .treatment-entry {
        transition: background-color 0.2s;
        background-color: white;
    }
    
    .treatment-entry:hover {
        background-color: #f0f8ff;
    }
    
    .badge.bg-scheduled {
        background-color: #3498db;
    }
    
    .badge.bg-completed {
        background-color: #28a745;
    }
    
    .badge.bg-cancelled {
        background-color: #dc3545;
    }
    
    .badge.bg-in-progress {
        background-color: #fd7e14;
    }

    #treatmentsList {
        max-height: 600px;
        overflow-y: auto;
    }
    
    /* Body Chart Styles */
    .body-map-container {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        position: relative;
        cursor: crosshair;
    }
    
    .body-map {
        width: 100%;
        height: auto;
        display: block;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
    }
    
    .body-map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10; /* Ensure overlay is above the image */
    }
    
    .trigger-point {
        cursor: pointer;
        transition: r 0.2s ease;
        pointer-events: all;
    }
</style>

<script>
    // Define patient ID for use in JavaScript
    const patientId = parseInt("{{ patient.id }}");
    
    // Add treatment form submission handler
    document.addEventListener('DOMContentLoaded', function() {
        // Trigger point management for the add treatment form
        let addTriggerPoints = [];
        let addPointIdCounter = 1;
        let currentPointType = 'active';
        
        // Point type selection
        const pointTypeButtons = document.querySelectorAll('[data-point-type]');
        pointTypeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                pointTypeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPointType = this.dataset.pointType;
            });
        });
        
        // Get color for point type
        function getPointColor(type) {
            switch(type) {
                case 'active': return '#dc3545';
                case 'latent': return '#ffc107';
                case 'satellite': return '#17a2b8';
                default: return '#dc3545';
            }
        }
        
        // Create table row for a point
        function createTableRow(point) {
            const row = document.createElement('tr');
            row.dataset.pointId = point.id;
            
            row.innerHTML = `
                <td>
                    <span class="badge bg-${point.type === 'active' ? 'danger' : (point.type === 'latent' ? 'warning' : 'info')}">
                        ${point.type}
                    </span>
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateAddPointData('${point.id}', 'muscle', this.value)">
                        <option value="">Select muscle</option>
                        <option value="Trapezius" ${point.muscle === 'Trapezius' ? 'selected' : ''}>Trapezius</option>
                        <option value="Levator Scapulae" ${point.muscle === 'Levator Scapulae' ? 'selected' : ''}>Levator Scapulae</option>
                        <option value="Rhomboids" ${point.muscle === 'Rhomboids' ? 'selected' : ''}>Rhomboids</option>
                        <option value="Deltoid" ${point.muscle === 'Deltoid' ? 'selected' : ''}>Deltoid</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" min="1" max="10" 
                           onchange="updateAddPointData('${point.id}', 'intensity', this.value)" value="${point.intensity || ''}"
                           placeholder="1-10">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeAddPoint('${point.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }
        
        // Add point to both SVG and table
        function addNewPoint(x, y, type = currentPointType, existingData = null) {
            const pointId = existingData ? existingData.id : `point-${addPointIdCounter++}`;
            const pointData = existingData || {
                id: pointId,
                x: Math.round(x),
                y: Math.round(y),
                type: type,
                intensity: '',
                muscle: '',
                symptoms: '',
                referral: ''
            };
            
            // Check if this point already exists to prevent duplicates
            if (!existingData && addTriggerPoints.some(p => p.id === pointId)) {
                console.warn('Point already exists:', pointId);
                return;
            }
            
            // Create SVG point
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute("cx", pointData.x);
            circle.setAttribute("cy", pointData.y);
            
            // Make lower points larger and add stroke
            const isLowerPoint = pointData.y > 400;
            circle.setAttribute("r", isLowerPoint ? "7" : "4");
            
            circle.setAttribute("fill", getPointColor(pointData.type));
            circle.setAttribute("class", "trigger-point");
            circle.setAttribute("data-point-id", pointId);
            
            // Add a stroke to lower points to make them more visible
            if (isLowerPoint) {
                circle.setAttribute("stroke", "black");
                circle.setAttribute("stroke-width", "1");
            }
            
            circle.addEventListener('mouseover', () => circle.setAttribute("r", isLowerPoint ? "9" : "6"));
            circle.addEventListener('mouseout', () => circle.setAttribute("r", isLowerPoint ? "7" : "4"));
            
            const pointsGroup = document.getElementById('addTriggerPoints');
            
            // To ensure correct z-order, lower points should appear last in the DOM
            // First, get all existing points
            const allExistingCircles = pointsGroup.querySelectorAll('circle');
            
            // If this is a lower point, append it to ensure it's rendered on top
            if (isLowerPoint) {
                pointsGroup.appendChild(circle);
            } else {
                // If it's an upper point, insert it at the beginning
                if (allExistingCircles.length > 0) {
                    pointsGroup.insertBefore(circle, allExistingCircles[0]);
                } else {
                    pointsGroup.appendChild(circle);
                }
            }
            
            const tbody = document.getElementById('addPointsTableBody');
            tbody.appendChild(createTableRow(pointData));
            
            if (!existingData) {
                addTriggerPoints.push(pointData);
            } else if (!addTriggerPoints.find(p => p.id === pointData.id)) {
                addTriggerPoints.push(pointData);
            }
            
            updateAddFormData();
        }
        
        window.updateAddPointData = function(pointId, field, value) {
            const point = addTriggerPoints.find(p => p.id === pointId);
            if (point) {
                point[field] = value;
                updateAddFormData();
            }
        };
        
        window.removeAddPoint = function(pointId) {
            const index = addTriggerPoints.findIndex(p => p.id === pointId);
            if (index > -1) {
                addTriggerPoints.splice(index, 1);
                document.querySelector(`#addTriggerPoints circle[data-point-id="${pointId}"]`)?.remove();
                document.querySelector(`#addPointsTableBody tr[data-point-id="${pointId}"]`)?.remove();
                updateAddFormData();
            }
        };
        
        function updateAddFormData() {
            const dataInput = document.getElementById('addTriggerPointsData');
            dataInput.value = JSON.stringify(addTriggerPoints);
        }
        
        // Setup SVG click handler
        const bodyMapOverlay = document.getElementById('bodyMapOverlayAdd');
        
        if (bodyMapOverlay) {
            bodyMapOverlay.style.pointerEvents = 'all'; // Make overlay clickable
            
            bodyMapOverlay.addEventListener('click', function(evt) {
                evt.preventDefault();
                evt.stopPropagation(); // Prevent event from bubbling
                
                // Get click coordinates in SVG space
                const pt = bodyMapOverlay.createSVGPoint();
                pt.x = evt.clientX;
                pt.y = evt.clientY;
                
                // Transform to SVG coordinate system
                const svgP = pt.matrixTransform(bodyMapOverlay.getScreenCTM().inverse());
                
                console.log(`SVG click at (${svgP.x}, ${svgP.y})`);
                
                // Add the point
                addNewPoint(svgP.x, svgP.y);
            });
        }
        
        // Treatment form submission handler
        const treatmentForm = document.getElementById('treatmentForm');
        if (treatmentForm) {
            treatmentForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Create FormData object
                const formData = new FormData(treatmentForm);
                
                // The description field maps to treatment_type if treatment_type is not already set
                if (!formData.get('treatment_type') || formData.get('treatment_type').trim() === '') {
                    // No need to map now since we're using treatment_type directly
                }
                
                // Progress notes maps to notes if notes is not already set
                if (!formData.get('notes') || formData.get('notes').trim() === '') {
                    // No need to map now since we're using notes directly
                }
                
                // Make sure date is included
                if (!formData.get('date')) {
                    formData.set('date', new Date().toISOString().slice(0, 16));
                }
                
                // Set evaluation_data from the trigger points data
                formData.set('evaluation_data', document.getElementById('addTriggerPointsData').value);
                
                // Handle Calendly integration
                const syncWithCalendly = document.getElementById('syncWithCalendly');
                if (syncWithCalendly && syncWithCalendly.checked) {
                    // Get Calendly details
                    const eventType = document.getElementById('calendlyEventType').value;
                    const location = document.getElementById('calendlyLocation').value;
                    const appointmentDate = document.getElementById('calendlyAppointmentDate').value;
                    
                    // Add specific Calendly fields to the form data
                    formData.set('calendly_integration', 'true');
                    formData.set('calendly_event_type', eventType);
                    formData.set('calendly_location', location);
                    
                    // Set appointment_date if provided (this prevents the next_appointment error)
                    if (appointmentDate) {
                        formData.set('appointment_date', appointmentDate);
                    }
                    
                    // Add a note about Calendly integration
                    let currentNotes = formData.get('notes') || '';
                    const calendlyInfo = `\n\n--- Calendly Integration Enabled ---
Event Type: ${eventType}
Location: ${location}
${appointmentDate ? 'Preferred Date: ' + appointmentDate : 'No specific date preference'}`;
                    
                    formData.set('notes', currentNotes + calendlyInfo);
                }
                
                // Submit form via AJAX
                fetch(`/patient/${patientId}/treatment`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('newTreatmentModal'));
                        modal.hide();
                        
                        // Reload the page to show the new treatment
                        window.location.reload();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.message || 'Error adding treatment');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(`Failed to add treatment: ${error.message}`);
                });
            });
        }
        
        // Set up generate report button
        const generateReportBtn = document.getElementById('generateReportBtn');
        if (generateReportBtn) {
            generateReportBtn.addEventListener('click', function() {
                // Show confirmation dialog
                if (confirm('Generate a comprehensive physiotherapy report based on all treatment history?\n\nThis process may take up to 30 seconds as it uses AI to analyze the treatment data.')) {
                // Show loading state
                const originalText = generateReportBtn.innerHTML;
                    generateReportBtn.innerHTML = '<i class="bi bi-hourglass-split fa-spin"></i> Generating AI Report...';
                generateReportBtn.disabled = true;
                    generateReportBtn.classList.add('position-relative');
                    
                    // Add a spinner overlay
                    const spinnerOverlay = document.createElement('div');
                    spinnerOverlay.classList.add('position-absolute', 'top-0', 'start-0', 'w-100', 'h-100', 'd-flex', 'align-items-center', 'justify-content-center');
                    spinnerOverlay.innerHTML = '<div class="spinner-border spinner-border-sm text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
                    generateReportBtn.appendChild(spinnerOverlay);
                    
                    // Call the API to generate the report
                fetch(`/api/patient/${patientId}/generate-report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                            alert('Report generated successfully! Opening the report now.');
                        
                            // Open the report in a new tab/window
                            window.location.href = `/patient/${patientId}/report?report_id=${data.report_id}`;
                    } else {
                        // Show error message
                        alert('Error generating report: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while generating the report.');
                })
                .finally(() => {
                    // Reset button state
                    generateReportBtn.innerHTML = originalText;
                    generateReportBtn.disabled = false;
                        generateReportBtn.classList.remove('position-relative');
                    });
                }
            });
        }

        // Set up Generate Exercise Homework button
        const generateExerciseBtn = document.getElementById('generateExerciseBtn');
        const exerciseModalElement = document.getElementById('exercisePrescriptionModal');
        const exerciseModal = exerciseModalElement ? new bootstrap.Modal(exerciseModalElement) : null;
        const exerciseModalBody = document.getElementById('exercisePrescriptionBody');

        if (generateExerciseBtn && exerciseModal && exerciseModalBody) {
            generateExerciseBtn.addEventListener('click', function() {
                if (confirm('Generate an AI-based exercise prescription based on the recent treatment history? This may take a few seconds.')) {
                    // Show loading state
                    const originalText = generateExerciseBtn.innerHTML;
                    generateExerciseBtn.innerHTML = '<i class="bi bi-hourglass-split fa-spin"></i> Generating...';
                    generateExerciseBtn.disabled = true;
                    exerciseModalBody.innerHTML = '<p><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating exercise prescription...</p>';
                    exerciseModal.show(); // Show modal with loading indicator

                    // Call the API
                    fetch(`/api/patient/${patientId}/generate-exercise-prescription`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.prescription) {
                             // Use DOMPurify to sanitize if available, otherwise basic rendering
                            if (typeof DOMPurify !== 'undefined') {
                                // Use marked.js if available to render Markdown
                                if (typeof marked !== 'undefined') {
                                     exerciseModalBody.innerHTML = DOMPurify.sanitize(marked.parse(data.prescription));
                                } else {
                                     // Basic rendering, preserving line breaks
                                     const sanitizedHtml = DOMPurify.sanitize(data.prescription.replace(/\n/g, '<br>'));
                                     exerciseModalBody.innerHTML = sanitizedHtml;
                                }
                            } else {
                                // Fallback if DOMPurify or marked not available - less safe
                                exerciseModalBody.innerText = data.prescription; 
                                console.warn('DOMPurify/marked.js not available, rendering as plain text.');
                            }
                        } else {
                            exerciseModalBody.innerHTML = `<div class="alert alert-danger">Error generating prescription: ${data.message || 'Unknown error'}</div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching exercise prescription:', error);
                        exerciseModalBody.innerHTML = '<div class="alert alert-danger">An error occurred while generating the prescription. Please try again.</div>';
                    })
                    .finally(() => {
                        // Reset button state
                        generateExerciseBtn.innerHTML = originalText;
                        generateExerciseBtn.disabled = false;
                    });
                }
            });
        }

        // Add event listener for new treatment modal
        const newTreatmentModal = document.getElementById('newTreatmentModal');
        if (newTreatmentModal) {
            newTreatmentModal.addEventListener('show.bs.modal', function (event) {
                // Read the flag from the modal's data attribute
                const isFirstVisit = event.target.dataset.isFirstVisit === 'true'; // Convert string 'true' to boolean
                console.log("Is first visit?", isFirstVisit);

                // Always set the current date and time when the modal is opened
                const dateField = document.getElementById('date');
                if (dateField) {
                    // Format for datetime-local input: YYYY-MM-DDTHH:MM
                    const now = new Date();
                    // Adjust for local timezone offset
                    const timezoneOffset = now.getTimezoneOffset() * 60000; // offset in milliseconds
                    const localISOTime = (new Date(now - timezoneOffset)).toISOString().slice(0, 16);
                    dateField.value = localISOTime;
                }

                // Pre-fill financial fields based on visit history by setting HIDDEN fields
                const visitTypeHidden = newTreatmentModal.querySelector('#visit_type');
                const feeChargedHidden = newTreatmentModal.querySelector('#fee_charged');
                const locationHidden = newTreatmentModal.querySelector('#location');
                
                // Ensure the hidden fields exist before setting values
                if (visitTypeHidden && feeChargedHidden && locationHidden) {
                    if (isFirstVisit === true) { // Explicit boolean check
                        visitTypeHidden.value = 'Initial';
                        feeChargedHidden.value = '80.00';
                        locationHidden.value = 'CostaSpine Clinic'; // Default location
                        console.log("Setting hidden fields for First Visit: location=CostaSpine Clinic, visit_type=Initial, fee=80.00");
                    } else {
                        visitTypeHidden.value = 'Follow-up';
                        feeChargedHidden.value = '70.00';
                        locationHidden.value = 'CostaSpine Clinic'; // Default location
                        console.log("Setting hidden fields for Follow-up Visit: location=CostaSpine Clinic, visit_type=Follow-up, fee=70.00");
                    }
                } else {
                    console.error("Could not find hidden input fields for location, visit_type, or fee_charged!");
                }
                
                // Reset other VISIBLE fields 
                newTreatmentModal.querySelector('#treatment_type').value = '';
                newTreatmentModal.querySelector('#pain_level').value = '';
                newTreatmentModal.querySelector('#movement_restriction').value = '';
                newTreatmentModal.querySelector('#assessment').value = '';
                newTreatmentModal.querySelector('#notes').value = '';
                newTreatmentModal.querySelector('#status').value = 'Scheduled'; // Default status
                newTreatmentModal.querySelector('#provider').value = ''; 
                // newTreatmentModal.querySelector('#payment_method').value = ''; // No payment method input in modal
                
                // Reset trigger points
                addTriggerPoints = []; // Assuming addTriggerPoints is accessible here
                if (typeof updateAddFormData === 'function') {
                  updateAddFormData(); // Update the hidden input
                }
                const addPointsGroup = document.getElementById('addTriggerPoints');
                if (addPointsGroup) addPointsGroup.innerHTML = '';
                const addPointsTable = document.getElementById('addPointsTableBody');
                if (addPointsTable) addPointsTable.innerHTML = '';
            });
        }
        
        // Handle Calendly sync checkbox toggling
        const syncWithCalendlyCheckbox = document.getElementById('syncWithCalendly');
        if (syncWithCalendlyCheckbox) {
            syncWithCalendlyCheckbox.addEventListener('change', function() {
                const calendlyOptions = document.getElementById('calendlyOptions');
                if (calendlyOptions) {
                    if (this.checked) {
                        calendlyOptions.style.display = 'block';
                    } else {
                        calendlyOptions.style.display = 'none';
                    }
                }
            });
        }

        // --- Bulk Treatment Update Logic ---
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const treatmentCheckboxes = document.querySelectorAll('.treatment-checkbox');
        const bulkActionsDiv = document.getElementById('bulkActions');
        const selectedCountSpan = document.getElementById('selectedCount');
        const bulkActionButtons = document.querySelectorAll('.bulk-action-btn');
        const patientId = parseInt("{{ patient.id }}"); // Get patient ID for context

        function updateBulkActionVisibility() {
            const selectedCheckboxes = document.querySelectorAll('.treatment-checkbox:checked');
            const count = selectedCheckboxes.length;
            selectedCountSpan.textContent = count;
            if (count > 0) {
                bulkActionsDiv.style.display = 'block';
            } else {
                bulkActionsDiv.style.display = 'none';
            }
        }

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                treatmentCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBulkActionVisibility();
            });
        }

        treatmentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (!this.checked) {
                    selectAllCheckbox.checked = false; // Uncheck 'Select All' if any individual is unchecked
                }
                // Check if all are checked to potentially check 'Select All'
                else if (document.querySelectorAll('.treatment-checkbox:checked').length === treatmentCheckboxes.length) {
                   selectAllCheckbox.checked = true;
                }
                updateBulkActionVisibility();
            });
        });

        bulkActionButtons.forEach(button => {
            button.addEventListener('click', async function() {
                const selectedIds = Array.from(document.querySelectorAll('.treatment-checkbox:checked')).map(cb => cb.value);
                const field = this.dataset.field;
                const value = this.dataset.value;
                let confirmMessage = `Are you sure you want to set "${field}" to "${value}" for ${selectedIds.length} treatment(s)?`;

                // Add specific message for CostaSpine location
                if (field === 'location' && value === 'CostaSpine Clinic') {
                    confirmMessage += `\n\nNote: This will also automatically set the fee to €80 for the patient's earliest treatment (if selected) and €70 for all other selected treatments.`;
                }

                if (selectedIds.length === 0) {
                    alert('Please select at least one treatment to update.');
                    return;
                }

                if (confirm(confirmMessage)) {
                    // Disable buttons while processing
                    bulkActionButtons.forEach(btn => btn.disabled = true);
                    
                    try {
                        const response = await fetch('/api/treatments/bulk-update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                treatment_ids: selectedIds,
                                field: field,
                                value: value
                            })
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert(result.message);
                            // Reload the page to see changes
                            window.location.reload(); 
                        } else {
                            alert(`Error: ${result.message || 'Failed to update treatments.'}`);
                        }
                    } catch (error) {
                        console.error('Bulk update error:', error);
                        alert('An error occurred while performing the bulk update.');
                    } finally {
                        // Re-enable buttons
                        bulkActionButtons.forEach(btn => btn.disabled = false);
                    }
                }
            });
        });
        // --- End Bulk Treatment Update Logic ---

    });

    function openTreatmentModal(treatmentId) {
        fetch(`/api/treatment/${treatmentId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('treatmentDate').textContent = data.date ? new Date(data.date).toLocaleDateString() : 'N/A';
                document.getElementById('treatmentDescription').textContent = data.description || 'No description';
                document.getElementById('treatmentNotes').textContent = data.progress_notes || 'No notes';
                
                // Update Pain Level display
                const painLevelSpan = document.getElementById('treatmentPainLevel');
                if (data.pain_level !== null && data.pain_level !== undefined) {
                    const width = data.pain_level * 10;
                    painLevelSpan.innerHTML = `
                        <div class="progress" style="height: 20px; max-width: 150px;" title="Pain: ${data.pain_level}/10">
                            <div class="progress-bar bg-danger" role="progressbar"
                                 style="width: ${width}%;"
                                 aria-valuenow="${data.pain_level}" aria-valuemin="0" aria-valuemax="10">
                                ${data.pain_level}/10
                            </div>
                        </div>
                    `;
                } else {
                    painLevelSpan.innerHTML = '<span class="text-muted">N/E</span>';
                }
                
                // Set the href for the edit button
                const editButton = document.getElementById('editTreatmentBtn');
                if (editButton) {
                    editButton.href = `/treatment/${treatmentId}/edit`;
                }
                
                const modal = new bootstrap.Modal(document.getElementById('treatmentDetailModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching treatment details:', error);
                alert('Failed to load treatment details.');
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const treatmentsTableBody = document.querySelector('#treatmentsTable tbody'); // Target the table body

        if (!treatmentsTableBody) {
            console.error("Treatments table body not found!");
            return;
        }

        // Use event delegation for handling clicks within the table body
        treatmentsTableBody.addEventListener('click', async function(event) {
            const setFeeBtn = event.target.closest('.set-fee-btn');
            const setPaymentBtn = event.target.closest('.set-payment-btn');

            if (setFeeBtn) {
                await handleSetFee(setFeeBtn);
            } else if (setPaymentBtn) {
                await handleSetPayment(setPaymentBtn);
            }
        });

        async function handleSetFee(button) {
            const treatmentId = button.dataset.treatmentId;
            const row = document.getElementById(`treatment-row-${treatmentId}`);
            const feeInput = row.querySelector(`#fee-input-${treatmentId}`);
            const feeStatus = row.querySelector(`#fee-status-${treatmentId}`);
            const feeValue = parseFloat(feeInput.value);

            if (isNaN(feeValue) || feeValue < 0) {
                feeStatus.textContent = 'Invalid fee';
                feeStatus.className = 'text-danger small d-block mt-1';
                feeInput.focus();
                return;
            }

            // UI feedback: loading
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            feeStatus.textContent = 'Saving...';
            feeStatus.className = 'text-muted small d-block mt-1';

            try {
                const response = await fetch(`/api/treatment/${treatmentId}/set-fee`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=\"csrf-token\"]')?.getAttribute('content')
                    },
                    body: JSON.stringify({ fee: feeValue })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    feeStatus.textContent = 'Saved!';
                    feeStatus.className = 'text-success small d-block mt-1';
                    // Optionally disable input or change display after save
                    // feeInput.readOnly = true; 
                } else {
                    throw new Error(data.message || `HTTP error ${response.status}`);
                }
            } catch (error) {
                console.error('Error setting fee:', error);
                feeStatus.textContent = `Error: ${error.message}`;
                feeStatus.className = 'text-danger small d-block mt-1';
            } finally {
                // Restore button
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-check-lg"></i>';
                // Clear status message after a few seconds
                setTimeout(() => { feeStatus.textContent = ''; }, 3000);
            }
        }

        async function handleSetPayment(button) {
            const treatmentId = button.dataset.treatmentId;
            const paymentMethod = button.dataset.method;
            const row = document.getElementById(`treatment-row-${treatmentId}`);
            const paymentStatusSpan = row.querySelector(`#payment-status-${treatmentId}`);
            const paymentButtonsDiv = row.querySelector(`#payment-buttons-${treatmentId}`);
            const paymentUpdateStatus = row.querySelector(`#payment-update-status-${treatmentId}`);

            // UI feedback: loading
            if (paymentButtonsDiv) {
                 paymentButtonsDiv.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
            }
            paymentUpdateStatus.textContent = 'Updating...';
            paymentUpdateStatus.className = 'text-muted small d-block mt-1';

            try {
                const response = await fetch(`/api/treatment/${treatmentId}/set-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=\"csrf-token\"]')?.getAttribute('content')
                    },
                    body: JSON.stringify({ payment_method: paymentMethod })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    paymentStatusSpan.textContent = `Paid - ${data.payment_method}`;
                    paymentUpdateStatus.textContent = 'Saved!';
                    paymentUpdateStatus.className = 'text-success small d-block mt-1';
                    if (paymentButtonsDiv) {
                        paymentButtonsDiv.remove(); // Remove buttons after successful update
                    }
                } else {
                     throw new Error(data.message || `HTTP error ${response.status}`);
                }
            } catch (error) {
                console.error('Error setting payment:', error);
                paymentUpdateStatus.textContent = `Error: ${error.message}`;
                paymentUpdateStatus.className = 'text-danger small d-block mt-1';
                 // Restore buttons on error
                 if (paymentButtonsDiv) {
                     paymentButtonsDiv.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
                 }
            } finally {
                 // Clear status message after a few seconds
                 setTimeout(() => { paymentUpdateStatus.textContent = ''; }, 3000);
            }
        }

    });
</script>
{% endblock %} 