{% extends "base.html" %}

{% block title %}{{ patient.name }} - {{ _('Patient Details') }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Enhanced Tab Styling */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
    }

    .nav-tabs .nav-item {
        margin-bottom: -2px;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-tabs .nav-link i {
        font-size: 1.1rem;
        transition: transform 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        border: none;
        background-color: rgba(41, 128, 185, 0.05);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background-color: transparent;
        border: none;
        font-weight: 600;
    }

    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary-color);
        border-radius: 3px 3px 0 0;
    }

    .nav-tabs .nav-link:hover i {
        transform: translateY(-2px);
    }

    /* Improved Anamnesis Display Styles */
    .anamnesis-section {
        background: white;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .section-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e9ecef;
    }

    .section-title {
        margin: 0;
        display: flex;
        align-items: center;
        font-weight: 600;
        color: #2c3e50;
    }

    .section-content {
        padding: 1.25rem;
    }

    .info-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e9ecef;
        height: 100%;
        transition: all 0.2s ease;
    }

    .info-card:hover {
        background: #e9ecef;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .info-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
        display: block;
    }

    .info-value {
        font-size: 0.95rem;
        color: #2c3e50;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .pain-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .pain-number {
        font-size: 2rem;
        font-weight: bold;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 50%;
        min-width: 3.5rem;
        height: 3.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .pain-desc {
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Tab Content Styling */
    .tab-content {
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .tab-pane {
        padding: 1.5rem;
    }

    .tab-pane .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .tab-pane .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .tab-pane .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.25rem;
    }

    .tab-pane .card-header h5 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }

    /* Patient Statistics Styles */
    .stat-item {
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .stat-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
    }

    .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    {% if not today is defined %}
        <div class="alert alert-warning">
            <strong>{{ _('Warning:') }}</strong> {{ _("The 'today' variable is not defined. Some features may not work correctly.") }}
        </div>
    {% endif %}

    <!-- Add this after the flash messages section -->
    {% if session.get('auto_completed_treatments') %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        {{ session.get('auto_completed_treatments') }} {{ _('past treatment(s) were automatically marked as completed.') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Close') }}"></button>
    </div>
    {% endif %}

    <!-- Clinical History Alert -->
    {% if not patient.anamnesis or not patient.anamnesis.strip() %}
    <div id="clinical-history-permanent-warning" style="background-color: #fff3cd; border: 2px solid #f39c12; border-radius: 8px; padding: 15px; margin-bottom: 20px; position: relative; z-index: 9999;">
        <button type="button" onclick="closeClinicalHistoryAlert()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 18px; color: #856404; cursor: pointer; line-height: 1;" aria-label="Close">
            <i class="bi bi-x"></i>
        </button>
        <div style="display: flex; align-items: center; gap: 10px; padding-right: 30px;">
            <i class="bi bi-exclamation-triangle-fill" style="color: #856404; font-size: 20px;"></i>
            <div>
                <div style="color: #856404; font-weight: bold; font-size: 16px;">{{ _('Clinical History Incomplete') }}</div>
                <div style="color: #856404; margin-top: 5px;">
                    {{ _('This patient has not completed their clinical history (anamnesis). Please complete it before providing treatment.') }}
                    <a href="{{ url_for('main.edit_patient', id=patient.id) }}" style="color: #664d03; text-decoration: underline; font-weight: bold;">{{ _('Complete Clinical History') }}</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Patient Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-3">{{ patient.name }}</h1>
            <div class="patient-info mb-3">
                <p class="mb-1"><strong>{{ _('Date of Birth:') }}</strong> {{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else _('Not provided') }}</p>
                <p class="mb-1"><strong>{{ _('Contact:') }}</strong> {{ patient.contact or _('Not provided') }}</p>
                <p class="mb-1"><strong>{{ _('Status:') }}</strong> <span class="badge bg-{{ 'primary' if patient.status == 'Active' else 'secondary' }}">{{ _(patient.status) }}</span></p>
                <p class="mb-1">
                    <strong>{{ _('Dry Needling:') }}</strong> 
                    <span class="badge d-inline-flex align-items-center gap-1" style="font-size: 0.85rem; padding: 0.4rem 0.6rem;">
                        <span style="font-size: 1.1rem;">{{ patient.get_dry_needling_symbol() }}</span>
                        <span class="{{ patient.get_dry_needling_color() }}">{{ patient.get_dry_needling_text() }}</span>
                    </span>
                </p>
            </div>
        </div>
        <div class="col-md-4 text-md-end">
            <!-- Primary Actions - Most Used -->
            <div class="d-flex flex-row gap-2 mb-2" style="flex-wrap: nowrap; overflow-x: auto; min-width: 0;">
                <img src="{{ url_for('static', filename='images/bubblebrain.png') }}" alt="The Brain" style="width: 96px; height: 96px; object-fit: contain; cursor: pointer; flex-shrink: 0;" data-patient-id="{{ patient.id }}" data-patient-name="{{ patient.name }}" onclick="openPatientAIChat(this.dataset.patientId, this.dataset.patientName)">
                <img src="{{ url_for('static', filename='images/editpatient.png') }}" alt="Edit Patient" style="width: 96px; height: 96px; object-fit: contain; cursor: pointer; flex-shrink: 0;" data-edit-url="{{ url_for('main.edit_patient', id=patient.id) }}" onclick="window.location.href=this.dataset.editUrl">
                <img src="{{ url_for('static', filename='images/newappointment.png') }}" alt="New Appointment" style="width: 96px; height: 96px; object-fit: contain; cursor: pointer; flex-shrink: 0;" data-appointment-url="{{ url_for('main.new_treatment_page', patient_id=patient.id) }}" onclick="window.location.href=this.dataset.appointmentUrl">
                <img src="{{ url_for('static', filename='images/recurring.png') }}" alt="Recurring" style="width: 96px; height: 96px; object-fit: contain; cursor: pointer; flex-shrink: 0;" data-recurring-url="{{ url_for('main.new_recurring_appointment', patient_id=patient.id) }}" onclick="window.location.href=this.dataset.recurringUrl">
            </div>
            
            <!-- Secondary Actions Dropdown -->
            <div class="d-flex justify-content-md-end gap-2">
                
                <!-- AI & Reports Dropdown -->
                <div class="dropdown">
                    <button class="btn btn-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-brain"></i> {{ _('AI Tools') }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <button class="dropdown-item" id="generateReportBtn">
                                <i class="bi bi-file-earmark-text text-info"></i> {{ _('Generate AI Report') }}
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" id="generateExerciseBtn">
                                <i class="bi bi-clipboard-heart text-warning"></i> {{ _('Generate Exercises') }}
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" id="generateClinicalAnalysisBtn">
                                <i class="bi bi-graph-up text-primary"></i> {{ _('Clinical Analysis') }}
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}">
                                <i class="bi bi-file-text text-secondary"></i> {{ _('View All Reports') }}
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-light">
                <div class="card-body py-3">
                    <h6 class="card-subtitle mb-3 text-muted">
                        <i class="bi bi-graph-up"></i> {{ _('Patient Statistics') }}
                    </h6>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number text-primary" id="total-appointments">
                                    <i class="bi bi-hourglass"></i> {{ _('Loading...') }}
                                </div>
                                <div class="stat-label">{{ _('Total Appointments') }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number text-success" id="completed-appointments">
                                    <i class="bi bi-hourglass"></i> {{ _('Loading...') }}
                                </div>
                                <div class="stat-label">{{ _('Completed') }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number text-danger" id="cancelled-appointments">
                                    <i class="bi bi-hourglass"></i> {{ _('Loading...') }}
                                </div>
                                <div class="stat-label">{{ _('Cancelled') }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item">
                                <div class="stat-number" id="cancellation-rate" style="color: #fd7e14;">
                                    <i class="bi bi-hourglass"></i> {{ _('Loading...') }}
                                </div>
                                <div class="stat-label">{{ _('Cancellation Rate') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="patientTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="treatments-tab" data-bs-toggle="tab" data-bs-target="#treatments" type="button" role="tab" aria-controls="treatments" aria-selected="true">
                <i class="bi bi-clipboard-pulse"></i> {{ _('Treatments') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="anamnesis-tab" data-bs-toggle="tab" data-bs-target="#anamnesis" type="button" role="tab" aria-controls="anamnesis" aria-selected="false">
                <i class="bi bi-journal-medical"></i> {{ _('Clinical History') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="consents-tab" data-bs-toggle="tab" data-bs-target="#consents" type="button" role="tab" aria-controls="consents" aria-selected="false">
                <i class="bi bi-file-earmark-check"></i> {{ _('Consents') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                <i class="bi bi-file-text"></i> {{ _('Reports') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-analysis-tab" data-bs-toggle="tab" data-bs-target="#ai-analysis" type="button" role="tab" aria-controls="ai-analysis" aria-selected="false">
                <i class="bi bi-robot"></i> {{ _('AI Clinical Analysis') }}
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="patientTabsContent">
        <!-- Treatments Tab -->
        <div class="tab-pane fade show active" id="treatments" role="tabpanel" aria-labelledby="treatments-tab">
            <!-- Recurring Appointments Section -->
            <div class="row mb-4">
                <div class="col-md-12">
                    {% if patient.recurring_appointments %}
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar-repeat"></i> {{ _('Recurring Appointments') }}</h5>
                            <a href="{{ url_for('main.new_recurring_appointment', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle"></i> {{ _('Add Rule') }}
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="list-group">
                                {% for rule in patient.recurring_appointments %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">
                                                {{ rule.treatment_type }} 
                                                - {% if rule.recurrence_type == 'daily-mon-fri' %}{{ _('Daily (Mon-Fri)') }}{% elif rule.recurrence_type == 'weekly' %}{{ _('Weekly') }}{% endif %}
                                            </h6>
                                            <small>
                                                <span class="badge bg-{{ 'success' if rule.is_active else 'secondary' }}">
                                                    {{ _('Active') if rule.is_active else _('Inactive') }}
                                                </span>
                                            </small>
                                        </div>
                                        <p class="mb-1">
                                            {{ _('Starts:') }} {{ rule.start_date.strftime('%Y-%m-%d') }} 
                                            {% if rule.end_date %} | {{ _('Ends:') }} {{ rule.end_date.strftime('%Y-%m-%d') }} {% endif %}
                                            | {{ _('Time:') }} {{ rule.time_of_day.strftime('%H:%M') }}
                                        </p>
                                        <small class="text-muted">{{ _('Location:') }} {{ rule.location or 'N/A' }} | {{ _('Fee:') }} {{ ('€' + "{:.2f}".format(rule.fee_charged)) if rule.fee_charged else 'N/A' }}</small>
                                        <div class="mt-2">
                                            <a href="{{ url_for('main.edit_recurring_appointment', id=rule.id) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i> {{ _('Edit') }}</a>
                                            <form action="{{ url_for('main.delete_recurring_appointment', id=rule.id) }}" method="POST" style="display: inline-block;" class="delete-recurring-form" data-confirm-message="{{ _('Are you sure you want to delete this recurring rule?') }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> {{ _('Delete') }}</button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ICD-10 Diagnoses Section -->
            <div class="row mb-4">
                <div class="col-md-8">
                    {% include 'components/icd10_diagnosis_display.html' %}
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-journal-medical"></i> {{ _('Treatment Plan') }}</h5>
                        </div>
                        <div class="card-body">
                            <p>{{ patient.treatment_plan }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Treatment History Section -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> {{ _('Past Treatments') }}</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newTreatmentModal">
                                <i class="bi bi-plus-circle"></i> {{ _('Add Past Treatment') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Bulk Action Controls - Moved above table -->
                            <div id="bulkActions" class="mb-3 p-3 bg-light rounded" style="display: none;"> 
                                <h6>{{ _('Bulk Actions for Selected') }} (<span id="selectedCount">0</span>):</h6>
                                <div class="row gx-2 gy-2">
                                    <div class="col-auto">
                                        <div class="btn-group btn-group-sm" role="group" aria-label="{{ _('Set Location') }}">
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="location" data-value="{{ current_user.clinic_name }}">Set Loc: {{ current_user.clinic_name }}</button>
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="location" data-value="Home Visit">{{ _('Set Loc: Home Visit') }}</button>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="btn-group btn-group-sm" role="group" aria-label="{{ _('Set Payment Method') }}">
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="payment_method" data-value="Cash">{{ _('Set Pmt: Cash') }}</button>
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="payment_method" data-value="Card">{{ _('Set Pmt: Card') }}</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Debug information to check patient treatments are loaded -->
                            <p class="text-muted small">{{ _('Total treatments for this patient:') }} {{ treatments|length }}</p>
                            <!-- Note about past treatments -->
                            <p class="text-muted small">{{ _('Showing treatments completed on or before today') }} ({{ today.strftime('%Y-%m-%d') }})</p>
                            
                            <!-- Simple, direct treatment listing without modals -->
                            {% if treatments|length > 0 %}
                                <div class="table-responsive">
                                    <table class="table table-hover" id="treatmentsTable">
                                        <thead>
                                            <tr>
                                                <th><input class="form-check-input" type="checkbox" id="selectAllCheckbox"></th>
                                                <th>{{ _('Date') }}</th>
                                                <th>{{ _('Type') }}</th>
                                                <th>{{ _('Practitioner') }}</th>
                                                <th>{{ _('Status') }}</th>
                                                <th>{{ _('Pain Level') }}</th>
                                                <th>{{ _('Fee (€)') }}</th>
                                                <th>{{ _('Payment') }}</th>
                                                <th>{{ _('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set has_past_treatments = false %}
                                            {% for treatment in treatments|sort(attribute='created_at', reverse=true) %}
                                                {% if treatment.created_at and treatment.created_at <= today %}
                                                {% set has_past_treatments = true %}
                                                <tr id="treatment-row-{{ treatment.id }}">
                                                    <td><input class="form-check-input treatment-checkbox" type="checkbox" value="{{ treatment.id }}"></td>
                                                    <td>{{ treatment.created_at.strftime('%Y-%m-%d %H:%M') if treatment.created_at else 'N/A' }}</td>
                                                    <td>{{ treatment.treatment_type or 'N/A' }}</td>
                                                    <td>
                                                        {% if treatment.provider %}
                                                            <span class="text-dark small">{{ practitioners.get(treatment.provider, treatment.provider) }}</span>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge {% if treatment.status == 'Completed' %}bg-primary{% elif treatment.status == 'Scheduled' %}bg-info text-dark{% elif treatment.status == 'Cancelled' %}bg-danger{% else %}bg-secondary{% endif %} status-badge" id="status-{{ treatment.id }}">
                                                            {{ _(treatment.status) if treatment.status else 'N/A' }}
                                                        </span>
                                                    </td>
                                                    <td>{{ treatment.pain_level if treatment.pain_level is not none else 'N/A' }}/10</td>
                                                    <td class="fee-column">
                                                        <div class="input-group input-group-sm">
                                                            <input type="number" class="form-control form-control-sm fee-input" id="fee-input-{{ treatment.id }}" value="{{ treatment.fee_charged if treatment.fee_charged is not none else '' }}" placeholder="{{ _('Fee') }}" step="0.01" style="width: 70px;">
                                                            <button class="btn btn-outline-secondary btn-sm set-fee-btn" data-treatment-id="{{ treatment.id }}" type="button" title="{{ _('Set Fee') }}">
                                                                <i class="bi bi-check-lg"></i>
                                                            </button>
                                                        </div>
                                                        <small id="fee-status-{{ treatment.id }}" class="text-muted d-block mt-1"></small>
                                                    </td>
                                                    <td class="payment-column">
                                                        <span id="payment-status-{{ treatment.id }}" class="d-block mb-1">
                                                            {% if treatment.payment_method %}
                                                                {{ _('Paid -') }} {{ _(treatment.payment_method) }}
                                                            {% else %}
                                                                {{ _('Unpaid') }}
                                                            {% endif %}
                                                        </span>
                                                        {% if not treatment.payment_method %}
                                                        <div class="btn-group btn-group-sm payment-buttons" id="payment-buttons-{{ treatment.id }}">
                                                            <button class="btn btn-outline-success btn-sm set-payment-btn" data-treatment-id="{{ treatment.id }}" data-method="Cash">{{ _('Cash') }}</button>
                                                            <button class="btn btn-outline-primary btn-sm set-payment-btn" data-treatment-id="{{ treatment.id }}" data-method="Card">{{ _('Card') }}</button>
                                                        </div>
                                                        {% endif %}
                                                        <small id="payment-update-status-{{ treatment.id }}" class="text-muted d-block mt-1"></small>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <a href="{{ url_for('main.view_treatment', id=treatment.id) }}" class="btn btn-sm btn-primary">
                                                                <i class="bi bi-eye"></i> {{ _('View') }}
                                                            </a>
                                                            <a href="{{ url_for('main.edit_treatment', id=treatment.id) }}" class="btn btn-sm btn-secondary">
                                                                <i class="bi bi-pencil"></i> {{ _('Edit') }}
                                                            </a>
                                                            {% if treatment.status != 'Cancelled' %}
                                                            <button class="btn btn-sm btn-outline-danger cancel-treatment-btn" 
                                                                    data-treatment-id="{{ treatment.id }}" 
                                                                    data-treatment-type="{{ treatment.treatment_type }}"
                                                                    title="{{ _('Cancel Appointment') }}">
                                                                <i class="bi bi-x-circle"></i> {{ _('Cancel') }}
                                                            </button>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> {{ _('No treatments found for this patient.') }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anamnesis Tab -->
        <div class="tab-pane fade" id="anamnesis" role="tabpanel" aria-labelledby="anamnesis-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-journal-medical"></i> {{ _('Clinical History') }}</h5>
                            <a href="{{ url_for('main.edit_patient', id=patient.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> {{ _('Edit Anamnesis') }}
                            </a>
                        </div>
                        <div class="card-body">
                            {% if patient.anamnesis and patient.anamnesis.strip() %}
                                <div class="anamnesis-display">
                                    <!-- Structured Anamnesis Display (populated by JavaScript) -->
                                    <script type="application/json" id="anamnesis-data">{{ patient.anamnesis | tojson }}</script>
                                    <div id="structured-anamnesis">
                                        <!-- Content will be dynamically generated by JavaScript -->
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="bi bi-journal-medical text-muted" style="font-size: 3rem;"></i>
                                    <h5 class="text-muted mt-3">{{ _('No Clinical History Available') }}</h5>
                                    <p class="text-muted mb-4">{{ _('The clinical history (anamnesis) for this patient has not been completed yet.') }}</p>
                                    <a href="{{ url_for('main.edit_patient', id=patient.id) }}" class="btn btn-primary">
                                        <i class="bi bi-plus-circle"></i> {{ _('Add Clinical History') }}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consents Tab -->
        <div class="tab-pane fade" id="consents" role="tabpanel" aria-labelledby="consents-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-check"></i> {{ _('Patient Consents') }}</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addConsentModal">
                                <i class="bi bi-plus-circle"></i> {{ _('Add New Consent') }}
                            </button>
                        </div>
                        <div class="card-body">
                            {% if patient.consents %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>{{ _('Date Given') }}</th>
                                                <th>{{ _('Purpose') }}</th>
                                                <th>{{ _('Status') }}</th>
                                                <th>{{ _('Expiry Date') }}</th>
                                                <th>{{ _('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for consent in patient.consents|sort(attribute='given_at', reverse=true) %}
                                            <tr id="consent-row-{{ consent.id }}">
                                                <td>{{ consent.given_at.strftime('%Y-%m-%d') }}</td>
                                                <td>{{ consent.purpose }}</td>
                                                <td>
                                                    {% if consent.is_active %}
                                                        <span class="badge bg-success">{{ _('Active') }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ _('Expired') }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ consent.expires_at.strftime('%Y-%m-%d') if consent.expires_at else _('N/A') }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-danger delete-consent-btn" data-consent-id="{{ consent.id }}">
                                                        <i class="bi bi-trash"></i> {{ _('Delete') }}
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#consentModal{{ consent.id }}">
                                                        <i class="bi bi-eye"></i> {{ _('View Details') }}
                                                    </button>
                                                    {% if consent.is_active %}
                                                    <button type="button" class="btn btn-sm btn-warning" onclick="revokeConsent('{{ consent.id }}')">
                                                        <i class="bi bi-x-circle"></i> {{ _('Revoke') }}
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>

                                            <!-- Consent Details Modal -->
                                            <div class="modal fade" id="consentModal{{ consent.id }}" tabindex="-1" aria-labelledby="consentModalLabel{{ consent.id }}" aria-hidden="true">
                                                <div class="modal-dialog modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="consentModalLabel{{ consent.id }}">{{ _('Consent Details') }}</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <dl class="row">
                                                                <dt class="col-sm-3">{{ _('Purpose') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.purpose }}</dd>

                                                                <dt class="col-sm-3">{{ _('Given At') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.given_at.strftime('%Y-%m-%d %H:%M') }}</dd>

                                                                <dt class="col-sm-3">{{ _('Expires At') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.expires_at.strftime('%Y-%m-%d %H:%M') if consent.expires_at else _('N/A') }}</dd>

                                                                <dt class="col-sm-3">{{ _('Status') }}</dt>
                                                                <dd class="col-sm-9">
                                                                    {% if consent.is_active %}
                                                                        <span class="badge bg-success">{{ _('Active') }}</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">{{ _('Expired') }}</span>
                                                                    {% endif %}
                                                                </dd>

                                                                <dt class="col-sm-3">{{ _('Notes') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.notes or _('No additional notes') }}</dd>
                                                            </dl>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
                                                            {% if consent.is_active %}
                                                            <button type="button" class="btn btn-warning" onclick="revokeConsent('{{ consent.id }}')">{{ _('Revoke Consent') }}</button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">{{ _('No consent records found for this patient.') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-file-text"></i> {{ _('Reports') }}</h5>
                            <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye"></i> {{ _('View All Reports') }}
                            </a>
                        </div>
                        <div class="card-body">
                            {% if patient_reports %}
                                <div class="list-group">
                                    {% for report in patient_reports %}
                                        <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}?report_id={{ report.id }}" 
                                           class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ _(report.report_type) }}</h6>
                                                <small>{{ report.generated_date.strftime('%Y-%m-%d %H:%M') }}</small>
                                            </div>
                                            <small>{{ _('Click to view this report') }}</small>
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">{{ _('No reports generated yet.') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div class="tab-pane fade" id="ai-analysis" role="tabpanel" aria-labelledby="ai-analysis-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card shadow-lg" style="border: none; border-radius: 12px; overflow: hidden;">
                        <div class="card-body" style="padding: 30px; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);">
                            
                            <!-- MOSTRAR SI HAY DATOS -->
                            {% if patient.ai_analysis_date %}
                                <div class="mb-4">
                                    <div class="alert" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: none; border-radius: 10px; padding: 15px;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-check-circle-fill text-success me-3" style="font-size: 24px;"></i>
                                            <div>
                                                <h6 class="mb-1" style="color: #155724; font-weight: 600;">{{ _('Analysis Completed Successfully') }}</h6>
                                                <small style="color: #155724;">{{ _('Generated on') }} {{ patient.ai_analysis_date.strftime('%B %d, %Y at %H:%M') }}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- TESTS SUGERIDOS -->
                                {% if patient.ai_suggested_tests %}
                                <div class="analysis-section mb-4">
                                    <div class="section-header" style="background: linear-gradient(135deg, #4285f4 0%, #34a853 100%); color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; margin-bottom: 0;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-clipboard-check me-3" style="font-size: 20px;"></i>
                                            <h6 class="mb-0" style="font-weight: 600;">{{ _('Recommended Tests & Assessments') }}</h6>
                                        </div>
                                    </div>
                                    <div class="section-content" style="background: white; padding: 25px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border-left: 4px solid #4285f4;">
                                        <div style="font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; color: #2c3e50; white-space: pre-wrap;">{{ patient.ai_suggested_tests }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- BANDERAS ROJAS -->
                                {% if patient.ai_red_flags %}
                                <div class="analysis-section mb-4">
                                    <div class="section-header" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; margin-bottom: 0;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 20px;"></i>
                                            <h6 class="mb-0" style="font-weight: 600;">{{ _('Red Flags - Immediate Attention Required') }}</h6>
                                        </div>
                                    </div>
                                    <div class="section-content" style="background: #fff5f5; padding: 25px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border-left: 4px solid #e74c3c;">
                                        <div style="font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; color: #721c24; white-space: pre-wrap; font-weight: 500;">{{ patient.ai_red_flags }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- BANDERAS AMARILLAS -->
                                {% if patient.ai_yellow_flags %}
                                <div class="analysis-section mb-4">
                                    <div class="section-header" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; margin-bottom: 0;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-exclamation-circle-fill me-3" style="font-size: 20px;"></i>
                                            <h6 class="mb-0" style="font-weight: 600;">{{ _('Yellow Flags - Monitor & Consider') }}</h6>
                                        </div>
                                    </div>
                                    <div class="section-content" style="background: #fffbf0; padding: 25px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border-left: 4px solid #f39c12;">
                                        <div style="font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; color: #8a6d3b; white-space: pre-wrap;">{{ patient.ai_yellow_flags }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- NOTAS CLÍNICAS -->
                                {% if patient.ai_clinical_notes %}
                                <div class="analysis-section mb-4">
                                    <div class="section-header" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; margin-bottom: 0;">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-journal-medical me-3" style="font-size: 20px;"></i>
                                            <h6 class="mb-0" style="font-weight: 600;">{{ _('Clinical Notes & Recommendations') }}</h6>
                                        </div>
                                    </div>
                                    <div class="section-content" style="background: white; padding: 25px; border-radius: 0 0 10px 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); border-left: 4px solid #6c757d;">
                                        <div style="font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; color: #495057; white-space: pre-wrap;">{{ patient.ai_clinical_notes }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="text-center mt-5" style="padding: 20px;">
                                    <button id="regenerateAnalysisBtn" class="btn btn-lg shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 15px 40px; border-radius: 50px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; letter-spacing: 0.5px;">
                                        <i class="bi bi-arrow-clockwise me-2"></i>{{ _('Regenerate Analysis') }}
                                    </button>
                                </div>
                                
                            {% else %}
                                <!-- NO HAY DATOS -->
                                <div class="text-center py-5">
                                    <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); padding: 40px; border-radius: 20px; margin-bottom: 30px;">
                                        <div style="background: rgba(255,255,255,0.9); border-radius: 50%; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                                            <i class="bi bi-robot" style="font-size: 48px; color: #6c757d;"></i>
                                        </div>
                                        <h4 style="color: #2d3436; font-weight: 600; margin-bottom: 15px;">{{ _('No AI Analysis Available') }}</h4>
                                        <p style="color: #636e72; font-size: 16px; max-width: 500px; margin: 0 auto;">{{ _('Generate an intelligent clinical analysis based on patient anamnesis data and treatment history using advanced AI technology.') }}</p>
                                    </div>
                                    <button id="generateAnalysisBtn" class="btn btn-lg shadow-lg" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); border: none; color: white; padding: 18px 50px; border-radius: 50px; font-weight: 600; text-decoration: none; transition: all 0.3s ease; letter-spacing: 0.5px;">
                                        <i class="bi bi-robot me-2"></i>{{ _('Generate AI Analysis') }}
                                    </button>
                                </div>
                            {% endif %}
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Treatment Detail Modal -->
<div class="modal fade" id="treatmentDetailModal" tabindex="-1" aria-labelledby="treatmentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="treatmentDetailModalLabel">{{ _('Treatment Details') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>{{ _('Date:') }}</strong> <span id="treatmentDate"></span></p>
                        <p><strong>{{ _('Description:') }}</strong> <span id="treatmentDescription"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{{ _('Pain Level:') }}</strong> <span id="treatmentPainLevel"></span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>{{ _('Progress Notes') }}</h6>
                        <div class="p-3 bg-light rounded">
                            <p id="treatmentNotes" class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="editTreatmentBtn" href="#" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> {{ _('Edit Treatment') }}
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- New Treatment Modal -->
<div class="modal fade" id="newTreatmentModal" tabindex="-1" aria-labelledby="newTreatmentModalLabel" aria-hidden="true" data-is-first-visit="{{ is_first_visit|tojson|safe }}">
    <!-- Modal content here -->
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTreatmentModalLabel">{{ _('Add Treatment') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <div class="modal-body">
                <form id="treatmentForm">
                    <div class="mb-3">
                        <label for="treatment_type" class="form-label">{{ _('Description') }}</label>
                        <input type="text" class="form-control" id="treatment_type" name="treatment_type">
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">{{ _('Date') }}</label>
                        <input type="hidden" id="date" name="date">
                    </div>
                    <div class="mb-3">
                        <label for="pain_level" class="form-label">{{ _('Pain Level (0-10)') }}</label>
                        <input type="number" class="form-control" id="pain_level" name="pain_level" min="0" max="10">
                        <small class="text-muted">{{ _('Optional: Leave blank if not applicable') }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="movement_restriction" class="form-label">{{ _('Movement Restriction') }}</label>
                        <textarea class="form-control" id="movement_restriction" name="movement_restriction" rows="3"></textarea>
                    </div>
                    
                    <!-- Body Chart Section -->
                    <div class="mb-3">
                        <label class="form-label">{{ _('Body Chart') }}</label>
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">{{ _('Add Trigger Points') }}</h6>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-danger active" data-point-type="active">{{ _('Active') }}</button>
                                        <button type="button" class="btn btn-outline-warning" data-point-type="latent">{{ _('Latent') }}</button>
                                        <button type="button" class="btn btn-outline-info" data-point-type="satellite">{{ _('Satellite') }}</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="body-map-container">
                                    <img src="{{ url_for('static', filename='images/bodychart.svg') }}" class="body-map" id="bodyMapImageAdd" alt="Body chart">
                                    <svg class="body-map-overlay" id="bodyMapOverlayAdd" viewBox="0 0 500 800" xmlns="http://www.w3.org/2000/svg">
                                        <g id="addTriggerPoints"></g>
                                    </svg>
                                </div>
                                <div class="text-muted small mt-2">{{ _('Click on the body map to add trigger points') }}</div>
                                
                                <!-- Trigger Points Table -->
                                <div class="mt-3">
                                    <h6>{{ _('Trigger Points') }}</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>{{ _('Type') }}</th>
                                                    <th>{{ _('Muscle') }}</th>
                                                    <th>{{ _('Intensity') }}</th>
                                                    <th>{{ _('Actions') }}</th>
                                                </tr>
                                            </thead>
                                            <tbody id="addPointsTableBody">
                                                <!-- Trigger points will be added here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden input to store trigger points data -->
                    <input type="hidden" id="addTriggerPointsData" name="trigger_points_data" value="[]">
                    
                    <div class="mb-3">
                        <label for="assessment" class="form-label">{{ _('Assessment') }}</label>
                        <textarea class="form-control" id="assessment" name="assessment" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">{{ _('Progress Notes') }}</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">{{ _('Status') }}</label>
                        <select class="form-select" id="status" name="status">
                            <option value="" disabled selected>{{ _('Select status') }}</option>
                            <option value="Scheduled">{{ _('Scheduled') }}</option>
                            <option value="In Progress">{{ _('In Progress') }}</option>
                            <option value="Completed">{{ _('Completed') }}</option>
                            <option value="Cancelled">{{ _('Cancelled') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="treatment_type" class="form-label">{{ _('Treatment Type') }}</label>
                        <input type="text" class="form-control" id="treatment_type" name="treatment_type" required>
                    </div>
                    <div class="mb-3">
                        <label for="provider" class="form-label">{{ _('Provider') }}</label>
                        <input type="text" class="form-control" id="provider" name="provider">
                    </div>

                    {# ADDED Hidden fields for pre-filled data #}
                    <input type="hidden" id="location" name="location">
                    <input type="hidden" id="visit_type" name="visit_type">
                    <input type="hidden" id="fee_charged" name="fee_charged">
                    {# Payment method is generally set after, so no hidden field needed here #}
                    
                    <!-- Calendly Integration Section -->
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Calendly Integration</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <strong>Note:</strong> Your appointment can be booked through Calendly scheduling.
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="syncWithCalendly" name="sync_with_calendly" value="true">
                                    <label class="form-check-label" for="syncWithCalendly">
                                        <strong>Enable Calendly scheduling for this appointment</strong>
                                    </label>
                                </div>
                                
                                <!-- Calendly options that appear when checkbox is checked -->
                                <div id="calendlyOptions" class="mt-3" style="display: none;">
                                    <div class="mb-3">
                                        <label for="calendlyEventType" class="form-label">Event Type</label>
                                        <select class="form-select" id="calendlyEventType" name="calendly_event_type">
                                            <option value="" selected>Select Calendly event type</option>
                                            <option value="initial-consultation">Initial Consultation (30 min)</option>
                                            <option value="follow-up">Follow-up Session (45 min)</option>
                                            <option value="therapy-session">Therapy Session (60 min)</option>
                                        </select>
                                        <small class="text-muted">Select the appropriate event type from your Calendly account</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="calendlyLocation" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="calendlyLocation" name="calendly_location" placeholder="e.g. Office, Video Call">
                                        <small class="text-muted">Where will this appointment take place?</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="calendlyAppointmentDate" class="form-label">Preferred Date (Optional)</label>
                                        <input type="date" class="form-control" id="calendlyAppointmentDate" name="appointment_date">
                                        <small class="text-muted">If you have a preferred date in mind, otherwise Calendly will show available slots</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">{{ _('Add Treatment') }}</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- New Exercise Prescription Modal -->
<div class="modal fade" id="exercisePrescriptionModal" tabindex="-1" aria-labelledby="exercisePrescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exercisePrescriptionModalLabel">{{ _('AI Generated Exercise Prescription') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body" id="exercisePrescriptionBody">
        {# Prescription content will be loaded here #}
        <p>{{ _('Generating exercise prescription...') }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
        {# Optional: Add a print button later #}
        {# <button type="button" class="btn btn-primary" onclick="window.print();">Print</button> #}
      </div>
    </div>
  </div>
</div>

<!-- Add Consent Modal -->
<div class="modal fade" id="addConsentModal" tabindex="-1" aria-labelledby="addConsentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addConsentModalLabel">{{ _('Add Consent') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="consentTypeDropdown" class="form-label">{{ _('Consent Type') }}</label>
          <select id="consentTypeDropdown" class="form-select">
            <option value="">{{ _('Select consent type...') }}</option>
            <option value="fisioterapia_general">{{ _('C.I FISIOTERAPIA GENERAL') }}</option>
            <option value="consejeria_salud">{{ _('C.I CONSEJERÍA DE SALUD') }}</option>
            <option value="neuromodulacion">{{ _('CONSENTIMIENTO INFORMADO NEUROMODULACIÓN PERCUTÁNEA') }}</option>
            <option value="electroterapia">{{ _('C.I ELECTROTERAPIA') }}</option>
            <option value="epi">{{ _('C.I EPI') }}</option>
            <option value="puncion_seca">{{ _('C.I PUNCIÓN SECA') }}</option>
            <option value="suelo_pelvico">{{ _('C.I SUELO PÉLVICO') }}</option>
            <option value="acupuntura">{{ _('C.I ACUPUNTURA') }}</option>
            <option value="manipulaciones_articulares">{{ _('C.I MANIPULACIONES ARTICULARES') }}</option>
            <option value="masaje_terapeutico">{{ _('C.I MASAJE TERAPÉUTICO') }}</option>
            <option value="proyectos_investigacion">{{ _('C.I PROYECTOS DE INVESTIGACIÓN') }}</option>
          </select>
        </div>
        <div id="consentTextContainer" class="mt-3"></div>
        <div id="acceptSection" style="display:none;">
          <hr>
          <div class="row">
            <div class="col-md-7">
              <label class="form-label">{{ _('Signature (draw below):') }}</label>
              <div style="border:1px solid #ccc; border-radius:4px; background:#fafafa;">
                <canvas id="signaturePad" width="400" height="150" style="width:100%;max-width:400px;height:150px;"></canvas>
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-secondary btn-sm" id="clearSignatureBtn">{{ _('Clear') }}</button>
                <button type="button" class="btn btn-success btn-sm" id="saveSignatureBtn">{{ _('Accept with Signature') }}</button>
              </div>
            </div>
            <div class="col-md-5 text-center">
              <label class="form-label">{{ _('Or scan to accept on your device:') }}</label>
              <div id="qrCode" class="d-flex justify-content-center mt-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Language Selection Modal for AI Report -->
<div class="modal fade" id="languageSelectionModal" tabindex="-1" aria-labelledby="languageSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="languageSelectionModalLabel">{{ _('Select Report Language') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">{{ _('Choose the language for your AI-generated patient report:') }}</p>
        <div class="row">
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langEnglish" value="en" {% if get_locale() == 'en' %}checked{% elif not get_locale() in ['es', 'fr', 'it'] %}checked{% endif %}>
              <label class="form-check-label" for="langEnglish">
                <i class="bi bi-flag"></i> English
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langSpanish" value="es" {% if get_locale() == 'es' %}checked{% endif %}>
              <label class="form-check-label" for="langSpanish">
                <i class="bi bi-flag"></i> Español
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langFrench" value="fr" {% if get_locale() == 'fr' %}checked{% endif %}>
              <label class="form-check-label" for="langFrench">
                <i class="bi bi-flag"></i> Français
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langItalian" value="it" {% if get_locale() == 'it' %}checked{% endif %}>
              <label class="form-check-label" for="langItalian">
                <i class="bi bi-flag"></i> Italiano
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-primary" id="generateReportWithLanguage">
          <i class="bi bi-file-earmark-text"></i> {{ _('Generate Report') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Report Review and Edit Modal -->
<div class="modal fade" id="reportReviewModal" tabindex="-1" aria-labelledby="reportReviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportReviewModalLabel">{{ _('Review and Edit Report') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> {{ _('Please review the generated report below. You can edit the content before saving it.') }}
        </div>
        <div class="form-group">
          <label for="reportContent" class="form-label">{{ _('Report Content') }}</label>
          <textarea id="reportContent" class="form-control" rows="20" style="font-family: 'Courier New', monospace;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-primary" id="saveReportBtn">
          <i class="bi bi-check-circle"></i> {{ _('Save Report') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Language Selection Modal for Exercise Prescription -->
<div class="modal fade" id="exerciseLanguageSelectionModal" tabindex="-1" aria-labelledby="exerciseLanguageSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exerciseLanguageSelectionModalLabel">{{ _('Select Exercise Prescription Language') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">{{ _('Choose the language for your AI-generated exercise prescription:') }}</p>
        <div class="row">
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langEnglish" value="en" {% if get_locale() == 'en' %}checked{% elif not get_locale() in ['es', 'fr', 'it'] %}checked{% endif %}>
              <label class="form-check-label" for="langEnglish">
                <i class="bi bi-flag"></i> English
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langSpanish" value="es" {% if get_locale() == 'es' %}checked{% endif %}>
              <label class="form-check-label" for="langSpanish">
                <i class="bi bi-flag"></i> Español
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langFrench" value="fr" {% if get_locale() == 'fr' %}checked{% endif %}>
              <label class="form-check-label" for="langFrench">
                <i class="bi bi-flag"></i> Français
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langItalian" value="it" {% if get_locale() == 'it' %}checked{% endif %}>
              <label class="form-check-label" for="langItalian">
                <i class="bi bi-flag"></i> Italiano
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-primary" id="generateExerciseWithLanguage">
          <i class="bi bi-clipboard-heart"></i> {{ _('Generate Exercise Homework') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Treatment Confirmation Modal -->
<div class="modal fade" id="cancelTreatmentModal" tabindex="-1" aria-labelledby="cancelTreatmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelTreatmentModalLabel">
          <i class="bi bi-exclamation-triangle text-warning"></i> {{ _('Cancel Appointment') }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="bi bi-info-circle"></i>
          <strong>{{ _('Are you sure you want to cancel this appointment?') }}</strong>
        </div>
        <p><strong>{{ _('Treatment:') }}</strong> <span id="cancel-treatment-type"></span></p>
        <div class="mb-3">
          <label for="cancellation-reason" class="form-label">{{ _('Cancellation Reason (Optional)') }}</label>
          <textarea class="form-control" id="cancellation-reason" rows="3" placeholder="{{ _('Please provide a reason for cancellation...') }}"></textarea>
        </div>
        <p class="text-muted small">
          <i class="bi bi-info-circle"></i> 
          {{ _('This action will mark the appointment as cancelled and update your analytics.') }}
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> {{ _('Keep Appointment') }}
        </button>
        <button type="button" class="btn btn-danger" id="confirmCancelTreatment">
          <i class="bi bi-check-circle"></i> {{ _('Cancel Appointment') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Clinical Analysis Confirmation Modal -->
<div class="modal fade" id="clinicalAnalysisConfirmModal" tabindex="-1" aria-labelledby="clinicalAnalysisConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clinicalAnalysisConfirmModalLabel">
          <i class="bi bi-robot"></i> {{ _('AI Clinical Analysis') }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i>
          <strong>{{ _('AI Clinical Analysis') }}</strong>
        </div>
        <p>{{ _('This will analyze all available anamnesis data for this patient and generate:') }}</p>
        <ul>
          <li><i class="bi bi-clipboard-check"></i> {{ _('Suggested clinical tests') }}</li>
          <li><i class="bi bi-exclamation-triangle"></i> {{ _('Red flags (warning signs)') }}</li>
          <li><i class="bi bi-flag"></i> {{ _('Yellow flags (psychosocial factors)') }}</li>
          <li><i class="bi bi-journal-medical"></i> {{ _('Clinical notes and recommendations') }}</li>
        </ul>
        <p class="text-muted small">
          <i class="bi bi-shield-check"></i> 
          {{ _('All data is anonymized before being sent to the AI service.') }}
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> {{ _('Cancel') }}
        </button>
        <button type="button" class="btn btn-success" id="confirmClinicalAnalysis">
          <i class="bi bi-robot"></i> {{ _('Generate Analysis') }}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// Dynamic anamnesis display function - shows only populated fields
function displayAnamnesis() {
  const anamnesisDataElement = document.getElementById('anamnesis-data');
  const container = document.getElementById('structured-anamnesis');
  
  if (!anamnesisDataElement || !container) return;
  
  try {
    let rawContent = anamnesisDataElement.textContent;
    let data = JSON.parse(rawContent);
    
    // Handle double-encoded JSON
    if (typeof data === 'string') {
      data = JSON.parse(data);
    }
    
    // Clear container
    container.innerHTML = '';
    
    // Field definitions with translations and icons
    const sections = [
      {
        id: 'chief-complaint',
        title: 'Chief Complaint & Pain Assessment',
        icon: 'bi-exclamation-circle-fill text-danger',
        fields: [
          { key: 'chief_complaint.main_complaint', label: 'Chief Complaint', required: true },
          { key: 'pain_details.pain_scale', label: 'Pain Level', type: 'pain', required: true },
          { key: 'chief_complaint.onset', label: 'Onset Date' },
          { key: 'chief_complaint.mechanism', label: 'Mechanism/How it happened' }
        ]
      },
      {
        id: 'personal-info',
        title: 'Personal Information',
        icon: 'bi-person-circle text-primary',
        fields: [
          { key: 'personal_data.age', label: 'Age' },
          { key: 'personal_data.gender', label: 'Gender' },
          { key: 'personal_data.occupation', label: 'Occupation' },
          { key: 'personal_data.emergency_contact', label: 'Emergency Contact' }
        ]
      },
      {
        id: 'medical-history',
        title: 'Medical History',
        icon: 'bi-heart-pulse text-danger',
        fields: [
          { key: 'medical_history.previous_conditions', label: 'Previous Conditions' },
          { key: 'medical_history.surgeries', label: 'Surgeries' },
          { key: 'medical_history.medications', label: 'Current Medications' },
          { key: 'medical_history.allergies', label: 'Allergies' },
          { key: 'family_history.family_history', label: 'Family History' }
        ]
      },
      {
        id: 'lifestyle',
        title: 'Lifestyle & Habits',
        icon: 'bi-activity text-success',
        fields: [
          { key: 'lifestyle.physical_activity', label: 'Physical Activity' },
          { key: 'lifestyle.sleep', label: 'Sleep Patterns' },
          { key: 'lifestyle.work_posture', label: 'Work Posture' },
          { key: 'lifestyle.stress_level', label: 'Stress Level' },
          { key: 'lifestyle.diet_habits', label: 'Diet Habits' }
        ]
      },
      {
        id: 'pain-details',
        title: 'Pain & Symptoms Details',
        icon: 'bi-lightning-fill text-warning',
        fields: [
          { key: 'pain_details.pain_type', label: 'Pain Type' },
          { key: 'pain_details.pain_location', label: 'Pain Location' },
          { key: 'pain_details.pain_triggers', label: 'Aggravating Factors' },
          { key: 'pain_details.pain_relievers', label: 'Relieving Factors' }
        ]
      },
      {
        id: 'functional-assessment',
        title: 'Functional Assessment',
        icon: 'bi-clipboard-data text-info',
        fields: [
          { key: 'functional_assessment.functional_limitations', label: 'Functional Limitations' },
          { key: 'functional_assessment.onset_date', label: 'Assessment Date' }
        ]
      }
    ];
    
    // Helper function to get nested value
    function getNestedValue(obj, path) {
      return path.split('.').reduce((current, key) => current && current[key], obj);
    }
    
    // Helper function to create pain indicator
    function createPainIndicator(level) {
      const painLevel = parseInt(level);
      let className = 'pain-number bg-success';
      let description = 'No pain';
      
      if (painLevel === 0) {
        className = 'pain-number bg-success';
        description = 'No pain';
      } else if (painLevel <= 3) {
        className = 'pain-number bg-info';
        description = 'Mild pain';
      } else if (painLevel <= 6) {
        className = 'pain-number bg-warning';
        description = 'Moderate pain';
      } else {
        className = 'pain-number bg-danger';
        description = 'Severe pain';
      }
      
      return `
        <div class="pain-indicator d-flex flex-column align-items-center">
          <span class="${className}">${painLevel}</span>
          <small class="pain-desc">${description}</small>
        </div>
      `;
    }
    
    // Generate sections dynamically
    sections.forEach(section => {
      const fieldsWithData = section.fields.filter(field => {
        const value = getNestedValue(data, field.key);
        return value && value.toString().trim() !== '';
      });
      
      // Only create section if it has data (or if it's chief complaint with required fields)
      if (fieldsWithData.length > 0 || (section.id === 'chief-complaint' && section.fields.some(f => f.required))) {
        let sectionHtml = `
          <div class="anamnesis-section mb-4">
            <div class="section-header">
              <h6 class="section-title">
                <i class="bi ${section.icon} me-2"></i>
                ${section.title}
              </h6>
            </div>
            <div class="section-content">
              <div class="row g-3">
        `;
        
        // Generate fields
        section.fields.forEach(field => {
          const value = getNestedValue(data, field.key);
          if (value && value.toString().trim() !== '') {
            let fieldHtml;
            
            if (field.type === 'pain') {
              fieldHtml = `
                <div class="col-md-4">
                  <div class="info-card text-center">
                    <label class="info-label">${field.label}</label>
                    ${createPainIndicator(value)}
                  </div>
                </div>
              `;
            } else {
              const colSize = section.fields.length <= 2 ? 'col-md-6' : 'col-md-4';
              fieldHtml = `
                <div class="${colSize}">
                  <div class="info-card">
                    <label class="info-label">${field.label}</label>
                    <div class="info-value">${value}</div>
                  </div>
                </div>
              `;
            }
            
            sectionHtml += fieldHtml;
          }
        });
        
        sectionHtml += `
              </div>
            </div>
          </div>
        `;
        
        container.innerHTML += sectionHtml;
      }
    });
    
    // If no sections were generated, show a message
    if (container.innerHTML.trim() === '') {
      container.innerHTML = `
        <div class="text-center py-4">
          <i class="bi bi-journal-x text-muted" style="font-size: 3rem;"></i>
          <h5 class="text-muted mt-3">No Clinical History Available</h5>
          <p class="text-muted">The clinical history for this patient has not been completed yet.</p>
        </div>
      `;
    }
    
  } catch (e) {
    // Silent error handling
    container.innerHTML = `
      <div class="text-center py-4">
        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
        <h5 class="text-muted mt-3">Error Loading Clinical History</h5>
        <p class="text-muted">There was an issue loading the clinical history data.</p>
      </div>
    `;
  }
}

// Load patient statistics including cancellation rate
async function loadPatientStatistics() {
  try {
    const response = await fetch(`/api/patient/{{ patient.id }}/cancellation-rate`);
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    // Update the statistics display
    document.getElementById('total-appointments').textContent = data.total_appointments;
    document.getElementById('cancelled-appointments').textContent = data.cancelled_appointments;
    document.getElementById('cancellation-rate').textContent = data.cancellation_rate + '%';
    
    // Calculate completed appointments (assuming total - cancelled = completed for simplicity)
    const completed = data.total_appointments - data.cancelled_appointments;
    document.getElementById('completed-appointments').textContent = completed;
    
    // Add visual indicators based on cancellation rate
    const cancellationRateElement = document.getElementById('cancellation-rate');
    if (data.cancellation_rate > 30) {
      cancellationRateElement.style.color = '#dc3545'; // Red for high cancellation rate
    } else if (data.cancellation_rate > 15) {
      cancellationRateElement.style.color = '#fd7e14'; // Orange for moderate cancellation rate
    } else {
      cancellationRateElement.style.color = '#198754'; // Green for low cancellation rate
    }
    
  } catch (error) {
    console.error('Error loading patient statistics:', error);
    
    // Set default values on error
    document.getElementById('total-appointments').textContent = '0';
    document.getElementById('completed-appointments').textContent = '0';
    document.getElementById('cancelled-appointments').textContent = '0';
    document.getElementById('cancellation-rate').textContent = '0%';
  }
}

// Run when page loads
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(displayAnamnesis, 500);
  loadPatientStatistics();
});

// Run when anamnesis tab is clicked
const anamnesisTab = document.getElementById('anamnesis-tab');
if (anamnesisTab) {
  anamnesisTab.addEventListener('click', function() {
    setTimeout(displayAnamnesis, 100);
  });
}

// CSRF Token handling
const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || 
                 document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                 '{{ csrf_token() }}';

// Generate Report Button Event Listener
let isGenerating = false; // Add a flag to prevent multiple submissions
var generateBtn = document.getElementById('generateReportBtn');
if (generateBtn) {
  generateBtn.addEventListener('click', function() {
    // Show the language selection modal instead of generating directly
    const languageModal = new bootstrap.Modal(document.getElementById('languageSelectionModal'));
    languageModal.show();
  });
}

// Handle the generate report button in the modal
var generateReportWithLanguageBtn = document.getElementById('generateReportWithLanguage');
if (generateReportWithLanguageBtn) {
  generateReportWithLanguageBtn.onclick = function() {
    if (isGenerating) {
      return; // Prevent multiple clicks
    }

    const selectedLanguage = document.querySelector('input[name="reportLanguage"]:checked').value;
    const languageModal = bootstrap.Modal.getInstance(document.getElementById('languageSelectionModal'));
    
    isGenerating = true; // Set the flag
    // Disable the button and show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Generating...") }}';
    
    fetch(`/api/patient/{{ patient.id }}/generate-report`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        language: selectedLanguage
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        languageModal.hide();
        // Show the review modal with the generated content
        document.getElementById('reportContent').value = data.content;
        const reviewModal = new bootstrap.Modal(document.getElementById('reportReviewModal'));
        reviewModal.show();
      } else {
        alert('{{ _("Error generating report:") }} ' + (data.message || ''));
      }
    })
    .catch(error => {
      alert('{{ _("Error generating report:") }} ' + error.message);
    })
    .finally(() => {
      // Re-enable the button
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-file-earmark-text"></i> {{ _("Generate Report") }}';
      isGenerating = false; // Reset the flag
    });
  };
}

// Save Report Button
var saveReportBtn = document.getElementById('saveReportBtn');
if (saveReportBtn) {
  saveReportBtn.onclick = function() {
    const reportContent = document.getElementById('reportContent').value;
    const reviewModal = bootstrap.Modal.getInstance(document.getElementById('reportReviewModal'));
    
    // Disable the button and show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Saving...") }}';
    
    fetch(`/api/patient/{{ patient.id }}/save-report`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        content: reportContent
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        reviewModal.hide();
        alert('{{ _("Report saved successfully.") }}');
        window.location.reload();
      } else {
        alert('{{ _("Error saving report:") }} ' + (data.message || ''));
      }
    })
    .catch(error => {
      alert('{{ _("Error saving report:") }} ' + error.message);
    })
    .finally(() => {
      // Re-enable the button
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-check-circle"></i> {{ _("Save Report") }}';
    });
  };
}

// Generate Exercise Button Event Listener
var generateExerciseBtn = document.getElementById('generateExerciseBtn');
if (generateExerciseBtn) {
  generateExerciseBtn.addEventListener('click', function() {
    // Show the language selection modal instead of generating directly
    const languageModal = new bootstrap.Modal(document.getElementById('exerciseLanguageSelectionModal'));
    languageModal.show();
  });
}

// Handle the generate exercise button in the modal
var generateExerciseWithLanguageBtn = document.getElementById('generateExerciseWithLanguage');
if (generateExerciseWithLanguageBtn) {
  generateExerciseWithLanguageBtn.onclick = function() {
    const selectedLanguage = document.querySelector('input[name="exerciseLanguage"]:checked').value;
    const languageModal = bootstrap.Modal.getInstance(document.getElementById('exerciseLanguageSelectionModal'));
    
    // Disable the button and show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Generating...") }}';
    
    fetch(`/api/patient/{{ patient.id }}/generate-exercise-prescription`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        language: selectedLanguage
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        languageModal.hide();
        alert('{{ _("Exercise prescription generated successfully.") }}');
        window.location.reload();
      } else {
        alert('{{ _("Error generating exercises:") }} ' + (data.message || ''));
      }
    })
    .catch(error => {
      alert('{{ _("Error generating exercises:") }} ' + error.message);
    })
    .finally(() => {
      // Re-enable the button
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-clipboard-heart"></i> {{ _("Generate Exercise Homework") }}';
    });
  };
}

// Generate Clinical Analysis Button Event Listener
var generateAnalysisBtn = document.getElementById('generateAnalysisBtn');
if (generateAnalysisBtn) {
  generateAnalysisBtn.addEventListener('click', function() {
    const confirmModal = new bootstrap.Modal(document.getElementById('clinicalAnalysisConfirmModal'));
    confirmModal.show();
  });
}

var regenerateAnalysisBtn = document.getElementById('regenerateAnalysisBtn');
if (regenerateAnalysisBtn) {
  regenerateAnalysisBtn.addEventListener('click', function() {
    const confirmModal = new bootstrap.Modal(document.getElementById('clinicalAnalysisConfirmModal'));
    confirmModal.show();
  });
}

// Confirm Clinical Analysis Generation
var confirmClinicalAnalysis = document.getElementById('confirmClinicalAnalysis');
if (confirmClinicalAnalysis) {
  confirmClinicalAnalysis.onclick = function() {
    const confirmModal = bootstrap.Modal.getInstance(document.getElementById('clinicalAnalysisConfirmModal'));
    
    // Disable the button and show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Generating...") }}';
    
    fetch(`/api/patient/{{ patient.id }}/generate-clinical-analysis`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        confirmModal.hide();
        alert('{{ _("Clinical analysis generated successfully.") }}');
        window.location.reload();
      } else {
        alert('{{ _("Error generating clinical analysis:") }} ' + (data.message || data.error || ''));
      }
    })
    .catch(error => {
      alert('{{ _("Error generating clinical analysis:") }} ' + error.message);
    })
    .finally(() => {
      // Re-enable the button
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-robot"></i> {{ _("Generate Analysis") }}';
    });
  };
}

// Handle the generate clinical analysis button in the AI Analysis tab
var generateClinicalAnalysisBtn = document.getElementById('generateClinicalAnalysisBtn');
if (generateClinicalAnalysisBtn) {
  generateClinicalAnalysisBtn.addEventListener('click', function() {
    const confirmModal = new bootstrap.Modal(document.getElementById('clinicalAnalysisConfirmModal'));
    confirmModal.show();
  });
}

// Handle treatment cancellation
let currentTreatmentToCancel = null;

// Add event listeners to all cancel treatment buttons
document.addEventListener('click', function(e) {
  if (e.target.closest('.cancel-treatment-btn')) {
    const btn = e.target.closest('.cancel-treatment-btn');
    const treatmentId = btn.getAttribute('data-treatment-id');
    const treatmentType = btn.getAttribute('data-treatment-type');
    
    // Store the treatment ID for later use
    currentTreatmentToCancel = treatmentId;
    
    // Update modal content
    document.getElementById('cancel-treatment-type').textContent = treatmentType;
    document.getElementById('cancellation-reason').value = '';
    
    // Show the modal
    const cancelModal = new bootstrap.Modal(document.getElementById('cancelTreatmentModal'));
    cancelModal.show();
  }
});

// Handle confirm cancellation button
var confirmCancelTreatmentBtn = document.getElementById('confirmCancelTreatment');
if (confirmCancelTreatmentBtn) {
  confirmCancelTreatmentBtn.onclick = function() {
    if (!currentTreatmentToCancel) return;
    
    const reason = document.getElementById('cancellation-reason').value.trim();
    const cancelModal = bootstrap.Modal.getInstance(document.getElementById('cancelTreatmentModal'));
    
    // Disable the button and show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Cancelling...") }}';
    
    fetch(`/api/treatment/${currentTreatmentToCancel}/cancel`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        reason: reason || 'No reason provided'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        cancelModal.hide();
        
        // Update the treatment row status
        const statusBadge = document.querySelector(`#treatment-row-${currentTreatmentToCancel} .status-badge`);
        if (statusBadge) {
          statusBadge.className = 'badge bg-danger status-badge';
          statusBadge.textContent = '{{ _("Cancelled") }}';
        }
        
        // Hide the cancel button for this treatment
        const cancelBtn = document.querySelector(`[data-treatment-id="${currentTreatmentToCancel}"]`);
        if (cancelBtn) {
          cancelBtn.style.display = 'none';
        }
        
        // Update patient statistics
        loadPatientStatistics();
        
        alert('{{ _("Appointment cancelled successfully.") }}');
      } else {
        alert('{{ _("Error cancelling appointment:") }} ' + (data.error || ''));
      }
    })
    .catch(error => {
      alert('{{ _("Error cancelling appointment:") }} ' + error.message);
    })
    .finally(() => {
      // Re-enable the button
      this.disabled = false;
      this.innerHTML = '<i class="bi bi-check-circle"></i> {{ _("Cancel Appointment") }}';
      currentTreatmentToCancel = null;
    });
  };
}

// Other patient detail functionality (consent, reports, etc.)
// ... simplified version of existing code ...

// Patient AI Chat functionality
let currentPatientId = null;
let currentPatientName = null;
let patientChatHistory = [];

let currentLanguage = 'es'; // Default language

function openPatientAIChat(patientId, patientName) {
    currentPatientId = patientId;
    currentPatientName = patientName;
    
    document.getElementById('patientNameHeader').textContent = patientName;
    
    // Clear previous messages and show welcome
    resetChatInterface();
    
    // Load conversation history
    loadPatientChatHistory(patientId);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('patientAIChatModal'));
    modal.show();
}

function resetChatInterface() {
    const chatMessages = document.getElementById('patient-chat-messages');
    chatMessages.innerHTML = `
        <div class="text-center py-5">
            <div class="welcome-message" style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 600px; margin: 0 auto;">
                <div class="mb-3">
                    <img src="{{ url_for('static', filename='images/brain.png') }}" alt="The Brain" style="width: 48px; height: 48px; object-fit: contain;">
                </div>
                <h6 style="color: #2c3e50; font-weight: 600;">The Brain</h6>
                <p class="text-muted mb-0">Pregúntame sobre condiciones, contraindicaciones, progreso del tratamiento o cualquier consideración clínica.</p>
            </div>
        </div>
    `;
}

function setLanguage(lang) {
    currentLanguage = lang;
    const indicators = {
        'es': '🇪🇸 Español (detectado automáticamente)',
        'en': '🇺🇸 English (auto-detected)',
        'fr': '🇫🇷 Français (détecté automatiquement)',
        'it': '🇮🇹 Italiano (rilevato automaticamente)',
        'de': '🇩🇪 Deutsch (automatisch erkannt)',
        'pt': '🇵🇹 Português (detectado automaticamente)'
    };
    document.getElementById('language-indicator').textContent = indicators[lang] || indicators['es'];
}

function loadPatientChatHistory(patientId) {
    fetch(`/api/patient/${patientId}/ai-chat/history`)
    .then(response => response.json())
    .then(data => {
        if (data.history && data.history.length > 0) {
            // Remove welcome message
            const chatMessages = document.getElementById('patient-chat-messages');
            chatMessages.innerHTML = `<div style="padding: 1rem 0;"></div>`;
            
            patientChatHistory = data.history;
            
            data.history.forEach(msg => {
                addPatientMessageToChat(msg.type, msg.message, false, new Date(msg.timestamp));
            });
        }
    })
    .catch(error => {
        console.error('Error loading chat history:', error);
    });
}

function sendPatientMessage() {
    const input = document.getElementById('patient-chat-input');
    const message = input.value.trim();
    
    if (!message || !currentPatientId) return;
    
    // Clear welcome message if it's the first message
    const welcomeMessage = document.querySelector('.welcome-message');
    if (welcomeMessage) {
        const chatMessages = document.getElementById('patient-chat-messages');
        chatMessages.innerHTML = `<div style="padding: 1rem 0;"></div>`;
    }
    
    // Add user message to chat
    addPatientMessageToChat('user', message, false);
    input.value = '';
    
    // Use current language or let AI detect
    const language = currentLanguage;
    
    // Show typing indicator
    addPatientTypingIndicator();
    
    // Send to API
    fetch(`/api/patient/${currentPatientId}/ai-chat`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                          document.querySelector('input[name="csrf_token"]')?.value
        },
        body: JSON.stringify({
            message: message,
            language: language
        })
    })
    .then(response => response.json())
    .then(data => {
        removePatientTypingIndicator();
        if (data.response) {
            addPatientMessageToChat('ai', data.response, true);
            
            // Update language indicator if auto-detected
            if (data.language_detected) {
                currentLanguage = data.language_detected;
                setLanguage(data.language_detected);
            }
            
            // Show medical information extraction if found
            if (data.medical_info_extracted) {
                showMedicalInfoExtracted(data.medical_info_extracted);
            }
        } else {
            let errorMessage = 'Error: No se pudo obtener respuesta del AI';
            if (data.error) {
                if (data.error.includes('temporarily unavailable') || data.error.includes('temporalmente')) {
                    errorMessage = '⚠️ El servicio de IA está temporalmente no disponible. Por favor, inténtalo de nuevo en unos momentos.';
                } else {
                    errorMessage = `❌ ${data.error}`;
                }
            }
            addPatientMessageToChat('error', errorMessage);
        }
    })
    .catch(error => {
        removePatientTypingIndicator();
        console.error('Error:', error);
        addPatientMessageToChat('error', '🔌 Error de conexión. Verifica tu conexión a internet e inténtalo de nuevo.');
    });
}

function addPatientMessageToChat(type, message, canSave = false, timestamp = null) {
    const chatMessages = document.getElementById('patient-chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-4 patient-chat-message-${type}`;
    
    const timeStr = timestamp ? timestamp.toLocaleTimeString() : new Date().toLocaleTimeString();
    
    if (type === 'user') {
        // User message - right aligned, blue bubble
        messageDiv.innerHTML = `
            <div class="d-flex justify-content-end">
                <div style="max-width: 80%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 5px 20px; padding: 1rem 1.5rem; box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);">
                    <div class="chat-message-content">${formatPatientMessage(message)}</div>
                    <div class="mt-2 text-end">
                        <small style="opacity: 0.8; font-size: 0.75rem;">${timeStr}</small>
                    </div>
                </div>
            </div>
        `;
    } else if (type === 'ai') {
        // AI message - left aligned, white bubble with avatar
        const saveButton = canSave ? `
            <div class="mt-3 pt-2" style="border-top: 1px solid #eee;">
                <button class="btn btn-sm btn-outline-primary" onclick="savePatientNote('${encodeURIComponent(message)}')" style="border-radius: 15px;">
                    <i class="bi bi-save me-1"></i> Añadir a Anamnesis
                </button>
            </div>
        ` : '';
        
        messageDiv.innerHTML = `
            <div class="d-flex justify-content-start">
                <div class="me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <img src="{{ url_for('static', filename='images/brain.png') }}" alt="The Brain" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <div style="max-width: 80%; background: white; border-radius: 20px 20px 20px 5px; padding: 1.5rem; box-shadow: 0 2px 15px rgba(0,0,0,0.1);">
                    <div class="chat-message-content">${formatPatientMessage(message)}</div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted" style="font-size: 0.75rem;">${timeStr}</small>
                    </div>
                    ${saveButton}
                </div>
            </div>
        `;
    } else {
        // Error message
        messageDiv.innerHTML = `
            <div class="d-flex justify-content-center">
                <div style="background: #ff6b6b; color: white; border-radius: 15px; padding: 1rem; max-width: 80%;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    
    if (timestamp === null) {
        patientChatHistory.push({type, message, timestamp: new Date().toISOString()});
    }
    
    // Scroll to bottom with smooth animation
    const chatContainer = document.getElementById('patient-chat-container');
    chatContainer.scrollTo({
        top: chatContainer.scrollHeight,
        behavior: 'smooth'
    });
}

function formatPatientMessage(message) {
    return message
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n- /g, '<br>• ')
        .replace(/\n/g, '<br>')
        .replace(/^(.*)$/, '<p>$1</p>')
        .replace(/<p><\/p>/g, '');
}

function addPatientTypingIndicator() {
    const chatMessages = document.getElementById('patient-chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'patient-typing-indicator';
    typingDiv.className = 'mb-4';
    typingDiv.innerHTML = `
        <div class="d-flex justify-content-start">
            <div class="me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <img src="{{ url_for('static', filename='images/brain.png') }}" alt="The Brain" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
            <div style="background: white; border-radius: 20px 20px 20px 5px; padding: 1.5rem; box-shadow: 0 2px 15px rgba(0,0,0,0.1); max-width: 200px;">
                <div class="d-flex align-items-center">
                    <div class="typing-dots me-3">
                        <span></span><span></span><span></span>
                    </div>
                    <small class="text-muted">Analizando...</small>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(typingDiv);
    
    const chatContainer = document.getElementById('patient-chat-container');
    chatContainer.scrollTo({
        top: chatContainer.scrollHeight,
        behavior: 'smooth'
    });
}

function removePatientTypingIndicator() {
    const typingIndicator = document.getElementById('patient-typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function clearPatientChat() {
    if (!currentPatientId) return;
    
    if (confirm(`Clear all AI conversation history for ${currentPatientName}?`)) {
        fetch(`/api/patient/${currentPatientId}/ai-chat/clear`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                              document.querySelector('input[name="csrf_token"]')?.value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('patient-chat-messages').innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>The Brain for ${currentPatientName}</strong><br>
                        Ask me about this patient's condition, contraindications, treatment progress, or any clinical considerations.
                    </div>
                `;
                patientChatHistory = [];
                alert('Chat history cleared successfully!');
            } else {
                alert('Error: ' + (data.error || 'Failed to clear chat history'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to clear chat history');
        });
    }
}

function exportPatientChat() {
    if (patientChatHistory.length === 0) {
        alert('No chat history to export');
        return;
    }
    
    let exportText = `The Brain Chat for ${currentPatientName} - ${new Date().toLocaleDateString()}\n`;
    exportText += '=' .repeat(80) + '\n\n';
    
    patientChatHistory.forEach(msg => {
        const timestamp = new Date(msg.timestamp).toLocaleString();
        const sender = msg.type === 'user' ? 'You' : 'The Brain';
        exportText += `[${timestamp}] ${sender}:\n${msg.message}\n\n`;
    });
    
    const blob = new Blob([exportText], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `the-brain-chat-${currentPatientName.replace(/[^a-zA-Z0-9]/g, '_')}-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function savePatientNote(message) {
    if (!currentPatientId) {
        alert('No patient selected');
        return;
    }
    
    const noteContent = decodeURIComponent(message);
    
    fetch('/api/save-clinical-note', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                          document.querySelector('input[name="csrf_token"]')?.value
        },
        body: JSON.stringify({
            note_content: noteContent,
            patient_id: currentPatientId,
            note_type: 'patient_specific'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Note saved to patient record successfully!');
        } else {
            alert('Error saving note: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save note');
    });
}

function showMedicalInfoExtracted(medicalInfo) {
    const chatMessages = document.getElementById('patient-chat-messages');
    const infoDiv = document.createElement('div');
    infoDiv.className = 'mb-4 medical-info-alert';
    
    let infoItems = [];
    
    if (medicalInfo.conditions && medicalInfo.conditions.length > 0) {
        infoItems.push(`<strong>Condiciones:</strong> ${medicalInfo.conditions.join(', ')}`);
    }
    
    if (medicalInfo.medications && medicalInfo.medications.length > 0) {
        infoItems.push(`<strong>Medicamentos:</strong> ${medicalInfo.medications.join(', ')}`);
    }
    
    if (medicalInfo.allergies && medicalInfo.allergies.length > 0) {
        infoItems.push(`<strong>Alergias:</strong> ${medicalInfo.allergies.join(', ')}`);
    }
    
    if (medicalInfo.symptoms && medicalInfo.symptoms.length > 0) {
        infoItems.push(`<strong>Síntomas:</strong> ${medicalInfo.symptoms.join(', ')}`);
    }
    
    if (infoItems.length > 0) {
        infoDiv.innerHTML = `
            <div class="d-flex justify-content-center">
                <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 2px solid #f39c12; border-radius: 20px; padding: 1.5rem; max-width: 90%; box-shadow: 0 4px 15px rgba(243, 156, 18, 0.2);">
                    <div class="text-center mb-3">
                        <i class="bi bi-exclamation-triangle-fill" style="color: #856404; font-size: 24px;"></i>
                        <h6 style="color: #856404; font-weight: 600; margin-top: 0.5rem;">Información Médica Detectada</h6>
                    </div>
                    
                    <div style="color: #856404; margin-bottom: 1.5rem;">
                        ${infoItems.map(item => `<p class="mb-2">${item}</p>`).join('')}
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-warning btn-sm me-2" onclick="updatePatientMedicalInfo(${JSON.stringify(medicalInfo).replace(/"/g, '&quot;')})" style="border-radius: 15px;">
                            <i class="bi bi-plus-circle me-1"></i> Añadir a la Anamnesis
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="dismissMedicalInfo(this)" style="border-radius: 15px;">
                            <i class="bi bi-x me-1"></i> Ignorar
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        chatMessages.appendChild(infoDiv);
        
        // Scroll to bottom
        const chatContainer = document.getElementById('patient-chat-container');
        chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
        });
    }
}

function updatePatientMedicalInfo(medicalInfo) {
    if (!currentPatientId) {
        alert('No patient selected');
        return;
    }
    
    const confirmation = confirm(
        '¿Estás seguro de que quieres añadir esta información médica a la anamnesis del paciente?\n\n' +
        'Esta acción actualizará permanentemente la historia clínica del paciente.'
    );
    
    if (!confirmation) return;
    
    fetch(`/api/patient/${currentPatientId}/ai-chat/update-medical-info`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                          document.querySelector('input[name="csrf_token"]')?.value
        },
        body: JSON.stringify({
            medical_info: medicalInfo,
            confirmed: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ Información médica añadida a la anamnesis del paciente exitosamente!');
            // Remove the medical info alert
            const alertElements = document.querySelectorAll('.medical-info-alert');
            alertElements.forEach(el => el.remove());
        } else {
            alert('Error: ' + (data.message || 'No se pudo actualizar la información médica'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar la información médica');
    });
}

function dismissMedicalInfo(button) {
    const alertDiv = button.closest('.medical-info-alert');
    if (alertDiv) {
        alertDiv.remove();
    }
}

function closeClinicalHistoryAlert() {
    const alertDiv = document.getElementById('clinical-history-permanent-warning');
    if (alertDiv) {
        alertDiv.style.display = 'none';
    }
}

// Add CSS for typing indicator
if (!document.getElementById('typing-dots-css')) {
    const style = document.createElement('style');
    style.id = 'typing-dots-css';
    style.textContent = `
    .typing-dots {
        display: inline-block;
        position: relative;
        width: 50px;
        height: 10px;
        margin-right: 10px;
    }

    .typing-dots span {
        position: absolute;
        top: 0;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #1e3a8a;
        animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-dots span:nth-child(1) {
        left: 0;
        animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
        left: 12px;
        animation-delay: -0.16s;
    }

    .typing-dots span:nth-child(3) {
        left: 24px;
    }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }

    .chat-message-content p:last-child {
        margin-bottom: 0;
    }
    `;
    document.head.appendChild(style);
}
</script>

<!-- Include ICD-10 and Pathology Guide JavaScript -->
<script src="{{ url_for('static', filename='js/icd10_diagnosis.js') }}"></script>
<script src="{{ url_for('static', filename='js/pathology_guide.js') }}"></script>

<!-- Patient AI Chat Modal - Redesigned Minimal Interface -->
<div class="modal fade" id="patientAIChatModal" tabindex="-1" aria-labelledby="patientAIChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content" style="border: none; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
            <!-- Minimal Header -->
            <div class="modal-header border-0" style="padding: 1.5rem 2rem 0.5rem 2rem;">
                <div class="d-flex align-items-center">
                    <div class="ai-avatar me-3" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                        <img src="{{ url_for('static', filename='images/brain.png') }}" alt="The Brain" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <div>
                        <h5 class="mb-0" style="font-weight: 600; color: #2c3e50;">The Brain</h5>
                        <small class="text-muted" id="patientNameHeader"></small>
                    </div>
                </div>
                
                <!-- Minimal Control Buttons -->
                <div class="d-flex align-items-center gap-2">
                    <!-- Language Button -->
                    <div class="dropdown">
                        <button class="btn btn-link p-2 text-muted" type="button" data-bs-toggle="dropdown" title="Language">
                            <i class="bi bi-translate" style="font-size: 18px;"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('es')">🇪🇸 Español</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('en')">🇺🇸 English</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('fr')">🇫🇷 Français</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('it')">🇮🇹 Italiano</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('de')">🇩🇪 Deutsch</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setLanguage('pt')">🇵🇹 Português</a></li>
                        </ul>
                    </div>
                    
                    <!-- Settings Button -->
                    <div class="dropdown">
                        <button class="btn btn-link p-2 text-muted" type="button" data-bs-toggle="dropdown" title="Settings">
                            <i class="bi bi-three-dots" style="font-size: 18px;"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="clearPatientChat()">
                                <i class="bi bi-trash me-2"></i>Clear History
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportPatientChat()">
                                <i class="bi bi-download me-2"></i>Export Chat
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-muted" href="#">
                                <i class="bi bi-info-circle me-2"></i>AI has full patient context
                            </a></li>
                        </ul>
                    </div>
                    
                    <!-- Close Button -->
                    <button type="button" class="btn btn-link p-2 text-muted" data-bs-dismiss="modal" title="Close">
                        <i class="bi bi-x-lg" style="font-size: 18px;"></i>
                    </button>
                </div>
            </div>
            
            <!-- Full Screen Chat Area -->
            <div class="modal-body p-0" style="height: 70vh;">
                <!-- Chat Messages Container -->
                <div id="patient-chat-container" style="height: calc(100% - 100px); padding: 0 2rem; overflow-y: auto; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
                    <div id="patient-chat-messages" style="padding: 1rem 0;">
                        <!-- Welcome Message -->
                        <div class="text-center py-5">
                            <div class="welcome-message" style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 600px; margin: 0 auto;">
                                <div class="mb-3">
                                    <img src="{{ url_for('static', filename='images/brain.png') }}" alt="The Brain" style="width: 48px; height: 48px; object-fit: contain;">
                                </div>
                                <h6 style="color: #2c3e50; font-weight: 600;">The Brain</h6>
                                <p class="text-muted mb-0">Pregúntame sobre condiciones, contraindicaciones, progreso del tratamiento o cualquier consideración clínica.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div style="padding: 1rem 2rem 2rem 2rem; background: white; border-top: 1px solid #eee;">
                    <div class="input-group" style="border-radius: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: none;">
                        <input type="text" id="patient-chat-input" class="form-control" 
                               placeholder="Escribe tu pregunta aquí..." 
                               onkeypress="if(event.key==='Enter') sendPatientMessage()"
                               style="border: none; border-radius: 25px 0 0 25px; padding: 1rem 1.5rem; font-size: 16px; box-shadow: none;">
                        <button class="btn" type="button" onclick="sendPatientMessage()" 
                                style="border: none; border-radius: 0 25px 25px 0; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 1rem 1.5rem;">
                            <i class="bi bi-send-fill" style="font-size: 16px;"></i>
                        </button>
                    </div>
                    
                    <!-- Language Indicator -->
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <span id="language-indicator">🇪🇸 Detectando idioma automáticamente</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include ICD-10 Diagnosis Modal -->
{% include 'components/icd10_diagnosis_modal.html' %}

<!-- Include Pathology Guide Modal -->
{% include 'components/pathology_guide_modal.html' %}

{% endblock %}