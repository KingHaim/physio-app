{% extends "base.html" %}

{% block title %}{{ _('Analytics') }}{% endblock %}

{% block content %}
<!-- Hidden translation elements for JavaScript -->
<div id="no-revenue-data-text" style="display: none;">{{ _('No patient revenue data available.') }}</div>
<div id="error-loading-data-text" style="display: none;">{{ _('Error loading data.') }}</div>
<div id="no-practice-report-text" style="display: none;">{{ _('No practice report generated yet. Click "Generate New Report" to create one.') }}</div>

<div class="container-fluid py-4">
    <h1 class="h3 mb-4"><i class="bi bi-graph-up"></i> {{ _('Practice Analytics') }}</h1>
    
    <!-- KEY METRICS CARDS (Always Visible) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm stats-card">
                <div class="card-body">
                    <h5 class="card-title">{{ _('Total Patients') }}</h5>
                    <h2 class="display-4">{{ total_patients }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm stats-card">
                <div class="card-body">
                    <h5 class="card-title">{{ _('Active Patients') }}</h5>
                    <h2 class="display-4">{{ active_patients }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm stats-card">
                <div class="card-body">
                    <h5 class="card-title">{{ _('Total Treatments') }}</h5>
                    <h2 class="display-4">{{ total_treatments }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm stats-card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">{{ _('Avg. Monthly Revenue') }}</h5>
                    <h2 class="display-4">€{{ "{:,.2f}".format(avg_monthly_revenue or 0) }}</h2>
                </div>
            </div>
        </div>
                </div>

    <!-- ANALYTICS SECTIONS WITH DROPDOWNS -->
    
    <!-- 1. PRACTICE OVERVIEW SECTION -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none fw-bold d-flex align-items-center justify-content-between w-100" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#practiceOverview" 
                        aria-expanded="true" aria-controls="practiceOverview">
                    <span><i class="bi bi-activity me-2"></i>{{ _('Practice Overview') }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
            </h5>
        </div>
        <div id="practiceOverview" class="collapse show">
                <div class="card-body">
                <div class="row">
                    <!-- Key Practice Metrics -->
                    <div class="col-md-4 mb-3">
                        <div class="card stats-card">
                <div class="card-body">
                                <h6 class="card-title">{{ _('Avg. Treatments/Patient') }}</h6>
                                <h3 class="display-6">{{ avg_treatments }}</h3>
                </div>
            </div>
        </div>
                    <div class="col-md-4 mb-3" id="inactive-patients-box" style="cursor: pointer;" title="{{ _('Click to see list') }}">
                        <div class="card stats-card bg-warning text-white">
                <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-person-dash"></i> {{ _('Inactive Patients') }} (>90d)</h6>
                                <h3 class="display-6"><span id="inactive-patients-count">...</span></h3>
                </div>
            </div>
        </div>
                    <div class="col-md-4 mb-3">
                        <div class="card stats-card bg-danger text-white">
                <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-percent"></i> {{ _('Avg. Cancellation Rate') }}</h6>
                                <h3 class="display-6"><span id="avg-cancellation-rate">...</span>%</h3>
                </div>
            </div>
        </div>
                </div>
                <!-- Core Charts: Treatments and Patients Trends -->
                <div class="row">
        <div class="col-lg-6 mb-4" id="treatmentsChartCard">
                        <div class="card h-100">
                <div class="card-header">
                                <h6 class="card-title mb-0">{{ _('Treatments by Month') }}</h6>
                </div>
                            <div class="card-body">
                                <canvas id="treatmentsChart" style="max-height: 300px;"></canvas>
                    <p class="text-center text-muted d-none no-data-message">{{ _('No data available to display.') }}</p>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4" id="patientsChartCard">
                        <div class="card h-100">
                <div class="card-header">
                                <h6 class="card-title mb-0">{{ _('New Patients by Month') }}</h6>
                </div>
                            <div class="card-body">
                                <canvas id="patientsChart" style="max-height: 300px;"></canvas>
                    <p class="text-center text-muted d-none no-data-message">{{ _('No data available to display.') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. REVENUE ANALYSIS SECTION -->
    <div class="card shadow-sm mb-4">
                <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none fw-bold d-flex align-items-center justify-content-between w-100" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#revenueAnalysis" 
                        aria-expanded="false" aria-controls="revenueAnalysis">
                    <span><i class="bi bi-currency-pound me-2"></i>{{ _('Revenue Analysis') }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
            </h5>
                </div>
        <div id="revenueAnalysis" class="collapse">
            <div class="card-body">
                <div class="row mb-4">
                    <!-- Revenue Cards -->
                    <div class="col-md-12 mb-3" id="costaspineFeeCard" style="cursor: pointer;">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body">
                                <h6 class="card-title">{{ clinic_name }} {{ _('Fee (This Week)') }}</h6>
                                <h3 class="display-6">€{{ "{:,.2f}".format(costaspine_service_fee_weekly or 0) }}</h3>
                                <small class="text-light">{{ _('Total Weekly') }} {{ clinic_name }} {{ _('Revenue:') }} €{{ "{:,.2f}".format(costaspine_revenue_weekly_data or 0) }}</small>
                </div>
            </div>
        </div>
                    <!-- COMMENTED OUT: Autónomo Contribution Card - Not needed for now
                    <div class="col-md-6 mb-3">
                        <div class="card stats-card bg-secondary text-white">
                            <div class="card-body">
                                <h6 class="card-title">{{ _('Est. Total Autónomo Contr.') }} (€)</h6>
                                <h3 class="display-6">
                                    {% if total_autonomo_contribution == "N/A" %}
                                        {{ total_autonomo_contribution }}
                                    {% else %}
                                        €{{ "{:,.2f}".format(total_autonomo_contribution or 0) }}
                                    {% endif %}
                                </h3>
                                <small class="text-muted-white">{{ _('Sum of estimated monthly contributions') }} (€)</small>
                </div>
            </div>
        </div>
                    -->
                </div>
                <!-- Revenue Charts -->
                <div class="row">
                    <div class="col-lg-6 mb-4" id="revenueByVisitTypeChartCard">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">{{ _('Revenue by Visit Type') }}</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="revenueByVisitTypeChart" style="max-height: 300px;"></canvas>
                    <p class="text-center text-muted d-none no-data-message">{{ _('No data available to display.') }}</p>
                </div>
            </div>
        </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                <div class="card-header">
                                <h6 class="card-title mb-0"><i class="bi bi-trophy"></i> {{ _('Top Patients by Revenue') }}</h6>
                </div>
                            <div class="card-body">
                                <ol id="topPatientsList" class="list-group list-group-numbered list-group-flush">
                                    <li class="list-group-item">{{ _('Loading...') }}</li>
                                </ol>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. PATIENT INSIGHTS SECTION -->
    <div class="card shadow-sm mb-4">
                <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none fw-bold d-flex align-items-center justify-content-between w-100" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#patientInsights" 
                        aria-expanded="false" aria-controls="patientInsights">
                    <span><i class="bi bi-people me-2"></i>{{ _('Patient Insights') }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
            </h5>
        </div>
        <div id="patientInsights" class="collapse">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6 mb-4" id="diagnosesChartCard"> 
                        <div class="card h-100">
                <div class="card-header">
                                <h6 class="card-title mb-0">{{ _('Common Diagnoses') }}</h6>
                </div>
                            <div class="card-body">
                                <canvas id="diagnosesChart" style="max-height: 300px;"></canvas>
                                <p class="text-center text-muted d-none no-data-message">{{ _('No data available to display.') }}</p>
                </div>
            </div>
        </div>
                    <div class="col-lg-6 mb-4" id="statusChartCard">
                        <div class="card h-100">
                <div class="card-header">
                                <h6 class="card-title mb-0">{{ _('Patient Status Distribution') }}</h6>
                </div>
                <div class="card-body">
                                <canvas id="statusChart" style="max-height: 300px;"></canvas>
                                <p class="text-center text-muted d-none no-data-message">{{ _('No data available to display.') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. REFERRAL ANALYSIS SECTION -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none fw-bold d-flex align-items-center justify-content-between w-100" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#referralAnalysis" 
                        aria-expanded="false" aria-controls="referralAnalysis">
                    <span><i class="bi bi-diagram-3 me-2"></i>{{ _('Referral Analysis') }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
            </h5>
        </div>
        <div id="referralAnalysis" class="collapse">
            <div class="card-body">
                <!-- Referral Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card bg-info text-white">
                            <div class="card-body">
                                <h6 class="card-title">{{ _('Referral Rate') }}</h6>
                                <h3 class="display-6"><span id="referral-rate">...</span>%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card bg-success text-white">
                            <div class="card-body">
                                <h6 class="card-title">{{ _('Patient Referrals') }}</h6>
                                <h3 class="display-6"><span id="patient-referrals-count">...</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card bg-warning text-white">
                            <div class="card-body">
                                <h6 class="card-title">{{ _('External Referrals') }}</h6>
                                <h3 class="display-6"><span id="external-referrals-count">...</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card bg-primary text-white">
                            <div class="card-body">
                                <h6 class="card-title">{{ _('Total Referred') }}</h6>
                                <h3 class="display-6"><span id="total-referred-count">...</span></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Referral Tree Visualization -->
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0">{{ _('Referral Network') }}</h6>
                            </div>
                            <div class="card-body">
                                <div id="referral-tree-container" style="height: 400px; border: 1px solid #dee2e6; border-radius: 4px;">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">{{ _('Loading...') }}</span>
                                            </div>
                                            <p class="mt-2 text-muted">{{ _('Loading referral network...') }}</p>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-center text-muted d-none no-data-message">{{ _('No referral data available to display.') }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="card-title mb-0"><i class="bi bi-award"></i> {{ _('Top Referrers') }}</h6>
                            </div>
                            <div class="card-body">
                                <div id="top-referrers-container">
                                    <h6 class="text-muted">{{ _('Patient Referrers') }}</h6>
                                    <ol id="top-patient-referrers-list" class="list-group list-group-numbered list-group-flush mb-3">
                                        <li class="list-group-item">{{ _('Loading...') }}</li>
                                    </ol>
                                    
                                    <h6 class="text-muted">{{ _('External Referrers') }}</h6>
                                    <ol id="top-external-referrers-list" class="list-group list-group-numbered list-group-flush">
                                        <li class="list-group-item">{{ _('Loading...') }}</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. AI INSIGHTS SECTION -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <button class="btn btn-link text-decoration-none fw-bold d-flex align-items-center justify-content-between w-100" 
                        type="button" data-bs-toggle="collapse" data-bs-target="#aiInsights" 
                        aria-expanded="false" aria-controls="aiInsights">
                    <span><i class="bi bi-robot me-2"></i>{{ _('AI Practice Insights') }}</span>
                    <i class="bi bi-chevron-down"></i>
                </button>
            </h5>
        </div>
        <div id="aiInsights" class="collapse">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div></div>
                    <form action="{{ url_for('main.generate_new_analytics_report') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-arrow-clockwise"></i> {{ _('Generate New Report') }}
                        </button>
                    </form>
                </div>
                
                    {% if ai_report_html %}
                    <div class="ai-report-container">
                        {% if ai_report_generated_at %}
                            <div class="text-muted mb-3">
                                <small>
                                    <i class="bi bi-clock"></i>
                                    {{ _('Report generated on:') }} {{ ai_report_generated_at.strftime('%Y-%m-%d %H:%M:%S') }} UTC
                                </small>
                                <br>
                                <small>
                                    <i class="bi bi-robot"></i>
                                    {{ _('Using DeepSeek AI based on current practice data.') }}
                                </small>
                            </div>
                        {% endif %}
                        <div class="ai-report-content">
                            {{ ai_report_html|safe }}
                        </div>
                </div>
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="bi bi-robot"></i>
                        <p>{{ _('No practice report generated yet. Click "Generate New Report" to create one.') }}</p>
                    </div>
                    {% endif %}
            </div>
        </div>
    </div>

</div>

<!-- REMOVED SECTIONS (commented for reference):
     - Cancellations by Month chart (redundant with cancellation rate metric)
     - Cancellation Rate by Month chart (replaced with single metric)
     - Revenue by Location chart (less useful for single practitioner)
     - Payment Method Distribution (administrative detail, not strategic)
     - Monthly Cancellations card (consolidated into overview)
-->

<!-- Fee Breakdown Modal (preserved) -->
<div class="modal fade" id="costaspineFeeModal" tabindex="-1" aria-labelledby="costaspineFeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
                <h5 class="modal-title" id="costaspineFeeModalLabel"><i class="bi bi-calculator"></i> {{ clinic_name }} {{ _('Fee Breakdown') }} ({{ clinic_percentage }}%)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
                <p>{{ _("Total fee calculated based on treatments logged at") }} '{{ clinic_name }}' {{ _("location with a fee.") }}</p>
                <table class="table table-sm">
          <tbody>
            <tr>
              <th>{{ _('Total (All Time):') }}</th>
              <td><span id="feeTotal">{{ _('Loading...') }}</span></td>
            </tr>
            <tr>
              <th>{{ _('This Year:') }}</th>
              <td><span id="feeYear">{{ _('Loading...') }}</span></td>
            </tr>
            <tr>
              <th>{{ _('This Month:') }}</th>
              <td><span id="feeMonth">{{ _('Loading...') }}</span></td>
            </tr>
            <tr>
              <th>{{ _('This Week:') }}</th>
              <td><span id="feeWeek">{{ _('Loading...') }}</span></td>
            </tr>
          </tbody>
        </table>
        <small class="text-muted">{{ _('Calculations are based on treatment dates.') }}</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Inactive Patients Modal (preserved) -->
<div class="modal fade" id="inactivePatientsModal" tabindex="-1" aria-labelledby="inactivePatientsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
                <h5 class="modal-title" id="inactivePatientsModalLabel"><i class="bi bi-person-dash"></i> {{ _('Inactive Patients') }} (>90d)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p>{{ _("The following active patients have not had a treatment logged in the last 90 days.") }}</p>
                <div id="inactivePatientsList">
                    <!-- Content will be populated by JavaScript -->
                </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart configuration with fixed sizing
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

// Global color schemes
    const chartColors = [
        'rgba(52, 152, 219, 0.7)', 'rgba(46, 204, 113, 0.7)', 'rgba(155, 89, 182, 0.7)', 
        'rgba(241, 196, 15, 0.7)', 'rgba(230, 126, 34, 0.7)', 'rgba(231, 76, 60, 0.7)',  
        'rgba(52, 73, 94, 0.7)',   'rgba(26, 188, 156, 0.7)', 'rgba(149, 165, 166, 0.7)', 
        'rgba(41, 128, 185, 0.7)' 
    ];
    const chartBorderColors = chartColors.map(color => color.replace('0.7', '1'));
    const chartBackgroundColors = chartColors.map(color => color.replace('0.7', '0.2'));

// Chart storage for cleanup
const activeCharts = {};

// Utility function to fetch chart data
    async function fetchChartData(url) {
        try {
        console.log(`Fetching data from: ${url}`);
            const response = await fetch(url);
            if (!response.ok) {
            console.error(`Error fetching ${url}: ${response.status} ${response.statusText}`);
                return null;
            }
        const data = await response.json();
        console.log(`Data received from ${url}:`, data);
        return data;
        } catch (error) {
            console.error(`Error fetching chart data from ${url}:`, error);
        return null;
        }
    }

// Utility function to render or update charts with proper cleanup
    function renderOrUpdateChart(canvasId, cardId, apiData, chartConfigBuilderFn) {
        const canvas = document.getElementById(canvasId);
        const card = document.getElementById(cardId);
        const noDataMessageEl = card ? card.querySelector('.no-data-message') : null;

        if (!canvas || !card || !noDataMessageEl) {
            console.error(`Elements not found for chart: ${canvasId}, card: ${cardId}`);
        if (card) card.style.display = 'none';
            return;
        }

    // Destroy existing chart to prevent growing issue
    if (activeCharts[canvasId]) {
        activeCharts[canvasId].destroy();
        delete activeCharts[canvasId];
    }

    if (apiData === null) {
            console.error(`No API data for ${canvasId}. Hiding card.`);
            card.style.display = 'none';
            return;
        }

        const chartConfig = chartConfigBuilderFn(apiData);

    // Check if data is empty
        if (chartConfig && chartConfig.data && chartConfig.data.datasets && chartConfig.data.datasets.length > 0) {
        const hasData = chartConfig.data.datasets.some(dataset => {
            if (!dataset.data || dataset.data.length === 0) return false;
            return dataset.data.some(value => value !== null && value !== undefined && value !== 0);
        });

        if (!hasData) {
            canvas.style.display = 'none';
            noDataMessageEl.classList.remove('d-none');
            return;
            }
        } else {
        canvas.style.display = 'none';
        noDataMessageEl.classList.remove('d-none');
        return;
    }

    // Show chart, hide no-data message
    canvas.style.display = 'block';
    noDataMessageEl.classList.add('d-none');

    // Create new chart with responsive config
    const ctx = canvas.getContext('2d');
    activeCharts[canvasId] = new Chart(ctx, {
        ...chartConfig,
        options: {
            ...chartConfig.options,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                ...chartConfig.options?.plugins,
                legend: {
                    ...chartConfig.options?.plugins?.legend,
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// Chart configuration builders
function buildTreatmentsChart(data) {
    return {
            type: 'line',
            data: {
                labels: data.map(item => item.month),
                datasets: [{
                label: '{{ _("Treatments") }}',
                    data: data.map(item => item.count),
                borderColor: chartBorderColors[0],
                    backgroundColor: chartBackgroundColors[0],
                    fill: true,
                tension: 0.4
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    };
}

function buildPatientsChart(data) {
    return {
            type: 'line',
            data: {
                labels: data.map(item => item.month),
                datasets: [{
                label: '{{ _("New Patients") }}',
                    data: data.map(item => item.count),
                borderColor: chartBorderColors[1],
                    backgroundColor: chartBackgroundColors[1],
                    fill: true,
                tension: 0.4
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    };
}

function buildRevenueByVisitTypeChart(data) {
    return {
            type: 'doughnut',
            data: {
            labels: data.map(item => item.treatment_type || 'Unknown'),
                datasets: [{
                    data: data.map(item => item.total_fee),
                backgroundColor: chartColors.slice(0, data.length),
                borderColor: chartBorderColors.slice(0, data.length),
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    };
}

function buildDiagnosesChart(data) {
    return {
            type: 'bar',
            data: {
            labels: data.map(item => item.diagnosis),
                datasets: [{
                label: '{{ _("Frequency") }}',
                data: data.map(item => item.count),
                backgroundColor: chartColors.slice(0, data.length),
                borderColor: chartBorderColors.slice(0, data.length),
                    borderWidth: 1
                }]
            },
        options: {
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                legend: { display: false }
            }
        }
    };
}

function buildStatusChart(data) {
            return {
                type: 'pie',
                data: {
            labels: data.map(item => item.status),
                datasets: [{
                    data: data.map(item => item.count),
                backgroundColor: chartColors.slice(0, data.length),
                borderColor: chartBorderColors.slice(0, data.length),
                borderWidth: 2
                }]
            },
            options: {
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    };
}

// Load chart data only when sections are expanded
document.addEventListener('DOMContentLoaded', function() {
    // Load overview charts immediately (practice overview is expanded by default)
    loadPracticeOverviewCharts();
    
    // Load other data when sections are expanded
    const revenueCollapse = document.getElementById('revenueAnalysis');
    const patientCollapse = document.getElementById('patientInsights');
    
    revenueCollapse.addEventListener('shown.bs.collapse', loadRevenueAnalysisCharts);
    patientCollapse.addEventListener('shown.bs.collapse', loadPatientInsightsCharts);
    
    const referralCollapse = document.getElementById('referralAnalysis');
    referralCollapse.addEventListener('shown.bs.collapse', loadReferralAnalysisData);
    
    // Load other data
    loadInactivePatientsCount();
    loadCancellationData();
    loadTopPatients();
});

async function loadPracticeOverviewCharts() {
    // Treatments by month
    const treatmentsData = await fetchChartData('/api/analytics/treatments-by-month');
    renderOrUpdateChart('treatmentsChart', 'treatmentsChartCard', treatmentsData, buildTreatmentsChart);
    
    // Patients by month
    const patientsData = await fetchChartData('/api/analytics/patients-by-month');
    renderOrUpdateChart('patientsChart', 'patientsChartCard', patientsData, buildPatientsChart);
}

async function loadRevenueAnalysisCharts() {
    // Revenue by visit type
    const revenueData = await fetchChartData('/api/analytics/revenue-by-visit-type');
    console.log('Revenue by visit type data:', revenueData);
    renderOrUpdateChart('revenueByVisitTypeChart', 'revenueByVisitTypeChartCard', revenueData, buildRevenueByVisitTypeChart);
}

async function loadPatientInsightsCharts() {
    // Common diagnoses
    const diagnosesData = await fetchChartData('/api/analytics/common-diagnoses');
    renderOrUpdateChart('diagnosesChart', 'diagnosesChartCard', diagnosesData, buildDiagnosesChart);
    
    // Patient status
    const statusData = await fetchChartData('/api/analytics/patient-status');
    renderOrUpdateChart('statusChart', 'statusChartCard', statusData, buildStatusChart);
}

async function loadReferralAnalysisData() {
    try {
        const response = await fetch('/api/analytics/referral-tree');
        const data = await response.json();
        
        if (response.ok) {
            // Update statistics cards
            const stats = data.statistics;
            document.getElementById('referral-rate').textContent = stats.referral_rate || '0.0';
            document.getElementById('patient-referrals-count').textContent = stats.patient_referrals || '0';
            document.getElementById('external-referrals-count').textContent = stats.external_referrals || '0';
            document.getElementById('total-referred-count').textContent = stats.referred_patients || '0';
            
            // Update top referrers lists
            updateTopReferrersList('top-patient-referrers-list', stats.top_patient_referrers);
            updateTopReferrersList('top-external-referrers-list', stats.top_external_referrers);
            
            // Render referral tree visualization
            renderReferralTree(data.nodes, data.edges);
        } else {
            console.error('Error loading referral data:', data.error);
            showReferralError('Error loading referral data');
        }
    } catch (error) {
        console.error('Error fetching referral data:', error);
        showReferralError('Error loading referral data');
    }
}

function updateTopReferrersList(listId, referrers) {
    const listElement = document.getElementById(listId);
    if (referrers && referrers.length > 0) {
        listElement.innerHTML = referrers.map(referrer => 
            `<li class="list-group-item d-flex justify-content-between align-items-center">
                ${referrer.name}
                <span class="badge bg-primary rounded-pill">${referrer.referrals_count}</span>
            </li>`
        ).join('');
    } else {
        listElement.innerHTML = '<li class="list-group-item text-muted">{{ _("No referrers found") }}</li>';
    }
}

function renderReferralTree(nodes, edges) {
    const container = document.getElementById('referral-tree-container');
    
    if (!nodes || nodes.length === 0) {
        showReferralError('No referral data available');
        return;
    }
    
    // Clear loading content
    container.innerHTML = '';
    
    // Build a proper tree structure
    const tree = buildTreeStructure(nodes, edges);
    
    // Create SVG for better tree visualization
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.style.width = '100%';
    svg.style.height = '100%';
    svg.style.background = '#f8f9fa';
    
    // Calculate tree layout
    const layout = calculateTreeLayout(tree);
    
    // Draw edges first (so they appear behind nodes)
    drawEdges(svg, layout.edges);
    
    // Draw nodes
    drawNodes(svg, layout.nodes);
    
    // Add legend
    addTreeLegend(container);
    
    container.appendChild(svg);
}

function showReferralError(message) {
    const container = document.getElementById('referral-tree-container');
    container.innerHTML = `<div class="d-flex justify-content-center align-items-center h-100">
                              <div class="text-center text-muted">
                                  <i class="bi bi-exclamation-circle"></i>
                                  <p class="mt-2">${message}</p>
                              </div>
                           </div>`;
}

function buildTreeStructure(nodes, edges) {
    // Create a map of nodes by ID
    const nodeMap = new Map();
    nodes.forEach(node => nodeMap.set(node.id, {...node, children: []}));
    
    // Find root nodes (nodes with no incoming edges)
    const rootNodes = [];
    const hasParent = new Set();
    
    edges.forEach(edge => {
        hasParent.add(edge.to);
        const parent = nodeMap.get(edge.from);
        const child = nodeMap.get(edge.to);
        if (parent && child) {
            parent.children.push(child);
        }
    });
    
    // Collect all root nodes
    nodes.forEach(node => {
        if (!hasParent.has(node.id)) {
            rootNodes.push(nodeMap.get(node.id));
        }
    });
    
    return { roots: rootNodes, nodeMap };
}

function calculateTreeLayout(tree) {
    const nodeWidth = 120;
    const nodeHeight = 40;
    const levelHeight = 80;
    const nodeSpacing = 20;
    
    const layoutNodes = [];
    const layoutEdges = [];
    
    // Calculate positions for each root tree
    let currentX = 50;
    
    tree.roots.forEach(root => {
        const treeWidth = calculateSubtreeWidth(root, nodeWidth, nodeSpacing);
        const startX = currentX + treeWidth / 2;
        
        layoutSubtree(root, startX, 30, 0, nodeWidth, nodeHeight, levelHeight, nodeSpacing, layoutNodes, layoutEdges);
        
        currentX += treeWidth + 100; // Space between separate trees
    });
    
    return { nodes: layoutNodes, edges: layoutEdges };
}

function calculateSubtreeWidth(node, nodeWidth, nodeSpacing) {
    if (node.children.length === 0) {
        return nodeWidth;
    }
    
    let totalWidth = 0;
    node.children.forEach(child => {
        totalWidth += calculateSubtreeWidth(child, nodeWidth, nodeSpacing);
    });
    
    return Math.max(nodeWidth, totalWidth + (node.children.length - 1) * nodeSpacing);
}

function layoutSubtree(node, x, y, level, nodeWidth, nodeHeight, levelHeight, nodeSpacing, layoutNodes, layoutEdges) {
    // Add current node to layout
    const layoutNode = {
        ...node,
        x: x - nodeWidth / 2,
        y: y,
        width: nodeWidth,
        height: nodeHeight,
        centerX: x,
        centerY: y + nodeHeight / 2
    };
    layoutNodes.push(layoutNode);
    
    // Layout children
    if (node.children.length > 0) {
        const totalChildWidth = node.children.reduce((sum, child) => 
            sum + calculateSubtreeWidth(child, nodeWidth, nodeSpacing), 0
        );
        const totalSpacing = (node.children.length - 1) * nodeSpacing;
        const childrenStartX = x - (totalChildWidth + totalSpacing) / 2;
        
        let currentChildX = childrenStartX;
        
        node.children.forEach(child => {
            const childWidth = calculateSubtreeWidth(child, nodeWidth, nodeSpacing);
            const childCenterX = currentChildX + childWidth / 2;
            const childY = y + levelHeight;
            
            // Add edge from parent to child
            layoutEdges.push({
                x1: x,
                y1: y + nodeHeight,
                x2: childCenterX,
                y2: childY,
                from: node.id,
                to: child.id
            });
            
            // Recursively layout child subtree
            layoutSubtree(child, childCenterX, childY, level + 1, nodeWidth, nodeHeight, levelHeight, nodeSpacing, layoutNodes, layoutEdges);
            
            currentChildX += childWidth + nodeSpacing;
        });
    }
}

function drawEdges(svg, edges) {
    edges.forEach(edge => {
        // Create curved line for better aesthetics
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const midY = (edge.y1 + edge.y2) / 2;
        const pathData = `M ${edge.x1} ${edge.y1} Q ${edge.x1} ${midY} ${(edge.x1 + edge.x2) / 2} ${midY} Q ${edge.x2} ${midY} ${edge.x2} ${edge.y2}`;
        
        line.setAttribute('d', pathData);
        line.setAttribute('stroke', '#6c757d');
        line.setAttribute('stroke-width', '2');
        line.setAttribute('fill', 'none');
        line.setAttribute('opacity', '0.7');
        
        svg.appendChild(line);
    });
}

function drawNodes(svg, nodes) {
    nodes.forEach(node => {
        // Create group for node
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        
        // Node background
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', node.x);
        rect.setAttribute('y', node.y);
        rect.setAttribute('width', node.width);
        rect.setAttribute('height', node.height);
        rect.setAttribute('rx', '8');
        
        // Color based on node type and referral status
        let fillColor = '#007bff'; // Default patient color
        if (node.type === 'external') {
            fillColor = '#6c757d';
        } else if (node.children && node.children.length > 0) {
            fillColor = '#28a745'; // Active referrer
        }
        
        rect.setAttribute('fill', fillColor);
        rect.setAttribute('stroke', '#fff');
        rect.setAttribute('stroke-width', '2');
        
        // Node text
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', node.centerX);
        text.setAttribute('y', node.centerY + 5);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'white');
        text.setAttribute('font-size', '12px');
        text.setAttribute('font-weight', 'bold');
        
        // Truncate long names
        let displayName = node.name;
        if (displayName.length > 15) {
            displayName = displayName.substring(0, 12) + '...';
        }
        text.textContent = displayName;
        
        // Add referral count badge if applicable
        if (node.children && node.children.length > 0) {
            const badge = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            badge.setAttribute('cx', node.x + node.width - 8);
            badge.setAttribute('cy', node.y + 8);
            badge.setAttribute('r', '8');
            badge.setAttribute('fill', '#ffc107');
            badge.setAttribute('stroke', '#fff');
            badge.setAttribute('stroke-width', '1');
            
            const badgeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            badgeText.setAttribute('x', node.x + node.width - 8);
            badgeText.setAttribute('y', node.y + 12);
            badgeText.setAttribute('text-anchor', 'middle');
            badgeText.setAttribute('fill', '#000');
            badgeText.setAttribute('font-size', '10px');
            badgeText.setAttribute('font-weight', 'bold');
            badgeText.textContent = node.children.length;
            
            group.appendChild(badge);
            group.appendChild(badgeText);
        }
        
        group.appendChild(rect);
        group.appendChild(text);
        
        // Add tooltip with full name and details
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${node.name}\nType: ${node.type}\nReferrals: ${node.children ? node.children.length : 0}`;
        group.appendChild(title);
        
        svg.appendChild(group);
    });
}

function addTreeLegend(container) {
    const legend = document.createElement('div');
    legend.style.position = 'absolute';
    legend.style.bottom = '10px';
    legend.style.right = '10px';
    legend.style.background = 'rgba(255,255,255,0.95)';
    legend.style.padding = '10px';
    legend.style.borderRadius = '4px';
    legend.style.fontSize = '11px';
    legend.style.border = '1px solid #dee2e6';
    legend.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    
    legend.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">Legend</div>
        <div style="margin-bottom: 3px;"><span style="display: inline-block; width: 12px; height: 12px; background: #6c757d; margin-right: 5px; border-radius: 2px;"></span>External Referrer</div>
        <div style="margin-bottom: 3px;"><span style="display: inline-block; width: 12px; height: 12px; background: #007bff; margin-right: 5px; border-radius: 2px;"></span>Patient</div>
        <div style="margin-bottom: 3px;"><span style="display: inline-block; width: 12px; height: 12px; background: #28a745; margin-right: 5px; border-radius: 2px;"></span>Active Referrer</div>
        <div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #dee2e6; font-size: 10px; color: #6c757d;">
            Numbers show referral count
        </div>
    `;
    
    container.appendChild(legend);
}

// Load inactive patients count
async function loadInactivePatientsCount() {
    try {
        const response = await fetch('/api/analytics/recently-inactive-patients');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('inactive-patients-count').textContent = data.inactive_patients?.length || 0;
        } else {
            console.error('Error loading inactive patients:', data.error);
            document.getElementById('inactive-patients-count').textContent = '?';
        }
            } catch (error) {
        console.error('Error fetching inactive patients:', error);
        document.getElementById('inactive-patients-count').textContent = '?';
    }
}

// Load cancellation data
async function loadCancellationData() {
    try {
        const response = await fetch('/api/analytics/cancellation-rates');
        const data = await response.json();
        
        if (response.ok && data.length > 0) {
            const avgRate = data.reduce((sum, item) => sum + (item.cancellation_rate || 0), 0) / data.length;
            document.getElementById('avg-cancellation-rate').textContent = avgRate.toFixed(1);
        } else {
            document.getElementById('avg-cancellation-rate').textContent = '0.0';
        }
    } catch (error) {
        console.error('Error fetching cancellation data:', error);
        document.getElementById('avg-cancellation-rate').textContent = '?';
    }
}

// Load top patients
async function loadTopPatients() {
    try {
        const response = await fetch('/api/analytics/top-patients-by-revenue');
        const data = await response.json();
        
        console.log('Top patients response:', { ok: response.ok, status: response.status, data });
        
        const listElement = document.getElementById('topPatientsList');
        if (response.ok) {
            if (data && Array.isArray(data) && data.length > 0) {
                listElement.innerHTML = data.map((patient, index) => 
                    `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${patient.name || 'Unknown Patient'}
                        <span class="badge bg-primary rounded-pill">€${(patient.revenue || 0).toFixed(2)}</span>
                    </li>`
                ).join('');
            } else {
                listElement.innerHTML = '<li class="list-group-item text-muted">{{ _("No revenue data available") }}</li>';
            }
        } else {
            listElement.innerHTML = `<li class="list-group-item text-danger">API Error: ${data.error || 'Unknown error'}</li>`;
        }
    } catch (error) {
        console.error('Error fetching top patients:', error);
        document.getElementById('topPatientsList').innerHTML = '<li class="list-group-item text-danger">{{ _("Error loading data") }}</li>';
    }
}

// Modal handlers
document.getElementById('costaspineFeeCard').addEventListener('click', function() {
    // Load fee data when modal is opened
    loadCostaspineFeeData();
    new bootstrap.Modal(document.getElementById('costaspineFeeModal')).show();
});

document.getElementById('inactive-patients-box').addEventListener('click', function() {
    // Load inactive patients when modal is opened
    loadInactivePatientsModal();
    new bootstrap.Modal(document.getElementById('inactivePatientsModal')).show();
});

async function loadCostaspineFeeData() {
    try {
        const response = await fetch('/api/analytics/costaspine-fee-data');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('feeTotal').textContent = `€${data.total_fee.toFixed(2)}`;
            // Note: You may need to add more specific endpoints for year/month/week breakdowns
            document.getElementById('feeYear').textContent = `€${data.total_fee.toFixed(2)}`;
            document.getElementById('feeMonth').textContent = `€${data.total_fee.toFixed(2)}`;
            document.getElementById('feeWeek').textContent = `€${data.total_fee.toFixed(2)}`;
        }
    } catch (error) {
        console.error('Error loading fee data:', error);
    }
}

async function loadInactivePatientsModal() {
    try {
        const response = await fetch('/api/analytics/recently-inactive-patients');
        const data = await response.json();
        
        const listElement = document.getElementById('inactivePatientsList');
        if (response.ok && data.inactive_patients && data.inactive_patients.length > 0) {
            listElement.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{{ _("Patient Name") }}</th>
                                <th>{{ _("Last Treatment") }}</th>
                                <th>{{ _("Days Ago") }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.inactive_patients.map(patient => `
                                <tr>
                                    <td>${patient.name}</td>
                                    <td>${patient.last_treatment_date}</td>
                                    <td>${patient.days_since_last_treatment}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
                    } else {
            listElement.innerHTML = '<p class="text-muted">{{ _("No inactive patients found.") }}</p>';
        }
    } catch (error) {
        console.error('Error loading inactive patients:', error);
        document.getElementById('inactivePatientsList').innerHTML = '<p class="text-danger">{{ _("Error loading data") }}</p>';
    }
}

// Cleanup charts on page unload
window.addEventListener('beforeunload', function() {
    Object.values(activeCharts).forEach(chart => chart.destroy());
});

</script>
{% endblock %} 