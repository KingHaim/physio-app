{% extends "base.html" %}

{% block title %}{{ patient.name }} - {{ _('Patient Details') }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Enhanced Tab Styling */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
    }

    .nav-tabs .nav-item {
        margin-bottom: -2px;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .nav-tabs .nav-link i {
        font-size: 1.1rem;
        transition: transform 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        border: none;
        background-color: rgba(41, 128, 185, 0.05);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background-color: transparent;
        border: none;
        font-weight: 600;
    }

    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary-color);
        border-radius: 3px 3px 0 0;
    }

    .nav-tabs .nav-link:hover i {
        transform: translateY(-2px);
    }

    /* Tab Content Styling */
    .tab-content {
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .tab-pane {
        padding: 1.5rem;
    }

    /* Card Styling within Tabs */
    .tab-pane .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .tab-pane .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .tab-pane .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem 1.25rem;
    }

    .tab-pane .card-header h5 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
    }

    /* Table Styling within Tabs */
    .tab-pane .table {
        margin-bottom: 0;
    }

    .tab-pane .table th {
        font-weight: 600;
        color: #2c3e50;
        border-top: none;
    }

    .tab-pane .table td {
        vertical-align: middle;
    }

    /* Badge Styling */
    .badge {
        padding: 0.5em 0.75em;
        font-weight: 500;
    }

    .badge.bg-success {
        background-color: #2ecc71 !important;
    }

    .badge.bg-secondary {
        background-color: #95a5a6 !important;
    }

    /* Anamnesis content styling */
    .anamnesis-content {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1.5rem;
        border-left: 4px solid var(--primary-color);
    }
    
    .anamnesis-text {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        font-size: 0.95rem;
        line-height: 1.6;
        background: none;
        border: none;
        padding: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    {% if not today is defined %}
        <div class="alert alert-warning">
            <strong>{{ _('Warning:') }}</strong> {{ _("The 'today' variable is not defined. Some features may not work correctly.") }}
        </div>
    {% endif %}

    <!-- Add this after the flash messages section -->
    {% if session.get('auto_completed_treatments') %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        {{ session.get('auto_completed_treatments') }} {{ _('past treatment(s) were automatically marked as completed.') }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Close') }}"></button>
    </div>
    {% endif %}

    <!-- Patient Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-3">{{ patient.name }}</h1>
            <div class="patient-info mb-3">
                <p class="mb-1"><strong>{{ _('Date of Birth:') }}</strong> {{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else _('Not provided') }}</p>
                <p class="mb-1"><strong>{{ _('Contact:') }}</strong> {{ patient.contact or _('Not provided') }}</p>
                <p class="mb-1"><strong>{{ _('Status:') }}</strong> <span class="badge bg-{{ 'primary' if patient.status == 'Active' else 'secondary' }}">{{ _(patient.status) }}</span></p>
            </div>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="d-flex flex-column flex-md-row gap-2 justify-content-md-end">
                <a href="{{ url_for('main.edit_patient', id=patient.id) }}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> {{ _('Edit Patient') }}
                </a>
                <a href="{{ url_for('main.new_treatment_page', patient_id=patient.id) }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> {{ _('Add Treatment') }}
                </a>
                <a href="{{ url_for('main.new_recurring_appointment', patient_id=patient.id) }}" class="btn btn-secondary">
                    <i class="bi bi-calendar-plus"></i> {{ _('Add Recurring') }}
                </a>
                <button id="generateReportBtn" class="btn btn-info">
                    <i class="bi bi-file-earmark-text"></i> {{ _('Generate AI Report') }}
                </button>
                <button id="generateExerciseBtn" class="btn btn-warning">
                    <i class="bi bi-clipboard-heart"></i> {{ _('Generate Exercise Homework') }}
                </button>
                <button id="generateClinicalAnalysisBtn" class="btn btn-success">
                    <i class="bi bi-robot"></i> {{ _('AI Clinical Analysis') }}
                </button>
                <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-file-text"></i> {{ _('View Latest Report') }}
                </a>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="patientTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="treatments-tab" data-bs-toggle="tab" data-bs-target="#treatments" type="button" role="tab" aria-controls="treatments" aria-selected="true">
                <i class="bi bi-clipboard-pulse"></i> {{ _('Treatments') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="anamnesis-tab" data-bs-toggle="tab" data-bs-target="#anamnesis" type="button" role="tab" aria-controls="anamnesis" aria-selected="false">
                <i class="bi bi-journal-medical"></i> {{ _('Clinical History') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="consents-tab" data-bs-toggle="tab" data-bs-target="#consents" type="button" role="tab" aria-controls="consents" aria-selected="false">
                <i class="bi bi-file-earmark-check"></i> {{ _('Consents') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                <i class="bi bi-file-text"></i> {{ _('Reports') }}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ai-analysis-tab" data-bs-toggle="tab" data-bs-target="#ai-analysis" type="button" role="tab" aria-controls="ai-analysis" aria-selected="false">
                <i class="bi bi-robot"></i> {{ _('AI Clinical Analysis') }}
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="patientTabsContent">
        <!-- Treatments Tab -->
        <div class="tab-pane fade show active" id="treatments" role="tabpanel" aria-labelledby="treatments-tab">
            <!-- Recurring Appointments Section -->
            <div class="row mb-4">
                <div class="col-md-12">
                    {% if patient.recurring_appointments %}
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar-repeat"></i> {{ _('Recurring Appointments') }}</h5>
                            <a href="{{ url_for('main.new_recurring_appointment', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle"></i> {{ _('Add Rule') }}
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="list-group">
                                {% for rule in patient.recurring_appointments %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">
                                                {{ rule.treatment_type }} 
                                                - {{ _(rule.recurrence_type|replace('-', ' ')|title) }}
                                            </h6>
                                            <small>
                                                <span class="badge bg-{{ 'success' if rule.is_active else 'secondary' }}">
                                                    {{ _('Active') if rule.is_active else _('Inactive') }}
                                                </span>
                                            </small>
                                        </div>
                                        <p class="mb-1">
                                            {{ _('Starts:') }} {{ rule.start_date.strftime('%Y-%m-%d') }} 
                                            {% if rule.end_date %} | {{ _('Ends:') }} {{ rule.end_date.strftime('%Y-%m-%d') }} {% endif %}
                                            | {{ _('Time:') }} {{ rule.time_of_day.strftime('%H:%M') }}
                                        </p>
                                        <small class="text-muted">{{ _('Location:') }} {{ rule.location or 'N/A' }} | {{ _('Fee:') }} {{ ('€' + "{:.2f}".format(rule.fee_charged)) if rule.fee_charged else 'N/A' }}</small>
                                        <div class="mt-2">
                                            <a href="{{ url_for('main.edit_recurring_appointment', id=rule.id) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i> {{ _('Edit') }}</a>
                                            <form action="{{ url_for('main.delete_recurring_appointment', id=rule.id) }}" method="POST" style="display: inline-block;" onsubmit="return confirm('{{ _('Are you sure you want to delete this recurring rule?') }}');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> {{ _('Delete') }}</button>
                                            </form>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Diagnosis and Treatment Plan -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-clipboard-pulse"></i> {{ _('Diagnosis') }}</h5>
                        </div>
                        <div class="card-body">
                            <p>{{ patient.diagnosis }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-journal-medical"></i> {{ _('Treatment Plan') }}</h5>
                        </div>
                        <div class="card-body">
                            <p>{{ patient.treatment_plan }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Treatment History Section -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> {{ _('Past Treatments') }}</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newTreatmentModal">
                                <i class="bi bi-plus-circle"></i> {{ _('Add Past Treatment') }}
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Bulk Action Controls - Moved above table -->
                            <div id="bulkActions" class="mb-3 p-3 bg-light rounded" style="display: none;"> 
                                <h6>{{ _('Bulk Actions for Selected') }} (<span id="selectedCount">0</span>):</h6>
                                <div class="row gx-2 gy-2">
                                    <div class="col-auto">
                                        <div class="btn-group btn-group-sm" role="group" aria-label="{{ _('Set Location') }}">
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="location" data-value="{{ current_user.clinic_name }}">Set Loc: {{ current_user.clinic_name }}</button>
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="location" data-value="Home Visit">{{ _('Set Loc: Home Visit') }}</button>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="btn-group btn-group-sm" role="group" aria-label="{{ _('Set Payment Method') }}">
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="payment_method" data-value="Cash">{{ _('Set Pmt: Cash') }}</button>
                                            <button type="button" class="btn btn-outline-secondary bulk-action-btn" data-field="payment_method" data-value="Card">{{ _('Set Pmt: Card') }}</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Debug information to check patient treatments are loaded -->
                            <p class="text-muted small">{{ _('Total treatments for this patient:') }} {{ treatments|length }}</p>
                            <!-- Note about past treatments -->
                            <p class="text-muted small">{{ _('Showing treatments completed on or before today') }} ({{ today.strftime('%Y-%m-%d') }})</p>
                            
                            <!-- Simple, direct treatment listing without modals -->
                            {% if treatments|length > 0 %}
                                <div class="table-responsive">
                                    <table class="table table-hover" id="treatmentsTable">
                                        <thead>
                                            <tr>
                                                <th><input class="form-check-input" type="checkbox" id="selectAllCheckbox"></th>
                                                <th>{{ _('Date') }}</th>
                                                <th>{{ _('Type') }}</th>
                                                <th>{{ _('Status') }}</th>
                                                <th>{{ _('Pain Level') }}</th>
                                                <th>{{ _('Fee (€)') }}</th>
                                                <th>{{ _('Payment') }}</th>
                                                <th>{{ _('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% set has_past_treatments = false %}
                                            {% for treatment in treatments|sort(attribute='created_at', reverse=true) %}
                                                {% if treatment.created_at and treatment.created_at <= today %}
                                                {% set has_past_treatments = true %}
                                                <tr id="treatment-row-{{ treatment.id }}">
                                                    <td><input class="form-check-input treatment-checkbox" type="checkbox" value="{{ treatment.id }}"></td>
                                                    <td>{{ treatment.created_at.strftime('%Y-%m-%d %H:%M') if treatment.created_at else 'N/A' }}</td>
                                                    <td>{{ treatment.treatment_type or 'N/A' }}</td>
                                                    <td>
                                                        <span class="badge {% if treatment.status == 'Completed' %}bg-primary{% elif treatment.status == 'Scheduled' %}bg-info text-dark{% elif treatment.status == 'Cancelled' %}bg-danger{% else %}bg-secondary{% endif %} status-badge" id="status-{{ treatment.id }}">
                                                            {{ _(treatment.status) if treatment.status else 'N/A' }}
                                                        </span>
                                                    </td>
                                                    <td>{{ treatment.pain_level if treatment.pain_level is not none else 'N/A' }}/10</td>
                                                    <td class="fee-column">
                                                        <div class="input-group input-group-sm">
                                                            <input type="number" class="form-control form-control-sm fee-input" id="fee-input-{{ treatment.id }}" value="{{ treatment.fee_charged if treatment.fee_charged is not none else '' }}" placeholder="{{ _('Fee') }}" step="0.01" style="width: 70px;">
                                                            <button class="btn btn-outline-secondary btn-sm set-fee-btn" data-treatment-id="{{ treatment.id }}" type="button" title="{{ _('Set Fee') }}">
                                                                <i class="bi bi-check-lg"></i>
                                                            </button>
                                                        </div>
                                                        <small id="fee-status-{{ treatment.id }}" class="text-muted d-block mt-1"></small>
                                                    </td>
                                                    <td class="payment-column">
                                                        <span id="payment-status-{{ treatment.id }}" class="d-block mb-1">
                                                            {% if treatment.payment_method %}
                                                                {{ _('Paid - %(method)s', method=_(treatment.payment_method)) }}
                                                            {% else %}
                                                                {{ _('Unpaid') }}
                                                            {% endif %}
                                                        </span>
                                                        {% if not treatment.payment_method %}
                                                        <div class="btn-group btn-group-sm payment-buttons" id="payment-buttons-{{ treatment.id }}">
                                                            <button class="btn btn-outline-success btn-sm set-payment-btn" data-treatment-id="{{ treatment.id }}" data-method="Cash">{{ _('Cash') }}</button>
                                                            <button class="btn btn-outline-primary btn-sm set-payment-btn" data-treatment-id="{{ treatment.id }}" data-method="Card">{{ _('Card') }}</button>
                                                        </div>
                                                        {% endif %}
                                                        <small id="payment-update-status-{{ treatment.id }}" class="text-muted d-block mt-1"></small>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <a href="{{ url_for('main.view_treatment', id=treatment.id) }}" class="btn btn-sm btn-primary">
                                                                <i class="bi bi-eye"></i> {{ _('View') }}
                                                            </a>
                                                            <a href="{{ url_for('main.edit_treatment', id=treatment.id) }}" class="btn btn-sm btn-secondary">
                                                                <i class="bi bi-pencil"></i> {{ _('Edit') }}
                                                            </a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> {{ _('No treatments found for this patient.') }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anamnesis Tab -->
        <div class="tab-pane fade" id="anamnesis" role="tabpanel" aria-labelledby="anamnesis-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-journal-medical"></i> {{ _('Clinical History') }}</h5>
                            <a href="{{ url_for('main.edit_patient', id=patient.id) }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> {{ _('Edit Anamnesis') }}
                            </a>
                        </div>
                        <div class="card-body">
                            {% if patient.anamnesis %}
                                <div class="anamnesis-content">
                                    <pre class="anamnesis-text">{{ patient.anamnesis }}</pre>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="bi bi-journal-medical text-muted" style="font-size: 3rem;"></i>
                                    <h5 class="text-muted mt-3">{{ _('No Clinical History Available') }}</h5>
                                    <p class="text-muted mb-4">{{ _('The clinical history (anamnesis) for this patient has not been completed yet.') }}</p>
                                    <a href="{{ url_for('main.edit_patient', id=patient.id) }}" class="btn btn-primary">
                                        <i class="bi bi-plus-circle"></i> {{ _('Add Clinical History') }}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Consents Tab -->
        <div class="tab-pane fade" id="consents" role="tabpanel" aria-labelledby="consents-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-check"></i> {{ _('Patient Consents') }}</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addConsentModal">
                                <i class="bi bi-plus-circle"></i> {{ _('Add New Consent') }}
                            </button>
                        </div>
                        <div class="card-body">
                            {% if patient.consents %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>{{ _('Date Given') }}</th>
                                                <th>{{ _('Purpose') }}</th>
                                                <th>{{ _('Status') }}</th>
                                                <th>{{ _('Expiry Date') }}</th>
                                                <th>{{ _('Actions') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for consent in patient.consents|sort(attribute='given_at', reverse=true) %}
                                            <tr id="consent-row-{{ consent.id }}">
                                                <td>{{ consent.given_at.strftime('%Y-%m-%d') }}</td>
                                                <td>{{ consent.purpose }}</td>
                                                <td>
                                                    {% if consent.is_active %}
                                                        <span class="badge bg-success">{{ _('Active') }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ _('Expired') }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ consent.expires_at.strftime('%Y-%m-%d') if consent.expires_at else _('N/A') }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-danger delete-consent-btn" data-consent-id="{{ consent.id }}">
                                                        <i class="bi bi-trash"></i> {{ _('Delete') }}
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#consentModal{{ consent.id }}">
                                                        <i class="bi bi-eye"></i> {{ _('View Details') }}
                                                    </button>
                                                    {% if consent.is_active %}
                                                    <button type="button" class="btn btn-sm btn-warning" onclick="revokeConsent('{{ consent.id }}')">
                                                        <i class="bi bi-x-circle"></i> {{ _('Revoke') }}
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>

                                            <!-- Consent Details Modal -->
                                            <div class="modal fade" id="consentModal{{ consent.id }}" tabindex="-1" aria-labelledby="consentModalLabel{{ consent.id }}" aria-hidden="true">
                                                <div class="modal-dialog modal-lg">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="consentModalLabel{{ consent.id }}">{{ _('Consent Details') }}</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <dl class="row">
                                                                <dt class="col-sm-3">{{ _('Purpose') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.purpose }}</dd>

                                                                <dt class="col-sm-3">{{ _('Given At') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.given_at.strftime('%Y-%m-%d %H:%M') }}</dd>

                                                                <dt class="col-sm-3">{{ _('Expires At') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.expires_at.strftime('%Y-%m-%d %H:%M') if consent.expires_at else _('N/A') }}</dd>

                                                                <dt class="col-sm-3">{{ _('Status') }}</dt>
                                                                <dd class="col-sm-9">
                                                                    {% if consent.is_active %}
                                                                        <span class="badge bg-success">{{ _('Active') }}</span>
                                                                    {% else %}
                                                                        <span class="badge bg-secondary">{{ _('Expired') }}</span>
                                                                    {% endif %}
                                                                </dd>

                                                                <dt class="col-sm-3">{{ _('Notes') }}</dt>
                                                                <dd class="col-sm-9">{{ consent.notes or _('No additional notes') }}</dd>
                                                            </dl>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
                                                            {% if consent.is_active %}
                                                            <button type="button" class="btn btn-warning" onclick="revokeConsent('{{ consent.id }}')">{{ _('Revoke Consent') }}</button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">{{ _('No consent records found for this patient.') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-file-text"></i> {{ _('Reports') }}</h5>
                            <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye"></i> {{ _('View All Reports') }}
                            </a>
                        </div>
                        <div class="card-body">
                            {% if patient.reports %}
                                <div class="list-group">
                                    {% for report in patient.reports|sort(attribute='generated_date', reverse=true) %}
                                        <a href="{{ url_for('main.patient_reports_list', patient_id=patient.id) }}?report_id={{ report.id }}" 
                                           class="list-group-item list-group-item-action">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ _(report.report_type) }}</h6>
                                                <small>{{ report.generated_date.strftime('%Y-%m-%d %H:%M') }}</small>
                                            </div>
                                            <small>{{ _('Click to view this report') }}</small>
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">{{ _('No reports generated yet.') }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Tab -->
        <div class="tab-pane fade" id="ai-analysis" role="tabpanel" aria-labelledby="ai-analysis-tab">
            <div class="row">
                <div class="col-md-12">
                    <div class="card" style="border: 2px solid #28a745;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-robot"></i> ANÁLISIS CLÍNICO AI - VERSIÓN SIMPLE</h5>
                            {% if patient.ai_analysis_date %}
                                <small>Último análisis: {{ patient.ai_analysis_date.strftime('%Y-%m-%d %H:%M') }}</small>
                            {% endif %}
                        </div>
                        <div class="card-body" style="background-color: #f8f9fa;">
                            
                            <!-- MOSTRAR SI HAY DATOS -->
                            {% if patient.ai_analysis_date %}
                                <div class="alert alert-success mb-4">
                                    <h6><i class="bi bi-check-circle"></i> Análisis generado el: {{ patient.ai_analysis_date.strftime('%Y-%m-%d %H:%M') }}</h6>
                                </div>
                                
                                <!-- TESTS SUGERIDOS -->
                                {% if patient.ai_suggested_tests %}
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> TESTS RECOMENDADOS</h6>
                                    </div>
                                    <div class="card-body">
                                        <div style="white-space: pre-wrap; font-family: monospace; background: #e9ecef; padding: 15px; border-radius: 5px;">{{ patient.ai_suggested_tests }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- BANDERAS ROJAS -->
                                {% if patient.ai_red_flags %}
                                <div class="card mb-3">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> BANDERAS ROJAS</h6>
                                    </div>
                                    <div class="card-body">
                                        <div style="white-space: pre-wrap; font-family: monospace; background: #f8d7da; padding: 15px; border-radius: 5px;">{{ patient.ai_red_flags }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- BANDERAS AMARILLAS -->
                                {% if patient.ai_yellow_flags %}
                                <div class="card mb-3">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="bi bi-exclamation-circle-fill"></i> BANDERAS AMARILLAS</h6>
                                    </div>
                                    <div class="card-body">
                                        <div style="white-space: pre-wrap; font-family: monospace; background: #fff3cd; padding: 15px; border-radius: 5px;">{{ patient.ai_yellow_flags }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- NOTAS CLÍNICAS -->
                                {% if patient.ai_clinical_notes %}
                                <div class="card mb-3">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0"><i class="bi bi-journal-medical"></i> NOTAS CLÍNICAS</h6>
                                    </div>
                                    <div class="card-body">
                                        <div style="white-space: pre-wrap; font-family: monospace; background: #e2e3e5; padding: 15px; border-radius: 5px;">{{ patient.ai_clinical_notes }}</div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="text-center mt-4">
                                    <a href="/patient/{{ patient.id }}" class="btn btn-success btn-lg">
                                        <i class="bi bi-arrow-clockwise"></i> REGENERAR ANÁLISIS
                                    </a>
                                </div>
                                
                            {% else %}
                                <!-- NO HAY DATOS -->
                                <div class="text-center py-5">
                                    <div class="alert alert-warning">
                                        <h4><i class="bi bi-robot text-muted" style="font-size: 3rem;"></i></h4>
                                        <h5 class="text-muted mt-3">NO HAY ANÁLISIS AI DISPONIBLE</h5>
                                        <p class="text-muted mb-4">Genera un análisis clínico AI basado en los datos de anamnesis y historial de tratamientos del paciente.</p>
                                    </div>
                                    <a href="/patient/{{ patient.id }}" class="btn btn-success btn-lg">
                                        <i class="bi bi-robot"></i> GENERAR ANÁLISIS AI
                                    </a>
                                </div>
                            {% endif %}
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Treatment Detail Modal -->
<div class="modal fade" id="treatmentDetailModal" tabindex="-1" aria-labelledby="treatmentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="treatmentDetailModalLabel">{{ _('Treatment Details') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>{{ _('Date:') }}</strong> <span id="treatmentDate"></span></p>
                        <p><strong>{{ _('Description:') }}</strong> <span id="treatmentDescription"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{{ _('Pain Level:') }}</strong> <span id="treatmentPainLevel"></span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>{{ _('Progress Notes') }}</h6>
                        <div class="p-3 bg-light rounded">
                            <p id="treatmentNotes" class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="editTreatmentBtn" href="#" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> {{ _('Edit Treatment') }}
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- New Treatment Modal -->
<div class="modal fade" id="newTreatmentModal" tabindex="-1" aria-labelledby="newTreatmentModalLabel" aria-hidden="true" data-is-first-visit="{{ is_first_visit|tojson|safe }}">
    <!-- Modal content here -->
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newTreatmentModalLabel">{{ _('Add Treatment') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
            </div>
            <div class="modal-body">
                <form id="treatmentForm">
                    <div class="mb-3">
                        <label for="treatment_type" class="form-label">{{ _('Description') }}</label>
                        <input type="text" class="form-control" id="treatment_type" name="treatment_type">
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">{{ _('Date') }}</label>
                        <input type="hidden" id="date" name="date">
                    </div>
                    <div class="mb-3">
                        <label for="pain_level" class="form-label">{{ _('Pain Level (0-10)') }}</label>
                        <input type="number" class="form-control" id="pain_level" name="pain_level" min="0" max="10">
                        <small class="text-muted">{{ _('Optional: Leave blank if not applicable') }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="movement_restriction" class="form-label">{{ _('Movement Restriction') }}</label>
                        <textarea class="form-control" id="movement_restriction" name="movement_restriction" rows="3"></textarea>
                    </div>
                    
                    <!-- Body Chart Section -->
                    <div class="mb-3">
                        <label class="form-label">{{ _('Body Chart') }}</label>
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">{{ _('Add Trigger Points') }}</h6>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-danger active" data-point-type="active">{{ _('Active') }}</button>
                                        <button type="button" class="btn btn-outline-warning" data-point-type="latent">{{ _('Latent') }}</button>
                                        <button type="button" class="btn btn-outline-info" data-point-type="satellite">{{ _('Satellite') }}</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="body-map-container">
                                    <img src="{{ url_for('static', filename='images/bodychart.svg') }}" class="body-map" id="bodyMapImageAdd" alt="Body chart">
                                    <svg class="body-map-overlay" id="bodyMapOverlayAdd" viewBox="0 0 500 800" xmlns="http://www.w3.org/2000/svg">
                                        <g id="addTriggerPoints"></g>
                                    </svg>
                                </div>
                                <div class="text-muted small mt-2">{{ _('Click on the body map to add trigger points') }}</div>
                                
                                <!-- Trigger Points Table -->
                                <div class="mt-3">
                                    <h6>{{ _('Trigger Points') }}</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>{{ _('Type') }}</th>
                                                    <th>{{ _('Muscle') }}</th>
                                                    <th>{{ _('Intensity') }}</th>
                                                    <th>{{ _('Actions') }}</th>
                                                </tr>
                                            </thead>
                                            <tbody id="addPointsTableBody">
                                                <!-- Trigger points will be added here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden input to store trigger points data -->
                    <input type="hidden" id="addTriggerPointsData" name="trigger_points_data" value="[]">
                    
                    <div class="mb-3">
                        <label for="assessment" class="form-label">{{ _('Assessment') }}</label>
                        <textarea class="form-control" id="assessment" name="assessment" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">{{ _('Progress Notes') }}</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">{{ _('Status') }}</label>
                        <select class="form-select" id="status" name="status">
                            <option value="" disabled selected>{{ _('Select status') }}</option>
                            <option value="Scheduled">{{ _('Scheduled') }}</option>
                            <option value="In Progress">{{ _('In Progress') }}</option>
                            <option value="Completed">{{ _('Completed') }}</option>
                            <option value="Cancelled">{{ _('Cancelled') }}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="treatment_type" class="form-label">{{ _('Treatment Type') }}</label>
                        <input type="text" class="form-control" id="treatment_type" name="treatment_type" required>
                    </div>
                    <div class="mb-3">
                        <label for="provider" class="form-label">{{ _('Provider') }}</label>
                        <input type="text" class="form-control" id="provider" name="provider">
                    </div>

                    {# ADDED Hidden fields for pre-filled data #}
                    <input type="hidden" id="location" name="location">
                    <input type="hidden" id="visit_type" name="visit_type">
                    <input type="hidden" id="fee_charged" name="fee_charged">
                    {# Payment method is generally set after, so no hidden field needed here #}
                    
                    <!-- Calendly Integration Section -->
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Calendly Integration</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <strong>Note:</strong> Your appointment can be booked through Calendly scheduling.
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="syncWithCalendly" name="sync_with_calendly" value="true">
                                    <label class="form-check-label" for="syncWithCalendly">
                                        <strong>Enable Calendly scheduling for this appointment</strong>
                                    </label>
                                </div>
                                
                                <!-- Calendly options that appear when checkbox is checked -->
                                <div id="calendlyOptions" class="mt-3" style="display: none;">
                                    <div class="mb-3">
                                        <label for="calendlyEventType" class="form-label">Event Type</label>
                                        <select class="form-select" id="calendlyEventType" name="calendly_event_type">
                                            <option value="" selected>Select Calendly event type</option>
                                            <option value="initial-consultation">Initial Consultation (30 min)</option>
                                            <option value="follow-up">Follow-up Session (45 min)</option>
                                            <option value="therapy-session">Therapy Session (60 min)</option>
                                        </select>
                                        <small class="text-muted">Select the appropriate event type from your Calendly account</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="calendlyLocation" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="calendlyLocation" name="calendly_location" placeholder="e.g. Office, Video Call">
                                        <small class="text-muted">Where will this appointment take place?</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="calendlyAppointmentDate" class="form-label">Preferred Date (Optional)</label>
                                        <input type="date" class="form-control" id="calendlyAppointmentDate" name="appointment_date">
                                        <small class="text-muted">If you have a preferred date in mind, otherwise Calendly will show available slots</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">{{ _('Add Treatment') }}</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- New Exercise Prescription Modal -->
<div class="modal fade" id="exercisePrescriptionModal" tabindex="-1" aria-labelledby="exercisePrescriptionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exercisePrescriptionModalLabel">{{ _('AI Generated Exercise Prescription') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body" id="exercisePrescriptionBody">
        {# Prescription content will be loaded here #}
        <p>{{ _('Generating exercise prescription...') }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
        {# Optional: Add a print button later #}
        {# <button type="button" class="btn btn-primary" onclick="window.print();">Print</button> #}
      </div>
    </div>
  </div>
</div>

<!-- Add Consent Modal -->
<div class="modal fade" id="addConsentModal" tabindex="-1" aria-labelledby="addConsentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addConsentModalLabel">{{ _('Add Consent') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="consentTypeDropdown" class="form-label">{{ _('Consent Type') }}</label>
          <select id="consentTypeDropdown" class="form-select">
            <option value="">{{ _('Select consent type...') }}</option>
            <option value="fisioterapia_general">{{ _('C.I FISIOTERAPIA GENERAL') }}</option>
            <option value="consejeria_salud">{{ _('C.I CONSEJERÍA DE SALUD') }}</option>
            <option value="neuromodulacion">{{ _('CONSENTIMIENTO INFORMADO NEUROMODULACIÓN PERCUTÁNEA') }}</option>
            <option value="electroterapia">{{ _('C.I ELECTROTERAPIA') }}</option>
            <option value="epi">{{ _('C.I EPI') }}</option>
            <option value="puncion_seca">{{ _('C.I PUNCIÓN SECA') }}</option>
            <option value="suelo_pelvico">{{ _('C.I SUELO PÉLVICO') }}</option>
            <option value="acupuntura">{{ _('C.I ACUPUNTURA') }}</option>
            <option value="manipulaciones_articulares">{{ _('C.I MANIPULACIONES ARTICULARES') }}</option>
            <option value="masaje_terapeutico">{{ _('C.I MASAJE TERAPÉUTICO') }}</option>
            <option value="proyectos_investigacion">{{ _('C.I PROYECTOS DE INVESTIGACIÓN') }}</option>
          </select>
        </div>
        <div id="consentTextContainer" class="mt-3"></div>
        <div id="acceptSection" style="display:none;">
          <hr>
          <div class="row">
            <div class="col-md-7">
              <label class="form-label">{{ _('Signature (draw below):') }}</label>
              <div style="border:1px solid #ccc; border-radius:4px; background:#fafafa;">
                <canvas id="signaturePad" width="400" height="150" style="width:100%;max-width:400px;height:150px;"></canvas>
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-secondary btn-sm" id="clearSignatureBtn">{{ _('Clear') }}</button>
                <button type="button" class="btn btn-success btn-sm" id="saveSignatureBtn">{{ _('Accept with Signature') }}</button>
              </div>
            </div>
            <div class="col-md-5 text-center">
              <label class="form-label">{{ _('Or scan to accept on your device:') }}</label>
              <div id="qrCode" class="d-flex justify-content-center mt-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Language Selection Modal for AI Report -->
<div class="modal fade" id="languageSelectionModal" tabindex="-1" aria-labelledby="languageSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="languageSelectionModalLabel">{{ _('Select Report Language') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">{{ _('Choose the language for your AI-generated patient report:') }}</p>
        <div class="row">
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langEnglish" value="en" {% if get_locale() == 'en' %}checked{% elif not get_locale() in ['es', 'fr', 'it'] %}checked{% endif %}>
              <label class="form-check-label" for="langEnglish">
                <i class="bi bi-flag"></i> English
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langSpanish" value="es" {% if get_locale() == 'es' %}checked{% endif %}>
              <label class="form-check-label" for="langSpanish">
                <i class="bi bi-flag"></i> Español
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langFrench" value="fr" {% if get_locale() == 'fr' %}checked{% endif %}>
              <label class="form-check-label" for="langFrench">
                <i class="bi bi-flag"></i> Français
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="reportLanguage" id="langItalian" value="it" {% if get_locale() == 'it' %}checked{% endif %}>
              <label class="form-check-label" for="langItalian">
                <i class="bi bi-flag"></i> Italiano
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-primary" id="generateReportWithLanguage">
          <i class="bi bi-file-earmark-text"></i> {{ _('Generate Report') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Report Review and Edit Modal -->
<div class="modal fade" id="reportReviewModal" tabindex="-1" aria-labelledby="reportReviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportReviewModalLabel">{{ _('Review and Edit Report') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> {{ _('Please review the generated report below. You can edit the content before saving it.') }}
        </div>
        <div class="form-group">
          <label for="reportContent" class="form-label">{{ _('Report Content') }}</label>
          <textarea id="reportContent" class="form-control" rows="20" style="font-family: 'Courier New', monospace;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-primary" id="saveReportBtn">
          <i class="bi bi-check-circle"></i> {{ _('Save Report') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Language Selection Modal for Exercise Prescription -->
<div class="modal fade" id="exerciseLanguageSelectionModal" tabindex="-1" aria-labelledby="exerciseLanguageSelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exerciseLanguageSelectionModalLabel">{{ _('Select Exercise Prescription Language') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">{{ _('Choose the language for your AI-generated exercise prescription:') }}</p>
        <div class="row">
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langEnglish" value="en" {% if get_locale() == 'en' %}checked{% elif not get_locale() in ['es', 'fr', 'it'] %}checked{% endif %}>
              <label class="form-check-label" for="langEnglish">
                <i class="bi bi-flag"></i> English
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langSpanish" value="es" {% if get_locale() == 'es' %}checked{% endif %}>
              <label class="form-check-label" for="langSpanish">
                <i class="bi bi-flag"></i> Español
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langFrench" value="fr" {% if get_locale() == 'fr' %}checked{% endif %}>
              <label class="form-check-label" for="langFrench">
                <i class="bi bi-flag"></i> Français
              </label>
            </div>
          </div>
          <div class="col-6 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="exerciseLanguage" id="langItalian" value="it" {% if get_locale() == 'it' %}checked{% endif %}>
              <label class="form-check-label" for="langItalian">
                <i class="bi bi-flag"></i> Italiano
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-primary" id="generateExerciseWithLanguage">
          <i class="bi bi-clipboard-heart"></i> {{ _('Generate Exercise Homework') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Clinical Analysis Confirmation Modal -->
<div class="modal fade" id="clinicalAnalysisConfirmModal" tabindex="-1" aria-labelledby="clinicalAnalysisConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clinicalAnalysisConfirmModalLabel">
          <i class="bi bi-robot"></i> {{ _('AI Clinical Analysis') }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i>
          <strong>{{ _('AI Clinical Analysis') }}</strong>
        </div>
        <p>{{ _('This will analyze all available anamnesis data for this patient and generate:') }}</p>
        <ul>
          <li><i class="bi bi-clipboard-check"></i> {{ _('Suggested clinical tests') }}</li>
          <li><i class="bi bi-exclamation-triangle"></i> {{ _('Red flags (warning signs)') }}</li>
          <li><i class="bi bi-flag"></i> {{ _('Yellow flags (psychosocial factors)') }}</li>
          <li><i class="bi bi-journal-medical"></i> {{ _('Clinical notes and recommendations') }}</li>
        </ul>
        <p class="text-muted small">
          <i class="bi bi-shield-check"></i> 
          {{ _('All data is anonymized before being sent to the AI service.') }}
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> {{ _('Cancel') }}
        </button>
        <button type="button" class="btn btn-success" id="confirmClinicalAnalysis">
          <i class="bi bi-robot"></i> {{ _('Generate Analysis') }}
        </button>
      </div>
    </div>
  </div>
</div>

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
var csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

// Prevent duplicate script execution
if (!window.__consentScriptLoaded) {
  window.__consentScriptLoaded = true;
  let signaturePad;
  let currentConsentId = null;

  function setupSignaturePad() {
    const canvas = document.getElementById('signaturePad');
    if (!canvas) return;
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      if (signaturePad) signaturePad.clear();
    }
    resizeCanvas();
    signaturePad = new SignaturePad(canvas);
    document.getElementById('clearSignatureBtn').onclick = () => signaturePad.clear();
  }

  function setupQRCode(consentId) {
    const qrDiv = document.getElementById('qrCode');
    qrDiv.innerHTML = '';
    const lang = '{{ g.get("lang", "es") }}';
    const qrUrl = window.location.origin + '/consent/accept/' + consentId + '?lang=' + lang;
    new QRCode(qrDiv, {
      text: qrUrl,
      width: 180,
      height: 180
    });
  }

  const addConsentModal = document.getElementById('addConsentModal');
  addConsentModal.addEventListener('shown.bs.modal', function () {
    setTimeout(setupSignaturePad, 200);
  });

  document.getElementById('consentTypeDropdown').addEventListener('change', function() {
    const type = this.value;
    const lang = getCurrentLang();
    const patientId = '{{ patient.id }}';
    console.log('Consent type:', type, 'Patient ID:', patientId, 'Lang:', lang);
    if (!type || !patientId) {
      document.getElementById('consentTextContainer').innerHTML = '';
      document.getElementById('acceptSection').style.display = 'none';
      currentConsentId = null;
                return;
            }
    fetch('/api/consent/create', {
                    method: 'POST',
                    headers: {
        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
      body: JSON.stringify({
        consent_type: type,
        patient_id: parseInt(patientId, 10),
        lang: lang
      })
    })
    .then(res => {
      if (!res.ok) throw new Error('Network response was not ok');
      return res.json();
    })
                .then(data => {
                    if (data.success) {
        currentConsentId = data.consent_id;
        fetch(`/api/consent_template?type=${type}&lang=${lang}&patient_id=${patientId}`)
          .then(res => res.text())
          .then(html => {
            document.getElementById('consentTextContainer').innerHTML = html;
            document.getElementById('acceptSection').style.display = 'block';
            setTimeout(setupSignaturePad, 200);
            setupQRCode(currentConsentId);
          });
                                } else {
        alert('Error: ' + data.message);
        currentConsentId = null;
      }
    })
    .catch(err => {
      alert('Error: ' + err.message);
      currentConsentId = null;
    });
  });

  document.getElementById('saveSignatureBtn').onclick = () => {
    if (!signaturePad || signaturePad.isEmpty()) {
      alert('{{ _("Please provide a signature.") }}');
      return;
    }
    if (!currentConsentId) {
      alert('{{ _("Consent record not created.") }}');
      return;
    }
    const dataUrl = signaturePad.toDataURL();
    const patientId = '{{ patient.id }}';
    fetch('/api/consent/accept', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({
        consent_id: currentConsentId,
        patient_id: parseInt(patientId, 10),
        signature: dataUrl
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('{{ _("Consent and signature saved!") }}');
        // Optionally close modal or refresh consents list
      } else {
        alert('{{ _("Error:") }} ' + data.message);
      }
    });
  };
}

// Language instant switcher
function getCurrentLang() {
  return document.documentElement.lang || 'es';
    }

    document.addEventListener('DOMContentLoaded', function() {
  // Add a guard to prevent this script from running multiple times
  if (document.body.hasAttribute('data-patient-detail-script-loaded')) {
      return;
  }
  document.body.setAttribute('data-patient-detail-script-loaded', 'true');

  // Verify CSRF token is available
  if (!csrfToken) {
    console.error('CSRF token not found!');
            return;
        }

  document.querySelectorAll('.lang-option').forEach(function(item) {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const lang = this.getAttribute('data-lang');
      fetch(`/set_language/${lang}`)
        .then(() => {
          window.location.reload();
        });
    });
  });

  document.querySelectorAll('.delete-consent-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const consentId = this.getAttribute('data-consent-id');
      if (!confirm('Are you sure you want to delete this consent?')) return;
      
      fetch(`/api/consent/${consentId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
      .then(res => res.json())
        .then(data => {
            if (data.success) {
          const row = document.getElementById(`consent-row-${consentId}`);
          if (row) {
            row.remove();
            } else {
            console.error(`Could not find row for consent ${consentId}`);
          }
        } else {
          alert(data.message || 'Failed to delete consent.');
        }
      })
      .catch(error => {
        console.error('Error deleting consent:', error);
        alert('An error occurred while deleting the consent.');
      });
    });
  });

  let isGenerating = false; // Add a flag to prevent multiple submissions
  var generateBtn = document.getElementById('generateReportBtn');
  if (generateBtn) {
    generateBtn.addEventListener('click', function() {
      // Show the language selection modal instead of generating directly
      const languageModal = new bootstrap.Modal(document.getElementById('languageSelectionModal'));
      languageModal.show();
    });
  }

  // Handle the generate report button in the modal
  var generateReportWithLanguageBtn = document.getElementById('generateReportWithLanguage');
  if (generateReportWithLanguageBtn) {
    generateReportWithLanguageBtn.onclick = function() {
      if (isGenerating) {
        return; // Prevent multiple clicks
      }

      const selectedLanguage = document.querySelector('input[name="reportLanguage"]:checked').value;
      const languageModal = bootstrap.Modal.getInstance(document.getElementById('languageSelectionModal'));
      
      isGenerating = true; // Set the flag
      // Disable the button and show loading state
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Generating...") }}';
      
      fetch(`/api/patient/{{ patient.id }}/generate-report`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          language: selectedLanguage
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          languageModal.hide();
          // Show the review modal with the generated content
          document.getElementById('reportContent').value = data.content;
          const reviewModal = new bootstrap.Modal(document.getElementById('reportReviewModal'));
          reviewModal.show();
        } else {
          alert('{{ _("Error generating report:") }} ' + (data.message || ''));
        }
      })
      .catch(error => {
        alert('{{ _("Error generating report:") }} ' + error.message);
      })
      .finally(() => {
        // Re-enable the button and reset the flag
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-file-earmark-text"></i> {{ _("Generate Report") }}';
        isGenerating = false; 
      });
    };
  }

  // Handle the save report button in the review modal
  var saveReportBtn = document.getElementById('saveReportBtn');
  if (saveReportBtn) {
    saveReportBtn.onclick = function() {
      const reportContent = document.getElementById('reportContent').value;
      
      if (!reportContent.trim()) {
        alert('{{ _("Report content cannot be empty.") }}');
        return;
      }

      // Disable the button and show loading state
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Saving...") }}';
      
      fetch(`/api/patient/{{ patient.id }}/save-report`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          content: reportContent
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const reviewModal = bootstrap.Modal.getInstance(document.getElementById('reportReviewModal'));
          reviewModal.hide();
          alert('{{ _("Report saved successfully.") }}');
          window.location.reload();
        } else {
          alert('{{ _("Error saving report:") }} ' + (data.message || ''));
        }
      })
      .catch(error => {
        alert('{{ _("Error saving report:") }} ' + error.message);
      })
      .finally(() => {
        // Re-enable the button
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-check-circle"></i> {{ _("Save Report") }}';
      });
    };
  }

  var generateExerciseBtn = document.getElementById('generateExerciseBtn');
  if (generateExerciseBtn) {
    generateExerciseBtn.addEventListener('click', function() {
      // Show the language selection modal instead of generating directly
      const languageModal = new bootstrap.Modal(document.getElementById('exerciseLanguageSelectionModal'));
      languageModal.show();
    });
  }

  // Handle the generate exercise button in the modal
  var generateExerciseWithLanguageBtn = document.getElementById('generateExerciseWithLanguage');
  if (generateExerciseWithLanguageBtn) {
    generateExerciseWithLanguageBtn.onclick = function() {
      const selectedLanguage = document.querySelector('input[name="exerciseLanguage"]:checked').value;
      const languageModal = bootstrap.Modal.getInstance(document.getElementById('exerciseLanguageSelectionModal'));
      
      // Disable the button and show loading state
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> {{ _("Generating...") }}';
      
      fetch(`/api/patient/{{ patient.id }}/generate-exercise-prescription`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          language: selectedLanguage
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          languageModal.hide();
          alert('{{ _("Exercise prescription generated successfully.") }}');
          window.location.reload();
        } else {
          alert('{{ _("Error generating exercises:") }} ' + (data.message || ''));
        }
      })
      .catch(error => {
        alert('{{ _("Error generating exercises:") }} ' + error.message);
      })
      .finally(() => {
        // Re-enable the button
        this.disabled = false;
        this.innerHTML = '<i class="bi bi-clipboard-heart"></i> {{ _("Generate Exercise Homework") }}';
      });
    };
  }

  // NO MORE CLINICAL ANALYSIS JAVASCRIPT NEEDED
  // The new version uses simple links, no complex JavaScript required
  
});
</script>
{% endblock %}
{% endblock %} 