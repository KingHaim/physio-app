<!-- app/templates/new_patient.html -->
{% extends "base.html" %}

{% block title %}{{ _('New Patient') }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title mb-0">{{ _('New Patient') }}</h2>
                    <p class="text-muted mb-0">{{ _('Complete the anamnesis (clinical history) before proceeding to patient data') }}</p>
                </div>
                <div class="card-body">
                    <!-- Progress Steps -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="progress-steps">
                                <div class="step active" id="step1-indicator">
                                    <div class="step-number">1</div>
                                    <div class="step-title">{{ _('Anamnesis & Patient Data') }}</div>
                                </div>
                                <div class="step" id="step2-indicator">
                                    <div class="step-number">2</div>
                                    <div class="step-title">{{ _('Portal Access') }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form action="{{ url_for('main.new_patient') }}" method="POST" id="newPatientForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Step 1: Anamnesis & Patient Data -->
                        <div class="step-content active" id="step1">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>{{ _('Complete Patient Information & Clinical History') }}</strong><br>
                                {{ _('Fill in patient data and clinical history. This information is essential for proper treatment planning.') }}
                            </div>
                            
                            <!-- Anamnesis Tabs -->
                            <ul class="nav nav-tabs" id="anamnesisTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="personal-data-tab" data-bs-toggle="tab" data-bs-target="#personal-data" type="button" role="tab">
                                        <i class="bi bi-person"></i> {{ _('Patient Data') }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="chief-complaint-tab" data-bs-toggle="tab" data-bs-target="#chief-complaint" type="button" role="tab">
                                        <i class="bi bi-chat-dots"></i> {{ _('Chief Complaint') }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="medical-history-tab" data-bs-toggle="tab" data-bs-target="#medical-history" type="button" role="tab">
                                        <i class="bi bi-clipboard-heart"></i> {{ _('Medical History') }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="family-history-tab" data-bs-toggle="tab" data-bs-target="#family-history" type="button" role="tab">
                                        <i class="bi bi-people"></i> {{ _('Family History') }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="lifestyle-tab" data-bs-toggle="tab" data-bs-target="#lifestyle" type="button" role="tab">
                                        <i class="bi bi-heart-pulse"></i> {{ _('Lifestyle') }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="current-pain-tab" data-bs-toggle="tab" data-bs-target="#current-pain" type="button" role="tab">
                                        <i class="bi bi-bandaid"></i> {{ _('Current Pain') }}
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="functional-exam-tab" data-bs-toggle="tab" data-bs-target="#functional-exam" type="button" role="tab">
                                        <i class="bi bi-activity"></i> {{ _('Functional Exam') }}
                                    </button>
                                </li>
                            </ul>

                            <!-- Permanent Welcome Panel for Smart Clinical Suggestions -->
                            <div id="welcome-suggestions-panel" class="bg-success bg-opacity-10 border border-success rounded p-3 mt-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="bi bi-robot text-success fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="text-success mb-1">
                                            <i class="bi bi-lightbulb-fill"></i> {{ _('Smart Clinical Assistant Activated') }}
                                        </h6>
                                        <small class="text-muted">{{ _('I will provide intelligent clinical suggestions as you fill out the anamnesis. Look for the blue suggestions panel below.') }}</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Smart Suggestions Panel - Always Visible -->
                            <div id="suggestions-panel" class="alert alert-info mt-3" style="display: none;">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="bi bi-lightbulb-fill text-warning fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-2">
                                            <i class="bi bi-robot"></i> {{ _('Smart Clinical Suggestions') }}
                                        </h6>
                                        <div id="suggestions-content"></div>
                                    </div>
                                    <button type="button" class="btn-close" onclick="hideSuggestions()"></button>
                                </div>
                            </div>

                            <!-- Test Button (Temporary) -->
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testSuggestions()">
                                    üîµ Probar Panel de Sugerencias
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="debugPanels()">
                                    üîç Debug Paneles
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm ms-2" onclick="forceCreatePanels()">
                                    üîß Crear Paneles
                                </button>
                            </div>

                            <div class="tab-content mt-3" id="anamnesisTabContent">
                                <!-- Patient Data Tab (combining personal info + basic patient data) -->
                                <div class="tab-pane fade show active" id="personal-data" role="tabpanel">
                                    <h6 class="mb-3">{{ _('Basic Patient Information') }}</h6>
                                    
                                    <!-- Essential Patient Data -->
                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3">
                                            <label for="name" class="form-label">{{ _('Full Name') }} <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="name" name="name" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="date_of_birth" class="form-label">{{ _('Date of Birth') }} <span class="text-danger">*</span></label>
                                            <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="contact" class="form-label">{{ _('Primary Contact') }} <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="contact" name="contact" placeholder="{{ _('Phone number or email') }}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="patient_contact_email" class="form-label">{{ _('Email Address') }}</label>
                                            <input type="email" class="form-control" id="patient_contact_email" name="patient_contact_email" placeholder="patient@example.com">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="patient_contact_phone" class="form-label">{{ _('Phone Number') }}</label>
                                            <input type="tel" class="form-control" id="patient_contact_phone" name="patient_contact_phone" placeholder="+34 600 123 456">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="status" class="form-label">{{ _('Status') }}</label>
                                            <select class="form-select" id="status" name="status">
                                                <option value="Active">{{ _('Active') }}</option>
                                                <option value="Inactive">{{ _('Inactive') }}</option>
                                                <option value="Completed">{{ _('Treatment Completed') }}</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Address Information -->
                                    <h6 class="mb-3">{{ _('Address Information') }}</h6>
                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3">
                                            <label for="address_line1" class="form-label">{{ _('Address Line 1') }}</label>
                                            <input type="text" class="form-control" id="address_line1" name="address_line1" placeholder="{{ _('Street address') }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="address_line2" class="form-label">{{ _('Address Line 2') }}</label>
                                            <input type="text" class="form-control" id="address_line2" name="address_line2" placeholder="{{ _('Apartment, suite, etc.') }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="city" class="form-label">{{ _('City') }}</label>
                                            <input type="text" class="form-control" id="city" name="city">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="postcode" class="form-label">{{ _('Postal Code') }}</label>
                                            <input type="text" class="form-control" id="postcode" name="postcode">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="preferred_location" class="form-label">{{ _('Preferred Treatment Location') }}</label>
                                            <select class="form-select" id="preferred_location" name="preferred_location">
                                                <option value="">{{ _('Select location') }}</option>
                                                {% for location in current_user.locations %}
                                                <option value="{{ location.name }}">{{ location.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Medical Basic Info -->
                                    <h6 class="mb-3">{{ _('Basic Medical Information') }}</h6>
                                    <div class="row mb-4">
                                        <div class="col-md-6 mb-3">
                                            <label for="diagnosis" class="form-label">{{ _('Primary Diagnosis') }} <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="diagnosis" name="diagnosis" placeholder="{{ _('Primary condition being treated') }}" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_gender" class="form-label">{{ _('Gender') }}</label>
                                            <select class="form-select" id="anamnesis_gender" name="anamnesis_gender">
                                                <option value="">{{ _('Select gender') }}</option>
                                                <option value="male">{{ _('Male') }}</option>
                                                <option value="female">{{ _('Female') }}</option>
                                                <option value="other">{{ _('Other') }}</option>
                                                <option value="prefer_not_to_say">{{ _('Prefer not to say') }}</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Personal Details -->
                                    <h6 class="mb-3">{{ _('Personal Details') }}</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_occupation" class="form-label">{{ _('Occupation') }}</label>
                                            <input type="text" class="form-control" id="anamnesis_occupation" name="anamnesis_occupation" placeholder="{{ _('Current job/profession') }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_emergency_contact" class="form-label">{{ _('Emergency Contact') }}</label>
                                            <input type="text" class="form-control" id="anamnesis_emergency_contact" name="anamnesis_emergency_contact" placeholder="{{ _('Name and phone number') }}">
                                        </div>
                                    </div>

                                    <!-- Treatment Planning -->
                                    <h6 class="mb-3">{{ _('Treatment Planning') }}</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="treatment_plan" class="form-label">{{ _('Treatment Plan') }}</label>
                                            <textarea class="form-control" id="treatment_plan" name="treatment_plan" rows="3" placeholder="{{ _('Initial treatment strategy and goals') }}"></textarea>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="notes" class="form-label">{{ _('Additional Notes') }}</label>
                                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="{{ _('Any other relevant information') }}"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chief Complaint Tab -->
                                <div class="tab-pane fade" id="chief-complaint" role="tabpanel">
                                    <h6 class="mb-3">{{ _('Reason for Today\'s Visit') }}</h6>
                                    
                                    <!-- Quick Diagnosis Selector -->
                                    <div class="mb-3">
                                        <label for="quick_diagnosis" class="form-label">
                                            <i class="bi bi-lightning-charge"></i> {{ _('Quick Diagnosis Selection') }}
                                        </label>
                                        <select class="form-select" id="quick_diagnosis" onchange="fillDiagnosisFromQuick()">
                                            <option value="">{{ _('Select a common diagnosis...') }}</option>
                                            <optgroup label="{{ _('Musculoskeletal') }}">
                                                <option value="tendinopathy">{{ _('Tendinopathy') }}</option>
                                                <option value="grade2_sprain">{{ _('Grade II Sprain') }}</option>
                                                <option value="grade1_sprain">{{ _('Grade I Sprain') }}</option>
                                                <option value="muscle_strain">{{ _('Muscle Strain') }}</option>
                                                <option value="joint_stiffness">{{ _('Joint Stiffness') }}</option>
                                                <option value="chronic_pain">{{ _('Chronic Pain') }}</option>
                                            </optgroup>
                                            <optgroup label="{{ _('Spine') }}">
                                                <option value="lower_back_pain">{{ _('Lower Back Pain') }}</option>
                                                <option value="cervical_pain">{{ _('Cervical Pain') }}</option>
                                                <option value="herniated_disc">{{ _('Herniated Disc') }}</option>
                                                <option value="sciatica">{{ _('Sciatica') }}</option>
                                                <option value="whiplash">{{ _('Whiplash') }}</option>
                                            </optgroup>
                                            <optgroup label="{{ _('Sports Injuries') }}">
                                                <option value="runners_knee">{{ _('Runner\'s Knee') }}</option>
                                                <option value="tennis_elbow">{{ _('Tennis Elbow') }}</option>
                                                <option value="shoulder_impingement">{{ _('Shoulder Impingement') }}</option>
                                                <option value="acl_injury">{{ _('ACL Injury') }}</option>
                                                <option value="rotator_cuff">{{ _('Rotator Cuff Injury') }}</option>
                                            </optgroup>
                                            <optgroup label="{{ _('Post-Surgical') }}">
                                                <option value="post_surgery_knee">{{ _('Post-Surgery Knee Rehabilitation') }}</option>
                                                <option value="post_surgery_shoulder">{{ _('Post-Surgery Shoulder Rehabilitation') }}</option>
                                                <option value="post_surgery_hip">{{ _('Post-Surgery Hip Rehabilitation') }}</option>
                                            </optgroup>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="anamnesis_chief_complaint" class="form-label">
                                            {{ _('Main reason for consultation') }} <span class="text-danger">*</span>
                                        </label>
                                        <textarea class="form-control" id="anamnesis_chief_complaint" name="anamnesis_chief_complaint" rows="3" 
                                                  placeholder="{{ _('What brought you here today? Describe your main concern or symptom.') }}" required></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_onset_date" class="form-label">
                                                <i class="bi bi-calendar-event"></i> {{ _('When did it start?') }}
                                            </label>
                                            <input type="date" class="form-control" id="anamnesis_onset_date" name="anamnesis_onset_date">
                                            <small class="form-text text-muted">{{ _('Approximate date when symptoms began') }}</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_mechanism" class="form-label">{{ _('How did it happen?') }}</label>
                                            <select class="form-select" id="anamnesis_mechanism" name="anamnesis_mechanism">
                                                <option value="">{{ _('Select mechanism...') }}</option>
                                                <option value="sudden">{{ _('Sudden onset') }}</option>
                                                <option value="gradual">{{ _('Gradual onset') }}</option>
                                                <option value="trauma">{{ _('Trauma/Accident') }}</option>
                                                <option value="overuse">{{ _('Overuse/Repetitive') }}</option>
                                                <option value="sport">{{ _('Sports activity') }}</option>
                                                <option value="work">{{ _('Work-related') }}</option>
                                                <option value="unknown">{{ _('Unknown/Idiopathic') }}</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="anamnesis_onset_description" class="form-label">{{ _('Additional onset details') }}</label>
                                        <textarea class="form-control" id="anamnesis_onset_description" name="anamnesis_onset_description" rows="2" 
                                                  placeholder="{{ _('e.g., after lifting heavy box, during morning run, working at computer...') }}"></textarea>
                                    </div>
                                </div>

                                <!-- Medical History Tab -->
                                <div class="tab-pane fade" id="medical-history" role="tabpanel">
                                    <h6 class="mb-3">{{ _('Previous Medical History') }}</h6>
                                    
                                    <!-- Common Conditions Checkboxes -->
                                    <div class="mb-4">
                                        <label class="form-label">
                                            <i class="bi bi-check2-square"></i> {{ _('Common Previous Conditions') }}
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_diabetes" name="history_conditions" value="diabetes">
                                                    <label class="form-check-label" for="history_diabetes">{{ _('Diabetes') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_hypertension" name="history_conditions" value="hypertension">
                                                    <label class="form-check-label" for="history_hypertension">{{ _('Hypertension') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_arthritis" name="history_conditions" value="arthritis">
                                                    <label class="form-check-label" for="history_arthritis">{{ _('Arthritis') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_osteoporosis" name="history_conditions" value="osteoporosis">
                                                    <label class="form-check-label" for="history_osteoporosis">{{ _('Osteoporosis') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_fibromyalgia" name="history_conditions" value="fibromyalgia">
                                                    <label class="form-check-label" for="history_fibromyalgia">{{ _('Fibromyalgia') }}</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_heart_disease" name="history_conditions" value="heart_disease">
                                                    <label class="form-check-label" for="history_heart_disease">{{ _('Heart Disease') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_asthma" name="history_conditions" value="asthma">
                                                    <label class="form-check-label" for="history_asthma">{{ _('Asthma') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_depression" name="history_conditions" value="depression">
                                                    <label class="form-check-label" for="history_depression">{{ _('Depression/Anxiety') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_thyroid" name="history_conditions" value="thyroid">
                                                    <label class="form-check-label" for="history_thyroid">{{ _('Thyroid Disorders') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="history_chronic_pain" name="history_conditions" value="chronic_pain">
                                                    <label class="form-check-label" for="history_chronic_pain">{{ _('Chronic Pain') }}</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="anamnesis_previous_conditions" class="form-label">{{ _('Other previous conditions') }}</label>
                                        <textarea class="form-control" id="anamnesis_previous_conditions" name="anamnesis_previous_conditions" rows="2" 
                                                  placeholder="{{ _('Any other medical conditions not listed above...') }}"></textarea>
                                    </div>
                                    
                                    <!-- Surgeries with Dates -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-scissors"></i> {{ _('Previous surgeries') }}
                                        </label>
                                        <div id="surgeries-container">
                                            <div class="surgery-entry row mb-2">
                                                <div class="col-md-6">
                                                    <input type="text" class="form-control" name="surgery_description[]" placeholder="{{ _('Type of surgery') }}">
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="date" class="form-control" name="surgery_date[]">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addSurgery()">
                                                        <i class="bi bi-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Medications -->
                                    <div class="mb-3">
                                        <label for="anamnesis_medications" class="form-label">
                                            <i class="bi bi-capsule"></i> {{ _('Current medications') }}
                                        </label>
                                        <textarea class="form-control" id="anamnesis_medications" name="anamnesis_medications" rows="3" 
                                                  placeholder="{{ _('Include prescription drugs, supplements, and over-the-counter medications with dosages...') }}"></textarea>
                                    </div>
                                    
                                    <!-- Common Allergies Checkboxes -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-exclamation-triangle"></i> {{ _('Known allergies') }}
                                        </label>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_penicillin" name="allergies" value="penicillin">
                                                    <label class="form-check-label" for="allergy_penicillin">{{ _('Penicillin') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_nsaids" name="allergies" value="nsaids">
                                                    <label class="form-check-label" for="allergy_nsaids">{{ _('NSAIDs') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_latex" name="allergies" value="latex">
                                                    <label class="form-check-label" for="allergy_latex">{{ _('Latex') }}</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_nuts" name="allergies" value="nuts">
                                                    <label class="form-check-label" for="allergy_nuts">{{ _('Nuts') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_shellfish" name="allergies" value="shellfish">
                                                    <label class="form-check-label" for="allergy_shellfish">{{ _('Shellfish') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_dairy" name="allergies" value="dairy">
                                                    <label class="form-check-label" for="allergy_dairy">{{ _('Dairy') }}</label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_pollen" name="allergies" value="pollen">
                                                    <label class="form-check-label" for="allergy_pollen">{{ _('Pollen') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_dust" name="allergies" value="dust">
                                                    <label class="form-check-label" for="allergy_dust">{{ _('Dust mites') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="allergy_none" name="allergies" value="none" onchange="toggleNoAllergies(this)">
                                                    <label class="form-check-label" for="allergy_none"><strong>{{ _('No known allergies') }}</strong></label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <textarea class="form-control" id="anamnesis_allergies" name="anamnesis_allergies" rows="2" 
                                                      placeholder="{{ _('Other allergies or specific reactions...') }}"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Family History Tab -->
                                <div class="tab-pane fade" id="family-history" role="tabpanel">
                                    <h6 class="mb-3">{{ _('Family Medical History') }}</h6>
                                    
                                    <!-- Common Family Conditions -->
                                    <div class="mb-4">
                                        <label class="form-label">
                                            <i class="bi bi-people"></i> {{ _('Common family conditions') }}
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_diabetes" name="family_conditions" value="diabetes">
                                                    <label class="form-check-label" for="family_diabetes">{{ _('Diabetes') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_heart_disease" name="family_conditions" value="heart_disease">
                                                    <label class="form-check-label" for="family_heart_disease">{{ _('Heart Disease') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_cancer" name="family_conditions" value="cancer">
                                                    <label class="form-check-label" for="family_cancer">{{ _('Cancer') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_stroke" name="family_conditions" value="stroke">
                                                    <label class="form-check-label" for="family_stroke">{{ _('Stroke') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_hypertension" name="family_conditions" value="hypertension">
                                                    <label class="form-check-label" for="family_hypertension">{{ _('Hypertension') }}</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_arthritis" name="family_conditions" value="arthritis">
                                                    <label class="form-check-label" for="family_arthritis">{{ _('Arthritis') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_osteoporosis" name="family_conditions" value="osteoporosis">
                                                    <label class="form-check-label" for="family_osteoporosis">{{ _('Osteoporosis') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_mental_health" name="family_conditions" value="mental_health">
                                                    <label class="form-check-label" for="family_mental_health">{{ _('Mental Health Disorders') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_autoimmune" name="family_conditions" value="autoimmune">
                                                    <label class="form-check-label" for="family_autoimmune">{{ _('Autoimmune Disorders') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="family_none" name="family_conditions" value="none" onchange="toggleNoFamilyHistory(this)">
                                                    <label class="form-check-label" for="family_none"><strong>{{ _('No significant family history') }}</strong></label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="anamnesis_family_history" class="form-label">{{ _('Additional family history details') }}</label>
                                        <textarea class="form-control" id="anamnesis_family_history" name="anamnesis_family_history" rows="3" 
                                                  placeholder="{{ _('Include specific family member relationships, ages of onset, genetic disorders, etc.') }}"></textarea>
                                    </div>
                                </div>

                                <!-- Lifestyle Tab -->
                                <div class="tab-pane fade" id="lifestyle" role="tabpanel">
                                    <h6 class="mb-3">{{ _('Lifestyle and Habits') }}</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_physical_activity" class="form-label">
                                                <i class="bi bi-heart-pulse"></i> {{ _('Physical activity level') }}
                                            </label>
                                            <select class="form-select" id="anamnesis_physical_activity" name="anamnesis_physical_activity" onchange="showActivityDetails(this.value)">
                                                <option value="">{{ _('Select activity level') }}</option>
                                                <option value="sedentary">ü™ë {{ _('Sedentary (little to no exercise)') }}</option>
                                                <option value="light">üö∂ {{ _('Light (1-3 days/week)') }}</option>
                                                <option value="moderate">üèÉ {{ _('Moderate (3-5 days/week)') }}</option>
                                                <option value="active">üí™ {{ _('Very active (6-7 days/week)') }}</option>
                                                <option value="athlete">üèÜ {{ _('Athlete (multiple sessions/day)') }}</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_sleep" class="form-label">
                                                <i class="bi bi-moon"></i> {{ _('Sleep quality') }}
                                            </label>
                                            <select class="form-select" id="anamnesis_sleep" name="anamnesis_sleep">
                                                <option value="">{{ _('Select sleep quality') }}</option>
                                                <option value="excellent">üò¥ {{ _('Excellent (7-9h, refreshing)') }}</option>
                                                <option value="good">üòä {{ _('Good (6-8h, mostly refreshing)') }}</option>
                                                <option value="fair">üòê {{ _('Fair (5-7h, sometimes tired)') }}</option>
                                                <option value="poor">üòµ {{ _('Poor (<6h, often tired)') }}</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="activity-details" class="mb-3" style="display: none;">
                                        <label for="activity_details" class="form-label">{{ _('Activity details') }}</label>
                                        <textarea class="form-control" id="activity_details" name="activity_details" rows="2" 
                                                  placeholder="{{ _('What types of activities do you do? How often? Any sports or specific exercises?') }}"></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_work_posture" class="form-label">
                                                <i class="bi bi-briefcase"></i> {{ _('Work environment') }}
                                            </label>
                                            <select class="form-select" id="anamnesis_work_posture" name="anamnesis_work_posture">
                                                <option value="">{{ _('Select work type...') }}</option>
                                                <option value="desk">üíª {{ _('Desk job (computer work)') }}</option>
                                                <option value="standing">üßç {{ _('Standing work') }}</option>
                                                <option value="physical">üèóÔ∏è {{ _('Physical labor') }}</option>
                                                <option value="mixed">üîÑ {{ _('Mixed (sitting/standing)') }}</option>
                                                <option value="driving">üöó {{ _('Driving/Transport') }}</option>
                                                <option value="healthcare">üè• {{ _('Healthcare worker') }}</option>
                                                <option value="retired">üè° {{ _('Retired') }}</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_stress_level" class="form-label">
                                                <i class="bi bi-thermometer-half"></i> {{ _('Stress level (1-10)') }}
                                            </label>
                                            <input type="range" class="form-range" id="anamnesis_stress_level" name="anamnesis_stress_level" min="1" max="10" 
                                                   oninput="updateStressDisplay(this.value)">
                                            <div class="d-flex justify-content-between">
                                                <small>üòå 1</small>
                                                <small id="stress-display">5</small>
                                                <small>üò∞ 10</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Habits Checkboxes -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-cup-hot"></i> {{ _('Lifestyle habits') }}
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="habit_smoking" name="lifestyle_habits" value="smoking">
                                                    <label class="form-check-label" for="habit_smoking">üö¨ {{ _('Smoking') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="habit_alcohol" name="lifestyle_habits" value="alcohol">
                                                    <label class="form-check-label" for="habit_alcohol">üç∑ {{ _('Regular alcohol consumption') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="habit_caffeine" name="lifestyle_habits" value="caffeine">
                                                    <label class="form-check-label" for="habit_caffeine">‚òï {{ _('High caffeine intake') }}</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="habit_healthy_diet" name="lifestyle_habits" value="healthy_diet">
                                                    <label class="form-check-label" for="habit_healthy_diet">ü•ó {{ _('Healthy balanced diet') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="habit_hydration" name="lifestyle_habits" value="good_hydration">
                                                    <label class="form-check-label" for="habit_hydration">üíß {{ _('Good hydration (>2L/day)') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="habit_supplements" name="lifestyle_habits" value="supplements">
                                                    <label class="form-check-label" for="habit_supplements">üíä {{ _('Takes supplements') }}</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="anamnesis_diet_habits" class="form-label">{{ _('Additional lifestyle notes') }}</label>
                                        <textarea class="form-control" id="anamnesis_diet_habits" name="anamnesis_diet_habits" rows="2" 
                                                  placeholder="{{ _('Any dietary restrictions, special habits, or lifestyle factors affecting health...') }}"></textarea>
                                    </div>
                                </div>

                                <!-- Current Pain Tab -->
                                <div class="tab-pane fade" id="current-pain" role="tabpanel">
                                    <h6 class="mb-3">{{ _('Current Pain Assessment') }}</h6>
                                    
                                    <!-- Pain Scale with Visual -->
                                    <div class="mb-4">
                                        <label for="anamnesis_pain_scale" class="form-label">
                                            <i class="bi bi-emoji-dizzy"></i> {{ _('Pain level (0-10)') }}
                                        </label>
                                        <input type="range" class="form-range" id="anamnesis_pain_scale" name="anamnesis_pain_scale" 
                                               min="0" max="10" value="0" oninput="updatePainDisplay(this.value)">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small>üòä 0</small>
                                            <div class="text-center">
                                                <span id="pain-display" class="badge bg-success fs-6">0</span>
                                                <div><small id="pain-description">{{ _('No pain') }}</small></div>
                                            </div>
                                            <small>üòµ 10</small>
                                        </div>
                                    </div>

                                    <!-- Pain Characteristics -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-lightning"></i> {{ _('Pain characteristics') }}
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_sharp" name="pain_characteristics" value="sharp">
                                                    <label class="form-check-label" for="pain_sharp">‚ö° {{ _('Sharp/Stabbing') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_dull" name="pain_characteristics" value="dull">
                                                    <label class="form-check-label" for="pain_dull">üü§ {{ _('Dull/Aching') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_burning" name="pain_characteristics" value="burning">
                                                    <label class="form-check-label" for="pain_burning">üî• {{ _('Burning') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_throbbing" name="pain_characteristics" value="throbbing">
                                                    <label class="form-check-label" for="pain_throbbing">üíì {{ _('Throbbing') }}</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_tingling" name="pain_characteristics" value="tingling">
                                                    <label class="form-check-label" for="pain_tingling">‚ú® {{ _('Tingling/Pins & needles') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_numbness" name="pain_characteristics" value="numbness">
                                                    <label class="form-check-label" for="pain_numbness">üîò {{ _('Numbness') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_stiffness" name="pain_characteristics" value="stiffness">
                                                    <label class="form-check-label" for="pain_stiffness">üîí {{ _('Stiffness') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pain_cramping" name="pain_characteristics" value="cramping">
                                                    <label class="form-check-label" for="pain_cramping">üåÄ {{ _('Cramping/Spasms') }}</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Pain Timing -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_pain_timing" class="form-label">
                                                <i class="bi bi-clock"></i> {{ _('When is pain worse?') }}
                                            </label>
                                            <select class="form-select" id="anamnesis_pain_timing" name="anamnesis_pain_timing" multiple>
                                                <option value="morning">üåÖ {{ _('Morning') }}</option>
                                                <option value="afternoon">‚òÄÔ∏è {{ _('Afternoon') }}</option>
                                                <option value="evening">üåÜ {{ _('Evening') }}</option>
                                                <option value="night">üåô {{ _('Night') }}</option>
                                                <option value="movement">üö∂ {{ _('With movement') }}</option>
                                                <option value="rest">üõãÔ∏è {{ _('At rest') }}</option>
                                                <option value="weather">‚õàÔ∏è {{ _('Weather changes') }}</option>
                                                <option value="stress">üò∞ {{ _('During stress') }}</option>
                                            </select>
                                            <small class="form-text text-muted">{{ _('Hold Ctrl/Cmd to select multiple') }}</small>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_pain_location" class="form-label">
                                                <i class="bi bi-geo-alt"></i> {{ _('Pain location') }}
                                            </label>
                                            <select class="form-select" id="anamnesis_pain_location" name="anamnesis_pain_location">
                                                <option value="">{{ _('Select primary location...') }}</option>
                                                <optgroup label="{{ _('Head & Neck') }}">
                                                    <option value="head">üß† {{ _('Head/Headache') }}</option>
                                                    <option value="neck">ü¶í {{ _('Neck') }}</option>
                                                    <option value="jaw">üòÆ {{ _('Jaw/TMJ') }}</option>
                                                </optgroup>
                                                <optgroup label="{{ _('Upper Body') }}">
                                                    <option value="shoulder">ü§∑ {{ _('Shoulder') }}</option>
                                                    <option value="arm">üí™ {{ _('Arm') }}</option>
                                                    <option value="elbow">ü§è {{ _('Elbow') }}</option>
                                                    <option value="wrist">ü§≤ {{ _('Wrist/Hand') }}</option>
                                                    <option value="upper_back">üéí {{ _('Upper back') }}</option>
                                                </optgroup>
                                                <optgroup label="{{ _('Core & Spine') }}">
                                                    <option value="chest">ü´Å {{ _('Chest') }}</option>
                                                    <option value="mid_back">üìê {{ _('Mid back') }}</option>
                                                    <option value="lower_back">üèÉ‚Äç‚ôÇÔ∏è {{ _('Lower back') }}</option>
                                                    <option value="pelvis">ü¶¥ {{ _('Pelvis/Hip') }}</option>
                                                </optgroup>
                                                <optgroup label="{{ _('Lower Body') }}">
                                                    <option value="thigh">ü¶µ {{ _('Thigh') }}</option>
                                                    <option value="knee">ü¶µ {{ _('Knee') }}</option>
                                                    <option value="calf">ü¶µ {{ _('Calf/Shin') }}</option>
                                                    <option value="ankle">ü¶∂ {{ _('Ankle/Foot') }}</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Aggravating and Relieving Factors -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_aggravating_factors" class="form-label">
                                                <i class="bi bi-arrow-up-circle text-danger"></i> {{ _('What makes it worse?') }}
                                            </label>
                                            <textarea class="form-control" id="anamnesis_aggravating_factors" name="anamnesis_aggravating_factors" rows="3" 
                                                      placeholder="{{ _('Activities, positions, or movements that increase pain...') }}"></textarea>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="anamnesis_relieving_factors" class="form-label">
                                                <i class="bi bi-arrow-down-circle text-success"></i> {{ _('What makes it better?') }}
                                            </label>
                                            <textarea class="form-control" id="anamnesis_relieving_factors" name="anamnesis_relieving_factors" rows="3" 
                                                      placeholder="{{ _('Rest, medications, positions, or treatments that help...') }}"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Functional Examination Tab -->
                                <div class="tab-pane fade" id="functional-exam" role="tabpanel">
                                    <h6 class="mb-3">{{ _('Functional Assessment') }}</h6>
                                    
                                    <!-- Functional Limitations -->
                                    <div class="mb-4">
                                        <label class="form-label">
                                            <i class="bi bi-person-x"></i> {{ _('Current functional limitations') }}
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_walking" name="functional_limitations" value="walking">
                                                    <label class="form-check-label" for="limit_walking">üö∂ {{ _('Walking difficulties') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_stairs" name="functional_limitations" value="stairs">
                                                    <label class="form-check-label" for="limit_stairs">ü™ú {{ _('Stair climbing') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_sitting" name="functional_limitations" value="sitting">
                                                    <label class="form-check-label" for="limit_sitting">ü™ë {{ _('Prolonged sitting') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_standing" name="functional_limitations" value="standing">
                                                    <label class="form-check-label" for="limit_standing">üßç {{ _('Prolonged standing') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_lifting" name="functional_limitations" value="lifting">
                                                    <label class="form-check-label" for="limit_lifting">üèãÔ∏è {{ _('Lifting/Carrying') }}</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_reaching" name="functional_limitations" value="reaching">
                                                    <label class="form-check-label" for="limit_reaching">üôã {{ _('Reaching overhead') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_bending" name="functional_limitations" value="bending">
                                                    <label class="form-check-label" for="limit_bending">ü§∏ {{ _('Bending/Stooping') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_sleep" name="functional_limitations" value="sleep">
                                                    <label class="form-check-label" for="limit_sleep">üò¥ {{ _('Sleep disruption') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_work" name="functional_limitations" value="work">
                                                    <label class="form-check-label" for="limit_work">üíº {{ _('Work activities') }}</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="limit_sports" name="functional_limitations" value="sports">
                                                    <label class="form-check-label" for="limit_sports">‚öΩ {{ _('Sports/Recreation') }}</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ROM Assessment -->
                                    <div class="mb-3">
                                        <label for="anamnesis_rom_assessment" class="form-label">
                                            <i class="bi bi-arrow-clockwise"></i> {{ _('Range of Motion observations') }}
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <select class="form-select mb-2" id="rom_area" name="rom_area">
                                                    <option value="">{{ _('Select area to assess...') }}</option>
                                                    <option value="cervical">ü¶í {{ _('Cervical spine') }}</option>
                                                    <option value="thoracic">üìê {{ _('Thoracic spine') }}</option>
                                                    <option value="lumbar">üèÉ‚Äç‚ôÇÔ∏è {{ _('Lumbar spine') }}</option>
                                                    <option value="shoulder">ü§∑ {{ _('Shoulder') }}</option>
                                                    <option value="elbow">ü§è {{ _('Elbow') }}</option>
                                                    <option value="wrist">ü§≤ {{ _('Wrist') }}</option>
                                                    <option value="hip">ü¶¥ {{ _('Hip') }}</option>
                                                    <option value="knee">ü¶µ {{ _('Knee') }}</option>
                                                    <option value="ankle">ü¶∂ {{ _('Ankle') }}</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <select class="form-select mb-2" id="rom_quality" name="rom_quality">
                                                    <option value="">{{ _('ROM quality...') }}</option>
                                                    <option value="normal">‚úÖ {{ _('Normal/Full') }}</option>
                                                    <option value="limited">‚ö†Ô∏è {{ _('Limited') }}</option>
                                                    <option value="painful">üò£ {{ _('Painful') }}</option>
                                                    <option value="restricted">üö´ {{ _('Severely restricted') }}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <textarea class="form-control" id="anamnesis_rom_assessment" name="anamnesis_rom_assessment" rows="3" 
                                                  placeholder="{{ _('Specific ROM findings, measurements, or movement patterns observed...') }}"></textarea>
                                    </div>
                                    
                                    <!-- Strength Assessment -->
                                    <div class="mb-3">
                                        <label for="anamnesis_strength_assessment" class="form-label">
                                            <i class="bi bi-lightning-charge-fill"></i> {{ _('Strength observations') }}
                                        </label>
                                        <div class="row mb-2">
                                            <div class="col-md-6">
                                                <select class="form-select" id="strength_area" name="strength_area">
                                                    <option value="">{{ _('Select muscle group...') }}</option>
                                                    <option value="neck">ü¶í {{ _('Neck muscles') }}</option>
                                                    <option value="shoulder_girdle">üéí {{ _('Shoulder girdle') }}</option>
                                                    <option value="arm">üí™ {{ _('Arm muscles') }}</option>
                                                    <option value="core">üéØ {{ _('Core/Trunk') }}</option>
                                                    <option value="hip">ü¶¥ {{ _('Hip muscles') }}</option>
                                                    <option value="thigh">ü¶µ {{ _('Thigh muscles') }}</option>
                                                    <option value="calf">ü¶µ {{ _('Calf muscles') }}</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <select class="form-select" id="strength_grade" name="strength_grade">
                                                    <option value="">{{ _('Strength grade...') }}</option>
                                                    <option value="5">üí™ 5/5 - {{ _('Normal') }}</option>
                                                    <option value="4">üí™ 4/5 - {{ _('Good') }}</option>
                                                    <option value="3">üí™ 3/5 - {{ _('Fair') }}</option>
                                                    <option value="2">üí™ 2/5 - {{ _('Poor') }}</option>
                                                    <option value="1">üí™ 1/5 - {{ _('Trace') }}</option>
                                                    <option value="0">üí™ 0/5 - {{ _('None') }}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <textarea class="form-control" id="anamnesis_strength_assessment" name="anamnesis_strength_assessment" rows="3" 
                                                  placeholder="{{ _('Manual muscle testing results, weakness patterns, compensations noted...') }}"></textarea>
                                    </div>
                                    
                                    <!-- Special Tests -->
                                    <div class="mb-3">
                                        <label for="anamnesis_special_tests" class="form-label">
                                            <i class="bi bi-clipboard-check"></i> {{ _('Special tests performed') }}
                                        </label>
                                        <div class="row mb-2">
                                            <div class="col-md-8">
                                                <select class="form-select" id="special_test_name" name="special_test_name">
                                                    <option value="">{{ _('Select a common test...') }}</option>
                                                    <optgroup label="{{ _('Spine Tests') }}">
                                                        <option value="slr">{{ _('Straight Leg Raise (SLR)') }}</option>
                                                        <option value="spurling">{{ _('Spurling\'s Test') }}</option>
                                                        <option value="distraction">{{ _('Cervical Distraction') }}</option>
                                                        <option value="slump">{{ _('Slump Test') }}</option>
                                                    </optgroup>
                                                    <optgroup label="{{ _('Shoulder Tests') }}">
                                                        <option value="impingement">{{ _('Impingement Tests') }}</option>
                                                        <option value="apprehension">{{ _('Apprehension Test') }}</option>
                                                        <option value="drop_arm">{{ _('Drop Arm Test') }}</option>
                                                        <option value="crossover">{{ _('Cross-over Test') }}</option>
                                                    </optgroup>
                                                    <optgroup label="{{ _('Knee Tests') }}">
                                                        <option value="mcmurray">{{ _('McMurray Test') }}</option>
                                                        <option value="lachman">{{ _('Lachman Test') }}</option>
                                                        <option value="drawer">{{ _('Drawer Test') }}</option>
                                                        <option value="valgus_varus">{{ _('Valgus/Varus Stress') }}</option>
                                                    </optgroup>
                                                    <optgroup label="{{ _('Hip Tests') }}">
                                                        <option value="thomas">{{ _('Thomas Test') }}</option>
                                                        <option value="faber">{{ _('FABER Test') }}</option>
                                                        <option value="trendelenburg">{{ _('Trendelenburg Test') }}</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <select class="form-select" id="test_result" name="test_result">
                                                    <option value="">{{ _('Result...') }}</option>
                                                    <option value="positive">‚úÖ {{ _('Positive') }}</option>
                                                    <option value="negative">‚ùå {{ _('Negative') }}</option>
                                                    <option value="inconclusive">‚ùì {{ _('Inconclusive') }}</option>
                                                </select>
                                            </div>
                                        </div>
                                        <textarea class="form-control" id="anamnesis_special_tests" name="anamnesis_special_tests" rows="3" 
                                                  placeholder="{{ _('Document special tests performed, results, and clinical relevance...') }}"></textarea>
                                    </div>
                                    
                                    <!-- Additional Clinical Notes -->
                                    <div class="mb-3">
                                        <label for="anamnesis_additional_notes" class="form-label">
                                            <i class="bi bi-journal-text"></i> {{ _('Additional examination findings') }}
                                        </label>
                                        <textarea class="form-control" id="anamnesis_additional_notes" name="anamnesis_additional_notes" rows="4" 
                                                  placeholder="{{ _('Posture, gait, neurological findings, palpation, clinical impression, red flags, etc.') }}"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden field to store compiled anamnesis -->
                            <input type="hidden" id="compiled_anamnesis" name="anamnesis">
                            
                            <div class="d-flex justify-content-between mt-4">
                                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">{{ _('Cancel') }}</a>
                                <button type="button" class="btn btn-primary" onclick="nextStep(2)" id="step1-next">
                                    {{ _('Next: Portal Access') }} <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Portal Access -->
                        <div class="step-content" id="step2">
                            <h5 class="mb-3">{{ _('Patient Portal Access (Optional)') }}</h5>
                            <p class="text-muted">{{ _('Enter an email and password if you want the patient to be able to log in and view their exercise prescriptions.') }}</p>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="patient_email" class="form-label">{{ _('Login Email') }}</label>
                                    <input type="email" class="form-control" id="patient_email" name="patient_email" placeholder="patient.login@example.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="patient_password" class="form-label">{{ _('Password') }}</label>
                                    <input type="password" class="form-control" id="patient_password" name="patient_password" placeholder="{{ _('Set initial password') }}">
                                    <small class="form-text text-muted">{{ _('Leave blank if login email is not provided.') }}</small>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                                    <i class="bi bi-arrow-left"></i> {{ _('Back: Patient Data & Anamnesis') }}
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle"></i> {{ _('Create Patient') }}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 60%;
    width: 80%;
    height: 2px;
    background-color: #dee2e6;
    z-index: 1;
}

.step.active:not(:last-child)::after {
    background-color: #0d6efd;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #dee2e6;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    z-index: 2;
    position: relative;
    background-color: white;
    border: 2px solid #dee2e6;
}

.step.active .step-number {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.step.completed .step-number {
    background-color: #198754;
    color: white;
    border-color: #198754;
}

.step-title {
    font-size: 0.9rem;
    color: #6c757d;
    text-align: center;
}

.step.active .step-title {
    color: #0d6efd;
    font-weight: 600;
}

.step.completed .step-title {
    color: #198754;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}
</style>

<script>
let currentStep = 1;

// ==== INTERACTIVE FUNCTIONS FOR SEXY ANAMNESIS ====

// Quick diagnosis selection auto-fill
function fillDiagnosisFromQuick() {
    const selectedDiagnosis = document.getElementById('quick_diagnosis').value;
    const chiefComplaintField = document.getElementById('anamnesis_chief_complaint');
    
    const diagnosisTexts = {
        'tendinopathy': 'Dolor y rigidez en tend√≥n. Dolor que empeora con actividad espec√≠fica y mejora con reposo.',
        'grade2_sprain': 'Esguince grado II con dolor moderado, inflamaci√≥n y limitaci√≥n funcional parcial.',
        'grade1_sprain': 'Esguince grado I con dolor leve y m√≠nima limitaci√≥n funcional.',
        'muscle_strain': 'Tensi√≥n muscular con dolor localizado y posible limitaci√≥n de movimiento.',
        'joint_stiffness': 'Rigidez articular con limitaci√≥n de rango de movimiento, especialmente matutina.',
        'chronic_pain': 'Dolor cr√≥nico persistente que afecta las actividades diarias.',
        'lower_back_pain': 'Dolor lumbar que puede irradiar o no, con limitaci√≥n funcional variable.',
        'cervical_pain': 'Dolor cervical con posible irradiaci√≥n, rigidez y limitaci√≥n de movimiento.',
        'herniated_disc': 'Hernia discal con posible irradiaci√≥n neurol√≥gica y limitaci√≥n funcional.',
        'sciatica': 'Dolor irradiado por nervio ci√°tico desde zona lumbar hasta pierna.',
        'whiplash': 'Latigazo cervical tras traumatismo con dolor y rigidez cervical.',
        'runners_knee': 'Dolor anterior de rodilla relacionado con actividad de carrera.',
        'tennis_elbow': 'Epicondilitis lateral con dolor en cara externa del codo.',
        'shoulder_impingement': 'S√≠ndrome de pinzamiento con dolor al elevar el brazo.',
        'acl_injury': 'Lesi√≥n de ligamento cruzado anterior con inestabilidad de rodilla.',
        'rotator_cuff': 'Lesi√≥n del manguito rotador con dolor y debilidad en el hombro.',
        'post_surgery_knee': 'Rehabilitaci√≥n post-quir√∫rgica de rodilla para recuperar funci√≥n.',
        'post_surgery_shoulder': 'Rehabilitaci√≥n post-quir√∫rgica de hombro para recuperar movilidad.',
        'post_surgery_hip': 'Rehabilitaci√≥n post-quir√∫rgica de cadera para recuperar marcha.'
    };
    
    if (selectedDiagnosis && diagnosisTexts[selectedDiagnosis]) {
        if (chiefComplaintField.value.trim() === '') {
            chiefComplaintField.value = diagnosisTexts[selectedDiagnosis];
        }
    }
}

// Pain scale visual feedback
function updatePainDisplay(value) {
    const display = document.getElementById('pain-display');
    const description = document.getElementById('pain-description');
    
    const painDescriptions = {
        0: 'Sin dolor',
        1: 'Dolor muy leve',
        2: 'Dolor leve', 
        3: 'Dolor moderado',
        4: 'Dolor notable',
        5: 'Dolor fuerte',
        6: 'Dolor intenso',
        7: 'Dolor severo',
        8: 'Dolor muy severo',
        9: 'Dolor insoportable',
        10: 'Peor dolor imaginable'
    };
    
    display.textContent = value;
    description.textContent = painDescriptions[value] || 'Dolor';
    
    // Change color based on pain level
    display.className = 'badge fs-6 ' + (
        value <= 2 ? 'bg-success' :
        value <= 4 ? 'bg-warning' :
        value <= 6 ? 'bg-warning text-dark' :
        value <= 8 ? 'bg-danger' : 'bg-dark'
    );
}

// Stress level display
function updateStressDisplay(value) {
    document.getElementById('stress-display').textContent = value;
}

// Show activity details when activity level is selected
function showActivityDetails(value) {
    const detailsDiv = document.getElementById('activity-details');
    if (value && value !== '') {
        detailsDiv.style.display = 'block';
    } else {
        detailsDiv.style.display = 'none';
    }
}

// Surgery management
function addSurgery() {
    const container = document.getElementById('surgeries-container');
    const newSurgery = document.createElement('div');
    newSurgery.className = 'surgery-entry row mb-2';
    newSurgery.innerHTML = `
        <div class="col-md-6">
            <input type="text" class="form-control" name="surgery_description[]" placeholder="{{ _('Type of surgery') }}">
        </div>
        <div class="col-md-4">
            <input type="date" class="form-control" name="surgery_date[]">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSurgery(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(newSurgery);
}

function removeSurgery(button) {
    button.closest('.surgery-entry').remove();
}

// Allergy management
function toggleNoAllergies(checkbox) {
    const allergyCheckboxes = document.querySelectorAll('input[name="allergies"]:not(#allergy_none)');
    if (checkbox.checked) {
        allergyCheckboxes.forEach(cb => cb.checked = false);
    }
}

// Family history management
function toggleNoFamilyHistory(checkbox) {
    const familyCheckboxes = document.querySelectorAll('input[name="family_conditions"]:not(#family_none)');
    if (checkbox.checked) {
        familyCheckboxes.forEach(cb => cb.checked = false);
    }
}

// Function to compile all anamnesis fields into one
function compileAnamnesis() {
    // Calculate age from date of birth
    function calculateAge(birthDate) {
        if (!birthDate) return '';
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age.toString();
    }

    // Helper function to get selected checkboxes
    function getSelectedCheckboxes(name) {
        const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
        return Array.from(checkboxes).map(cb => cb.value);
    }

    // Helper function to get multiple selected options
    function getMultipleSelected(selectId) {
        const select = document.getElementById(selectId);
        if (!select || !select.multiple) return '';
        const selected = Array.from(select.selectedOptions).map(option => option.text);
        return selected.join(', ');
    }

    // Helper function to compile surgeries
    function compileSurgeries() {
        const descriptions = document.querySelectorAll('input[name="surgery_description[]"]');
        const dates = document.querySelectorAll('input[name="surgery_date[]"]');
        const surgeries = [];
        
        for (let i = 0; i < descriptions.length; i++) {
            if (descriptions[i].value.trim()) {
                const surgery = descriptions[i].value.trim();
                const date = dates[i] ? dates[i].value : '';
                surgeries.push(date ? `${surgery} (${date})` : surgery);
            }
        }
        return surgeries.join('; ');
    }

    const anamnesisData = {
        personal_data: {
            age: calculateAge(document.getElementById('date_of_birth').value),
            gender: document.getElementById('anamnesis_gender').value,
            occupation: document.getElementById('anamnesis_occupation').value,
            emergency_contact: document.getElementById('anamnesis_emergency_contact').value
        },
        chief_complaint: {
            main_complaint: document.getElementById('anamnesis_chief_complaint').value,
            onset_date: document.getElementById('anamnesis_onset_date').value,
            mechanism: document.getElementById('anamnesis_mechanism').value,
            onset_description: document.getElementById('anamnesis_onset_description').value
        },
        medical_history: {
            previous_conditions: document.getElementById('anamnesis_previous_conditions').value,
            history_conditions: getSelectedCheckboxes('history_conditions'),
            surgeries: compileSurgeries(),
            medications: document.getElementById('anamnesis_medications').value,
            allergies: document.getElementById('anamnesis_allergies').value,
            allergy_types: getSelectedCheckboxes('allergies')
        },
        family_history: {
            family_history: document.getElementById('anamnesis_family_history').value,
            family_conditions: getSelectedCheckboxes('family_conditions')
        },
        lifestyle: {
            physical_activity: document.getElementById('anamnesis_physical_activity').value,
            activity_details: document.getElementById('activity_details').value,
            sleep: document.getElementById('anamnesis_sleep').value,
            work_posture: document.getElementById('anamnesis_work_posture').value,
            stress_level: document.getElementById('anamnesis_stress_level').value,
            lifestyle_habits: getSelectedCheckboxes('lifestyle_habits'),
            diet_habits: document.getElementById('anamnesis_diet_habits').value
        },
        current_pain: {
            pain_scale: document.getElementById('anamnesis_pain_scale').value,
            pain_characteristics: getSelectedCheckboxes('pain_characteristics'),
            pain_timing: getMultipleSelected('anamnesis_pain_timing'),
            pain_location: document.getElementById('anamnesis_pain_location').value,
            aggravating_factors: document.getElementById('anamnesis_aggravating_factors').value,
            relieving_factors: document.getElementById('anamnesis_relieving_factors').value
        },
        functional_exam: {
            functional_limitations: getSelectedCheckboxes('functional_limitations'),
            rom_assessment: document.getElementById('anamnesis_rom_assessment').value,
            strength_assessment: document.getElementById('anamnesis_strength_assessment').value,
            special_tests: document.getElementById('anamnesis_special_tests').value,
            additional_notes: document.getElementById('anamnesis_additional_notes').value
        }
    };

    // Create formatted text from the data
    let compiledText = '';
    
    if (anamnesisData.personal_data.age || anamnesisData.personal_data.gender || anamnesisData.personal_data.occupation || anamnesisData.personal_data.emergency_contact) {
        compiledText += '=== DATOS PERSONALES ===\n';
        if (anamnesisData.personal_data.age) compiledText += `Edad: ${anamnesisData.personal_data.age} a√±os\n`;
        if (anamnesisData.personal_data.gender) compiledText += `G√©nero: ${anamnesisData.personal_data.gender}\n`;
        if (anamnesisData.personal_data.occupation) compiledText += `Ocupaci√≥n: ${anamnesisData.personal_data.occupation}\n`;
        if (anamnesisData.personal_data.emergency_contact) compiledText += `Contacto de emergencia: ${anamnesisData.personal_data.emergency_contact}\n`;
        compiledText += '\n';
    }
    
    if (anamnesisData.chief_complaint.main_complaint) {
        compiledText += '=== MOTIVO DE CONSULTA ===\n';
        compiledText += `Motivo principal: ${anamnesisData.chief_complaint.main_complaint}\n`;
        if (anamnesisData.chief_complaint.onset_date) compiledText += `Fecha de inicio: ${anamnesisData.chief_complaint.onset_date}\n`;
        if (anamnesisData.chief_complaint.mechanism) compiledText += `Mecanismo: ${anamnesisData.chief_complaint.mechanism}\n`;
        if (anamnesisData.chief_complaint.onset_description) compiledText += `Detalles del inicio: ${anamnesisData.chief_complaint.onset_description}\n`;
        compiledText += '\n';
    }
    
    if (anamnesisData.medical_history.previous_conditions || anamnesisData.medical_history.history_conditions.length > 0 || anamnesisData.medical_history.surgeries || anamnesisData.medical_history.medications || anamnesisData.medical_history.allergies || anamnesisData.medical_history.allergy_types.length > 0) {
        compiledText += '=== HISTORIA M√âDICA ===\n';
        if (anamnesisData.medical_history.history_conditions.length > 0) {
            compiledText += `Condiciones comunes: ${anamnesisData.medical_history.history_conditions.join(', ')}\n`;
        }
        if (anamnesisData.medical_history.previous_conditions) compiledText += `Otras condiciones: ${anamnesisData.medical_history.previous_conditions}\n`;
        if (anamnesisData.medical_history.surgeries) compiledText += `Cirug√≠as: ${anamnesisData.medical_history.surgeries}\n`;
        if (anamnesisData.medical_history.medications) compiledText += `Medicaci√≥n actual: ${anamnesisData.medical_history.medications}\n`;
        if (anamnesisData.medical_history.allergy_types.length > 0) {
            compiledText += `Alergias conocidas: ${anamnesisData.medical_history.allergy_types.join(', ')}\n`;
        }
        if (anamnesisData.medical_history.allergies) compiledText += `Otras alergias: ${anamnesisData.medical_history.allergies}\n`;
        compiledText += '\n';
    }
    
    if (anamnesisData.family_history.family_history || anamnesisData.family_history.family_conditions.length > 0) {
        compiledText += '=== ANTECEDENTES FAMILIARES ===\n';
        if (anamnesisData.family_history.family_conditions.length > 0) {
            compiledText += `Condiciones familiares: ${anamnesisData.family_history.family_conditions.join(', ')}\n`;
        }
        if (anamnesisData.family_history.family_history) compiledText += `Detalles adicionales: ${anamnesisData.family_history.family_history}\n`;
        compiledText += '\n';
    }
    
    if (anamnesisData.lifestyle.physical_activity || anamnesisData.lifestyle.activity_details || anamnesisData.lifestyle.sleep || anamnesisData.lifestyle.work_posture || anamnesisData.lifestyle.stress_level || anamnesisData.lifestyle.lifestyle_habits.length > 0 || anamnesisData.lifestyle.diet_habits) {
        compiledText += '=== ESTILO DE VIDA ===\n';
        if (anamnesisData.lifestyle.physical_activity) compiledText += `Actividad f√≠sica: ${anamnesisData.lifestyle.physical_activity}\n`;
        if (anamnesisData.lifestyle.activity_details) compiledText += `Detalles de actividad: ${anamnesisData.lifestyle.activity_details}\n`;
        if (anamnesisData.lifestyle.sleep) compiledText += `Calidad del sue√±o: ${anamnesisData.lifestyle.sleep}\n`;
        if (anamnesisData.lifestyle.work_posture) compiledText += `Entorno laboral: ${anamnesisData.lifestyle.work_posture}\n`;
        if (anamnesisData.lifestyle.stress_level) compiledText += `Nivel de estr√©s: ${anamnesisData.lifestyle.stress_level}/10\n`;
        if (anamnesisData.lifestyle.lifestyle_habits.length > 0) {
            compiledText += `H√°bitos: ${anamnesisData.lifestyle.lifestyle_habits.join(', ')}\n`;
        }
        if (anamnesisData.lifestyle.diet_habits) compiledText += `Notas adicionales: ${anamnesisData.lifestyle.diet_habits}\n`;
        compiledText += '\n';
    }
    
    if (anamnesisData.current_pain.pain_scale || anamnesisData.current_pain.pain_characteristics.length > 0 || anamnesisData.current_pain.pain_timing || anamnesisData.current_pain.pain_location || anamnesisData.current_pain.aggravating_factors || anamnesisData.current_pain.relieving_factors) {
        compiledText += '=== DOLOR ACTUAL ===\n';
        if (anamnesisData.current_pain.pain_scale) compiledText += `Escala de dolor: ${anamnesisData.current_pain.pain_scale}/10\n`;
        if (anamnesisData.current_pain.pain_characteristics.length > 0) {
            compiledText += `Caracter√≠sticas: ${anamnesisData.current_pain.pain_characteristics.join(', ')}\n`;
        }
        if (anamnesisData.current_pain.pain_location) compiledText += `Localizaci√≥n: ${anamnesisData.current_pain.pain_location}\n`;
        if (anamnesisData.current_pain.pain_timing) compiledText += `Momento del dolor: ${anamnesisData.current_pain.pain_timing}\n`;
        if (anamnesisData.current_pain.aggravating_factors) compiledText += `Factores que empeoran: ${anamnesisData.current_pain.aggravating_factors}\n`;
        if (anamnesisData.current_pain.relieving_factors) compiledText += `Factores que mejoran: ${anamnesisData.current_pain.relieving_factors}\n`;
        compiledText += '\n';
    }
    
    if (anamnesisData.functional_exam.functional_limitations.length > 0 || anamnesisData.functional_exam.rom_assessment || anamnesisData.functional_exam.strength_assessment || anamnesisData.functional_exam.special_tests || anamnesisData.functional_exam.additional_notes) {
        compiledText += '=== EXPLORACI√ìN FUNCIONAL ===\n';
        if (anamnesisData.functional_exam.functional_limitations.length > 0) {
            compiledText += `Limitaciones funcionales: ${anamnesisData.functional_exam.functional_limitations.join(', ')}\n`;
        }
        if (anamnesisData.functional_exam.rom_assessment) compiledText += `Evaluaci√≥n ROM: ${anamnesisData.functional_exam.rom_assessment}\n`;
        if (anamnesisData.functional_exam.strength_assessment) compiledText += `Evaluaci√≥n de fuerza: ${anamnesisData.functional_exam.strength_assessment}\n`;
        if (anamnesisData.functional_exam.special_tests) compiledText += `Pruebas especiales: ${anamnesisData.functional_exam.special_tests}\n`;
        if (anamnesisData.functional_exam.additional_notes) compiledText += `Hallazgos adicionales: ${anamnesisData.functional_exam.additional_notes}\n`;
    }
    
    document.getElementById('compiled_anamnesis').value = compiledText;
    return compiledText;
}

function nextStep(step) {
    // Validate current step
    if (currentStep === 1) {
        // Check required patient data fields first
        const name = document.getElementById('name').value.trim();
        const dob = document.getElementById('date_of_birth').value;
        const contact = document.getElementById('contact').value.trim();
        const diagnosis = document.getElementById('diagnosis').value.trim();
        
        if (!name || !dob || !contact || !diagnosis) {
            alert('{{ _("Please fill in all required patient data fields (Name, Date of Birth, Contact, and Diagnosis).") }}');
            // Switch to the patient data tab
            const personalDataTab = new bootstrap.Tab(document.getElementById('personal-data-tab'));
            personalDataTab.show();
            return;
        }
        
        // Check if at least the chief complaint is filled
        const chiefComplaint = document.getElementById('anamnesis_chief_complaint').value.trim();
        if (!chiefComplaint) {
            alert('{{ _("Please complete at least the main reason for consultation before proceeding.") }}');
            // Switch to the chief complaint tab
            const chiefComplaintTab = new bootstrap.Tab(document.getElementById('chief-complaint-tab'));
            chiefComplaintTab.show();
            return;
        }
        // Compile anamnesis data
        compileAnamnesis();
    }
    
    // Hide current step
    document.getElementById('step' + currentStep).classList.remove('active');
    document.getElementById('step' + currentStep + '-indicator').classList.remove('active');
    document.getElementById('step' + currentStep + '-indicator').classList.add('completed');
    
    // Show next step
    currentStep = step;
    document.getElementById('step' + currentStep).classList.add('active');
    document.getElementById('step' + currentStep + '-indicator').classList.add('active');
}

function prevStep(step) {
    // Hide current step
    document.getElementById('step' + currentStep).classList.remove('active');
    document.getElementById('step' + currentStep + '-indicator').classList.remove('active');
    
    // Show previous step
    currentStep = step;
    document.getElementById('step' + currentStep).classList.add('active');
    document.getElementById('step' + currentStep + '-indicator').classList.add('active');
    document.getElementById('step' + currentStep + '-indicator').classList.remove('completed');
}

// Form validation before submit
document.getElementById('newPatientForm').addEventListener('submit', function(e) {
    // Compile anamnesis one more time before submitting
    const compiledAnamnesis = compileAnamnesis();
    
    // Check required patient data fields
    const name = document.getElementById('name').value.trim();
    const dob = document.getElementById('date_of_birth').value;
    const contact = document.getElementById('contact').value.trim();
    const diagnosis = document.getElementById('diagnosis').value.trim();
    
    if (!name || !dob || !contact || !diagnosis) {
        e.preventDefault();
        alert('{{ _("Please fill in all required patient data fields before creating the patient record.") }}');
        prevStep(1);
        const personalDataTab = new bootstrap.Tab(document.getElementById('personal-data-tab'));
        personalDataTab.show();
        return false;
    }
    
    // Check if at least the chief complaint is filled
    const chiefComplaint = document.getElementById('anamnesis_chief_complaint').value.trim();
    if (!chiefComplaint) {
        e.preventDefault();
        alert('{{ _("Main reason for consultation is required before creating a patient record.") }}');
        prevStep(1);
        // Switch to the chief complaint tab
        const chiefComplaintTab = new bootstrap.Tab(document.getElementById('chief-complaint-tab'));
        chiefComplaintTab.show();
        return false;
    }
});

// Add tab completion indicators
document.addEventListener('DOMContentLoaded', function() {
    // Add change listeners to mark tabs as completed
    const tabs = [
        'personal-data', 'chief-complaint', 'medical-history', 
        'family-history', 'lifestyle', 'current-pain', 'functional-exam'
    ];
    
    tabs.forEach(function(tabId) {
        const tabPane = document.getElementById(tabId);
        const inputs = tabPane.querySelectorAll('input, textarea, select');
        
        inputs.forEach(function(input) {
            input.addEventListener('change', function() {
                updateTabCompletion(tabId);
            });
        });
    });
});

function updateTabCompletion(tabId) {
    const tabPane = document.getElementById(tabId);
    const inputs = tabPane.querySelectorAll('input, textarea, select');
    const tab = document.getElementById(tabId + '-tab');
    
    let hasContent = false;
    inputs.forEach(function(input) {
        if (input.value.trim() !== '') {
            hasContent = true;
        }
    });
    
    if (hasContent) {
        tab.classList.add('text-success');
        if (!tab.querySelector('.bi-check-circle')) {
            const icon = document.createElement('i');
            icon.className = 'bi bi-check-circle ms-1';
            tab.appendChild(icon);
        }
    } else {
        tab.classList.remove('text-success');
        const checkIcon = tab.querySelector('.bi-check-circle');
        if (checkIcon) {
            checkIcon.remove();
        }
    }
}

// ==== SMART CLINICAL SUGGESTIONS SYSTEM ====

let currentSuggestions = [];
let suggestionTimeouts = {};

// Ensure welcome panel stays visible
function ensureWelcomePanelVisible() {
    const welcomePanel = document.getElementById('welcome-suggestions-panel');
    if (welcomePanel) {
        // Remove any classes that might hide it
        welcomePanel.classList.remove('fade', 'd-none', 'hidden');
        welcomePanel.style.display = '';
        welcomePanel.style.visibility = 'visible';
        welcomePanel.style.opacity = '1';
        
        // Prevent any click events that might dismiss it
        welcomePanel.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        console.log('Welcome panel forced to be visible');
    } else {
        console.log('Welcome panel not found');
    }
    
    // Also ensure it stays visible every 5 seconds
    setInterval(() => {
        const panel = document.getElementById('welcome-suggestions-panel');
        if (panel && (panel.style.display === 'none' || !panel.offsetParent)) {
            console.log('Re-showing welcome panel');
            panel.style.display = '';
            panel.style.visibility = 'visible';
            panel.style.opacity = '1';
        }
    }, 5000);
}

// Initialize suggestion monitoring
            document.body.appendChild(welcomePanel);
        }
    } else {
        // Make sure it's visible
        console.log('Welcome panel exists, ensuring visibility...');
        welcomePanel.style.display = '';
        welcomePanel.style.visibility = 'visible';
        // Prevent Bootstrap from auto-closing
        welcomePanel.classList.remove('fade');
    }
    
    // Check if suggestions panel exists
    let suggestionsPanel = document.getElementById('suggestions-panel');
    if (!suggestionsPanel) {
        console.log('Creating suggestions panel...');
        suggestionsPanel = document.createElement('div');
        suggestionsPanel.id = 'suggestions-panel';
        suggestionsPanel.className = 'alert alert-info mt-3';
        suggestionsPanel.style.display = 'none';
        suggestionsPanel.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="bi bi-lightbulb-fill text-warning fs-4"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-2">
                        <i class="bi bi-robot"></i> Sugerencias Cl√≠nicas Inteligentes
                    </h6>
                    <div id="suggestions-content"></div>
                </div>
                <button type="button" class="btn-close" onclick="hideSuggestions()"></button>
            </div>
        `;
        
        // Insert after welcome panel or before tab content
        const welcomePanelRef = document.getElementById('welcome-suggestions-panel');
        const tabContent = document.getElementById('anamnesisTabContent');
        
        if (welcomePanelRef) {
            welcomePanelRef.parentNode.insertBefore(suggestionsPanel, welcomePanelRef.nextSibling);
        } else if (tabContent) {
            tabContent.parentNode.insertBefore(suggestionsPanel, tabContent);
        } else {
            document.body.appendChild(suggestionsPanel);
        }
    } else {
        console.log('Suggestions panel exists, ensuring proper state...');
        // Make sure it has the content div
        if (!document.getElementById('suggestions-content')) {
            const contentDiv = document.createElement('div');
            contentDiv.id = 'suggestions-content';
            const parentDiv = suggestionsPanel.querySelector('.flex-grow-1');
            if (parentDiv) {
                parentDiv.appendChild(contentDiv);
            }
        }
    }
    
    console.log('Panels creation/verification complete. Running debug...');
    debugPanels();
}
</script>
{% endblock %}