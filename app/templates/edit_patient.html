<!-- app/templates/edit_patient.html -->
{% extends "base.html" %}

{% block title %}{{ _('Edit') }} {{ patient.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-person-gear"></i> {{ _('Edit Patient Details') }}
                    </h5>
                    <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-left"></i> {{ _('Back to Patient') }}
                    </a>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('main.edit_patient', id=patient.id) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                            <!-- Personal Information Section -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">{{ _('Personal Information') }}</h6>
                                <div class="mb-3">
                                    <label for="name" class="form-label">{{ _('Full Name') }}</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="name" 
                                           name="name" 
                                           value="{{ patient.name }}" 
                                           required>
                                </div>

                                <div class="mb-3">
                                    <label for="date_of_birth" class="form-label">{{ _('Date of Birth') }}</label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="date_of_birth" 
                                           name="date_of_birth" 
                                           value="{{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else '' }}" 
                                           required>
                                </div>

                                <div class="mb-3">
                                    <label for="contact" class="form-label">{{ _('Contact Information') }}</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="contact" 
                                           name="contact" 
                                           value="{{ patient.contact }}" 
                                           required>
                                    <div class="form-text">{{ _('Phone number or email address') }}</div>
                                </div>

                                <div class="mb-3">
                                    <label for="status" class="form-label">{{ _('Status') }}</label>
                                    <select class="form-select" id="status" name="status" required>
                                        <option value="Active" {% if patient.status == 'Active' %}selected{% endif %}>
                                            {{ _('Active') }}
                                        </option>
                                        <option value="Inactive" {% if patient.status == 'Inactive' %}selected{% endif %}>
                                            {{ _('Inactive') }}
                                        </option>
                                        <option value="Completed" {% if patient.status == 'Completed' %}selected{% endif %}>
                                            {{ _('Treatment Completed') }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            
                                </div>

                        <hr class="my-4">

                        <!-- Anamnesis Section - Improved Design -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card shadow-sm border-0">
                                    <div class="card-header bg-gradient-primary text-white">
                                        <h5 class="mb-0">
                                            <i class="bi bi-journal-medical me-2"></i>
                                            {{ _('Clinical History (Anamnesis)') }}
                                        </h5>
                                        <small class="opacity-75">{{ _('Update the clinical assessment information') }}</small>
                                </div>
                                    <div class="card-body p-4">
                                        
                                        <!-- Progress Indicator -->
                                        <div class="anamnesis-progress mb-4">
                                            <div class="progress-header d-flex justify-content-between align-items-center mb-2">
                                                <span class="text-muted">{{ _('Assessment Progress') }}</span>
                                                <span class="badge bg-primary" id="edit-progress-percentage">0%</span>
                                </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-success" role="progressbar" id="edit-anamnesis-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>

                                        <!-- Essential Information (Always visible) -->
                                        <div class="essential-info mb-4">
                                            <h6 class="section-title">
                                                <i class="bi bi-exclamation-circle-fill text-danger me-2"></i>
                                                {{ _('Essential Information') }}
                                                <span class="required-badge">{{ _('Required') }}</span>
                                            </h6>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="edit_anamnesis_chief_complaint" class="form-label fw-semibold">
                                                        <i class="bi bi-chat-dots text-primary me-1"></i>
                                                        {{ _('Chief Complaint') }} <span class="text-danger">*</span>
                                                    </label>
                                                    <textarea class="form-control" id="edit_anamnesis_chief_complaint" name="anamnesis_chief_complaint" 
                                                              rows="3" required
                                                              placeholder="{{ _('What is the main reason for this visit? (e.g., Lower back pain for 2 weeks...)') }}"
                                                              onchange="updateEditProgress()"></textarea>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="edit_anamnesis_pain_scale" class="form-label fw-semibold">
                                                        <i class="bi bi-thermometer-half text-warning me-1"></i>
                                                        {{ _('Current Pain Level') }} <span class="text-danger">*</span>
                                                    </label>
                                                    <div class="pain-scale-container">
                                                        <input type="range" class="form-range" id="edit_anamnesis_pain_scale" name="anamnesis_pain_scale" 
                                                               min="0" max="10" value="0" required
                                                               oninput="updateEditPainDisplay(this.value); updateEditProgress()">
                                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                                            <small class="text-muted">ðŸ˜Š 0</small>
                                                            <div class="text-center">
                                                                <span id="edit-pain-display" class="badge bg-success fs-6">0</span>
                                                                <div><small id="edit-pain-description">{{ _('No pain') }}</small></div>
                                                            </div>
                                                            <small class="text-muted">ðŸ˜µ 10</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="row g-3 mt-2">
                                                <div class="col-md-4">
                                                    <label for="edit_anamnesis_onset_date" class="form-label fw-semibold">
                                                        <i class="bi bi-calendar-event text-info me-1"></i>
                                                        {{ _('When did it start?') }}
                                                    </label>
                                                    <input type="date" class="form-control" id="edit_anamnesis_onset_date" name="anamnesis_onset_date" 
                                                           onchange="updateEditProgress()">
                                                </div>
                                                <div class="col-md-8">
                                                    <label for="edit_anamnesis_mechanism" class="form-label fw-semibold">
                                                        <i class="bi bi-gear text-secondary me-1"></i>
                                                        {{ _('How did it happen?') }}
                                                    </label>
                                                    <input type="text" class="form-control" id="edit_anamnesis_mechanism" name="anamnesis_mechanism" 
                                                           placeholder="{{ _('e.g., Lifting heavy box, fell down stairs, gradual onset...') }}"
                                                           onchange="updateEditProgress()">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Collapsible Sections -->
                                        <div class="accordion anamnesis-accordion" id="editAnamnesisAccordion">

                                            <!-- Clinical Assessment & Diagnosis -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                                            data-bs-target="#edit-clinical-assessment" aria-expanded="true">
                                                        <i class="bi bi-clipboard-pulse me-2 text-success"></i>
                                                        <span class="me-auto">{{ _('Clinical Assessment & Diagnosis') }}</span>
                                                        <span class="badge bg-warning ms-2">{{ _('Important') }}</span>
                                        </button>
                                                </h2>
                                                <div id="edit-clinical-assessment" class="accordion-collapse collapse show" data-bs-parent="#editAnamnesisAccordion">
                                                    <div class="accordion-body">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                                                <label for="edit_diagnosis" class="form-label fw-semibold">
                                                                    <i class="bi bi-clipboard-check text-success me-1"></i>
                                                                    {{ _('Primary Diagnosis') }}
                                                                </label>
                                                                <input type="text" class="form-control" id="edit_diagnosis" name="diagnosis" 
                                                                       value="{{ patient.diagnosis }}" required
                                                                       placeholder="{{ _('e.g., Lower back pain, Cervical strain...') }}"
                                                                       onchange="updateEditProgress()">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="edit_assessment_date" class="form-label fw-semibold">
                                                                    <i class="bi bi-calendar-check text-info me-1"></i>
                                                                    {{ _('Assessment Date') }}
                                                                </label>
                                                                <input type="date" class="form-control" id="edit_assessment_date" name="assessment_date" 
                                                                       value="{{ patient.created_at.strftime('%Y-%m-%d') if patient.created_at else '' }}"
                                                                       onchange="updateEditProgress()">
                                                            </div>
                                                            <div class="col-12">
                                                                <label for="edit_treatment_plan" class="form-label fw-semibold">
                                                                    <i class="bi bi-graph-up text-primary me-1"></i>
                                                                    {{ _('Treatment Plan & Strategy') }}
                                                                </label>
                                                                <textarea class="form-control" id="edit_treatment_plan" name="treatment_plan" 
                                                                          rows="4" placeholder="{{ _('Detailed treatment approach, goals, and expected timeline...') }}"
                                                                          onchange="updateEditProgress()">{{ patient.treatment_plan }}</textarea>
                                                            </div>
                                                            <div class="col-12">
                                                                <label for="edit_clinical_notes" class="form-label fw-semibold">
                                                                    <i class="bi bi-journal-text text-secondary me-1"></i>
                                                                    {{ _('Clinical Notes & Observations') }}
                                                                </label>
                                                                <textarea class="form-control" id="edit_clinical_notes" name="notes" 
                                                                          rows="3" placeholder="{{ _('Additional clinical observations, progress notes...') }}"
                                                                          onchange="updateEditProgress()">{{ patient.notes }}</textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Personal Information Accordion -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                            data-bs-target="#edit-personal-info" aria-expanded="false">
                                                        <i class="bi bi-person-circle me-2 text-info"></i>
                                                        <span class="me-auto">{{ _('Personal Information') }}</span>
                                                        <span class="badge bg-secondary ms-2">{{ _('Optional') }}</span>
                                                    </button>
                                                </h2>
                                                <div id="edit-personal-info" class="accordion-collapse collapse" data-bs-parent="#editAnamnesisAccordion">
                                                    <div class="accordion-body">
                                                        <div class="row g-3">
                                                            <div class="col-md-4">
                                                <label for="edit_anamnesis_age" class="form-label">{{ _('Age') }}</label>
                                                                <input type="number" class="form-control" id="edit_anamnesis_age" name="anamnesis_age" 
                                                                       min="0" max="120" onchange="updateEditProgress()">
                                            </div>
                                                            <div class="col-md-4">
                                                <label for="edit_anamnesis_gender" class="form-label">{{ _('Gender') }}</label>
                                                                <select class="form-select" id="edit_anamnesis_gender" name="anamnesis_gender" onchange="updateEditProgress()">
                                                    <option value="">{{ _('Select gender') }}</option>
                                                    <option value="male">{{ _('Male') }}</option>
                                                    <option value="female">{{ _('Female') }}</option>
                                                    <option value="other">{{ _('Other') }}</option>
                                                    <option value="prefer_not_to_say">{{ _('Prefer not to say') }}</option>
                                                </select>
                                            </div>
                                                            <div class="col-md-4">
                                                <label for="edit_anamnesis_occupation" class="form-label">{{ _('Occupation') }}</label>
                                                                <input type="text" class="form-control" id="edit_anamnesis_occupation" name="anamnesis_occupation" 
                                                                       placeholder="{{ _('Current job/profession') }}" onchange="updateEditProgress()">
                                            </div>
                                                            <div class="col-12">
                                                <label for="edit_anamnesis_emergency_contact" class="form-label">{{ _('Emergency Contact') }}</label>
                                                                <input type="text" class="form-control" id="edit_anamnesis_emergency_contact" name="anamnesis_emergency_contact" 
                                                                       placeholder="{{ _('Name and phone number') }}" onchange="updateEditProgress()">
                                            </div>
                                        </div>
                                    </div>
                                        </div>
                                    </div>

                                            <!-- Medical History Accordion -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                            data-bs-target="#edit-medical-history" aria-expanded="false">
                                                        <i class="bi bi-clipboard-heart me-2 text-danger"></i>
                                                        <span class="me-auto">{{ _('Medical History') }}</span>
                                                        <span class="badge bg-warning ms-2">{{ _('Important') }}</span>
                                                    </button>
                                                </h2>
                                                <div id="edit-medical-history" class="accordion-collapse collapse" data-bs-parent="#editAnamnesisAccordion">
                                                    <div class="accordion-body">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                                                <label for="edit_anamnesis_previous_conditions" class="form-label">{{ _('Previous conditions') }}</label>
                                                                <textarea class="form-control" id="edit_anamnesis_previous_conditions" name="anamnesis_previous_conditions" 
                                                                          rows="3" placeholder="{{ _('Previous medical conditions, diagnoses...') }}" 
                                                                          onchange="updateEditProgress()"></textarea>
                                        </div>
                                                            <div class="col-md-6">
                                            <label for="edit_anamnesis_surgeries" class="form-label">{{ _('Previous surgeries') }}</label>
                                                                <textarea class="form-control" id="edit_anamnesis_surgeries" name="anamnesis_surgeries" 
                                                                          rows="3" placeholder="{{ _('List any surgeries with dates...') }}" 
                                                                          onchange="updateEditProgress()"></textarea>
                                        </div>
                                                            <div class="col-md-6">
                                            <label for="edit_anamnesis_medications" class="form-label">{{ _('Current medications') }}</label>
                                                                <textarea class="form-control" id="edit_anamnesis_medications" name="anamnesis_medications" 
                                                                          rows="3" placeholder="{{ _('Prescription drugs, supplements...') }}" 
                                                                          onchange="updateEditProgress()"></textarea>
                                        </div>
                                                            <div class="col-md-6">
                                            <label for="edit_anamnesis_allergies" class="form-label">{{ _('Allergies') }}</label>
                                                                <textarea class="form-control" id="edit_anamnesis_allergies" name="anamnesis_allergies" 
                                                                          rows="3" placeholder="{{ _('Food, medication, environmental...') }}" 
                                                                          onchange="updateEditProgress()"></textarea>
                                        </div>
                                    </div>
                                        </div>
                                        </div>
                                    </div>

                                            <!-- Pain & Symptoms Details Accordion -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                            data-bs-target="#edit-pain-details" aria-expanded="false">
                                                        <i class="bi bi-bandaid me-2 text-warning"></i>
                                                        <span class="me-auto">{{ _('Pain & Symptoms Details') }}</span>
                                                        <span class="badge bg-info ms-2">{{ _('Helpful') }}</span>
                                                    </button>
                                                </h2>
                                                <div id="edit-pain-details" class="accordion-collapse collapse" data-bs-parent="#editAnamnesisAccordion">
                                                    <div class="accordion-body">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                                <label for="edit_anamnesis_pain_type" class="form-label">{{ _('Type of pain') }}</label>
                                                <input type="text" class="form-control" id="edit_anamnesis_pain_type" name="anamnesis_pain_type" 
                                                                       placeholder="{{ _('e.g., sharp, dull, burning, throbbing') }}" onchange="updateEditProgress()">
                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="edit_anamnesis_pain_location" class="form-label">{{ _('Pain location') }}</label>
                                                                <input type="text" class="form-control" id="edit_anamnesis_pain_location" name="anamnesis_pain_location" 
                                                                       placeholder="{{ _('Where is the pain located?') }}" onchange="updateEditProgress()">
                                                            </div>
                                                            <div class="col-md-6">
                                                <label for="edit_anamnesis_pain_triggers" class="form-label">{{ _('What makes it worse?') }}</label>
                                                <input type="text" class="form-control" id="edit_anamnesis_pain_triggers" name="anamnesis_pain_triggers" 
                                                                       placeholder="{{ _('Activities, positions, times...') }}" onchange="updateEditProgress()">
                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="edit_anamnesis_pain_relievers" class="form-label">{{ _('What helps?') }}</label>
                                                <input type="text" class="form-control" id="edit_anamnesis_pain_relievers" name="anamnesis_pain_relievers" 
                                                                       placeholder="{{ _('Rest, heat, cold, positions...') }}" onchange="updateEditProgress()">
                                            </div>
                                        </div>
                                                    </div>
                                        </div>
                                    </div>

                                            <!-- Functional Assessment Accordion -->
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                            data-bs-target="#edit-functional-assessment" aria-expanded="false">
                                                        <i class="bi bi-activity me-2 text-success"></i>
                                                        <span class="me-auto">{{ _('Functional Assessment') }}</span>
                                                        <span class="badge bg-secondary ms-2">{{ _('Optional') }}</span>
                                                    </button>
                                                </h2>
                                                <div id="edit-functional-assessment" class="accordion-collapse collapse" data-bs-parent="#editAnamnesisAccordion">
                                                    <div class="accordion-body">
                                                        <div class="row g-3">
                                                            <div class="col-md-6">
                                            <label for="edit_anamnesis_functional_limitations" class="form-label">{{ _('Functional limitations') }}</label>
                                                                <textarea class="form-control" id="edit_anamnesis_functional_limitations" name="anamnesis_functional_limitations" 
                                                                          rows="3" placeholder="{{ _('Activities that are difficult...') }}" 
                                                                          onchange="updateEditProgress()"></textarea>
                                        </div>
                                                            <div class="col-md-6">
                                                                <label for="edit_anamnesis_physical_activity" class="form-label">{{ _('Activity level') }}</label>
                                                                <select class="form-select" id="edit_anamnesis_physical_activity" name="anamnesis_physical_activity" onchange="updateEditProgress()">
                                                                    <option value="">{{ _('Select activity level') }}</option>
                                                                    <option value="sedentary">{{ _('Sedentary') }}</option>
                                                                    <option value="light">{{ _('Light (1-3 days/week)') }}</option>
                                                                    <option value="moderate">{{ _('Moderate (3-5 days/week)') }}</option>
                                                                    <option value="active">{{ _('Very active (6-7 days/week)') }}</option>
                                                                </select>
                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="edit_anamnesis_work_posture" class="form-label">{{ _('Work environment') }}</label>
                                                                <input type="text" class="form-control" id="edit_anamnesis_work_posture" name="anamnesis_work_posture" 
                                                                       placeholder="{{ _('e.g., desk job, standing, physical labor') }}" onchange="updateEditProgress()">
                                            </div>
                                                            <div class="col-md-6">
                                                                <label for="edit_anamnesis_sleep" class="form-label">{{ _('Sleep quality') }}</label>
                                                                <select class="form-select" id="edit_anamnesis_sleep" name="anamnesis_sleep" onchange="updateEditProgress()">
                                                                    <option value="">{{ _('Select sleep quality') }}</option>
                                                                    <option value="excellent">{{ _('Excellent') }}</option>
                                                                    <option value="good">{{ _('Good') }}</option>
                                                                    <option value="fair">{{ _('Fair') }}</option>
                                                                    <option value="poor">{{ _('Poor') }}</option>
                                                                </select>
                                        </div>
                                                        </div>
                                                    </div>
                                        </div>
                                    </div>
                                </div>

                                        <!-- Progress Summary -->
                                        <div class="anamnesis-summary mt-4 p-3 bg-light rounded">
                                            <h6 class="text-muted mb-2">{{ _('Assessment Summary') }}</h6>
                                            <div id="edit-summary-content" class="text-muted small">
                                                {{ _('Complete the essential information above to see a summary...') }}
                                            </div>
                                        </div>

                                <!-- Hidden field to store compiled anamnesis -->
                                <input type="hidden" id="edit_compiled_anamnesis" name="anamnesis">
                                    </div>
                                </div>
                            </div>
                        </div>

                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Patient Portal Access Section -->
                        <h5 class="mb-3">{{ _('Patient Portal Access') }}</h5>
                        <p class="text-muted small">{{ _("Manage the patient's login credentials to access their exercise prescriptions.") }}</p>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="patient_email" class="form-label">{{ _('Login Email') }}</label>
                                <input type="email" class="form-control" id="patient_email" name="patient_email" 
                                       value="{{ patient.portal_user_account.email if patient.portal_user_account else '' }}" 
                                       placeholder="patient.login@example.com">
                                {% if not patient.portal_user_account %}
                                <small class="form-text text-info">{{ _('Enter an email and password below to create a login.') }}</small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="patient_password" class="form-label">{{ _('New Password') }}</label>
                                <input type="password" class="form-control" id="patient_password" name="patient_password" 
                                       placeholder="{{ _('Leave blank to keep current password') }}">
                                <small class="form-text text-muted">{{ _('Only enter a new password if you want to change it.') }}</small>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <div>
                                <button type="button" class="btn btn-outline-warning me-2" data-bs-toggle="modal" data-bs-target="#mergePatientModal" data-patient-id="{{ patient.id }}">
                                    <i class="bi bi-arrow-left-right"></i> {{ _('Merge Patient') }}
                                </button>
                                <button type="button" class="btn btn-outline-danger me-2" data-bs-toggle="modal" data-bs-target="#confirmDelete">
                                    <i class="bi bi-trash"></i> {{ _('Delete Patient') }}
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#confirmCancel">
                                    <i class="bi bi-x-circle"></i> {{ _('Cancel') }}
                                </button>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {{ _('Save Changes') }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDelete" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Confirm Delete') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('Are you sure you want to permanently delete this patient? This action cannot be undone.') }}</p>
            </div>
            <div class="modal-footer">
                <form action="{{ url_for('main.delete_patient', id=patient.id) }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-danger">{{ _('Yes, Delete') }}</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Cancel Modal -->
<div class="modal fade" id="confirmCancel" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Confirm Cancel') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('Are you sure you want to cancel? Any unsaved changes will be lost.') }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('No, Continue Editing') }}</button>
                <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-danger">{{ _('Yes, Cancel') }}</a>
            </div>
        </div>
    </div>
</div>

<!-- Merge Patient Modal -->
<div class="modal fade" id="mergePatientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Merge Patient') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    {{ _('This will merge the current patient (') }}<strong>{{ patient.name }}</strong>{{ _(') with another patient profile. All treatments, reports, and data will be transferred to the target patient, and this patient will be deleted.') }}
                </div>
                
                <div class="mb-3">
                    <label for="targetPatientSearch" class="form-label">{{ _('Search for target patient to merge with:') }}</label>
                    <input type="text" 
                           class="form-control" 
                           id="targetPatientSearch" 
                           placeholder="{{ _('Enter patient name or contact information...') }}">
                    <div class="form-text">{{ _('Start typing to search for patients') }}</div>
                </div>
                
                <div id="searchResults" class="mb-3" style="display: none;">
                    <h6>{{ _('Search Results:') }}</h6>
                    <div class="list-group" id="patientSearchResults">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
                
                <div id="selectedTarget" class="mb-3" style="display: none;">
                    <h6>{{ _('Selected Target Patient:') }}</h6>
                    <div class="card">
                        <div class="card-body">
                            <div id="targetPatientInfo">
                                <!-- Selected patient info will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-warning" id="confirmMergeBtn" disabled>
                    <i class="bi bi-arrow-left-right"></i> {{ _('Confirm Merge') }}
                </button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Function to compile all anamnesis fields into one (same as new patient)
    function compileAnamnesis() {
        console.log('DEBUG: Starting compileAnamnesis() for edit form');
        
        // Helper function to safely get element value
        function safeGetValue(elementId) {
            const element = document.getElementById(elementId);
            const value = element ? element.value.trim() : '';
            console.log(`DEBUG: ${elementId} = "${value}"`);
            return value;
        }
        
        const anamnesisData = {
            personal_data: {
                age: safeGetValue('edit_anamnesis_age'),
                gender: safeGetValue('edit_anamnesis_gender'),
                occupation: safeGetValue('edit_anamnesis_occupation'),
                emergency_contact: safeGetValue('edit_anamnesis_emergency_contact')
            },
            chief_complaint: {
                main_complaint: safeGetValue('edit_anamnesis_chief_complaint'),
                onset: safeGetValue('edit_anamnesis_onset'),
                mechanism: safeGetValue('edit_anamnesis_mechanism')
            },
            medical_history: {
                previous_conditions: safeGetValue('edit_anamnesis_previous_conditions'),
                surgeries: safeGetValue('edit_anamnesis_surgeries'),
                medications: safeGetValue('edit_anamnesis_medications'),
                allergies: safeGetValue('edit_anamnesis_allergies')
            },
            family_history: {
                family_history: safeGetValue('edit_anamnesis_family_history')
            },
            lifestyle: {
                physical_activity: safeGetValue('edit_anamnesis_physical_activity'),
                sleep: safeGetValue('edit_anamnesis_sleep'),
                work_posture: safeGetValue('edit_anamnesis_work_posture'),
                stress_level: safeGetValue('edit_anamnesis_stress_level'),
                diet_habits: safeGetValue('edit_anamnesis_diet_habits')
            },
            pain_details: {
                pain_scale: safeGetValue('edit_anamnesis_pain_scale'),
                pain_type: safeGetValue('edit_anamnesis_pain_type'),
                pain_location: safeGetValue('edit_anamnesis_pain_location'),
                pain_triggers: safeGetValue('edit_anamnesis_pain_triggers'),
                pain_relievers: safeGetValue('edit_anamnesis_pain_relievers')
            },
            functional_assessment: {
                functional_limitations: safeGetValue('edit_anamnesis_functional_limitations'),
                onset_date: safeGetValue('edit_anamnesis_onset_date')
            },
            metadata: {
                form_version: '2.0_edit',
                updated_date: new Date().toISOString()
            }
        };

        // Convert to JSON and update the hidden field
        const compiledField = document.getElementById('edit_compiled_anamnesis');
        if (compiledField) {
            const jsonString = JSON.stringify(anamnesisData, null, 2);
            compiledField.value = jsonString;
            console.log('DEBUG: Anamnesis compiled successfully for edit form. Length:', jsonString.length);
            console.log('DEBUG: Compiled data:', jsonString);
            return jsonString;
        } else {
            console.error('ERROR: edit_compiled_anamnesis field not found!');
            return '';
        }
    }

    // Function to parse existing anamnesis and populate fields
    function parseExistingAnamnesis() {
        const existingAnamnesis = `{{ patient.anamnesis if patient.anamnesis else '' }}`;
        if (!existingAnamnesis) return;

        // Parse the structured anamnesis text
        const sections = existingAnamnesis.split('===');
        
        sections.forEach(section => {
            const lines = section.trim().split('\n').filter(line => line.trim());
            if (lines.length === 0) return;
            
            const sectionTitle = lines[0].trim();
            
            if (sectionTitle.includes('DATOS PERSONALES')) {
                lines.slice(1).forEach(line => {
                    if (line.includes('Edad:')) {
                        const age = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_age').value = age;
                    } else if (line.includes('GÃ©nero:')) {
                        const gender = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_gender').value = gender;
                    } else if (line.includes('OcupaciÃ³n:')) {
                        const occupation = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_occupation').value = occupation;
                    } else if (line.includes('Contacto de emergencia:')) {
                        const contact = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_emergency_contact').value = contact;
                    }
                });
            } else if (sectionTitle.includes('MOTIVO DE CONSULTA')) {
                lines.slice(1).forEach(line => {
                    if (line.includes('Motivo principal:')) {
                        const complaint = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_chief_complaint').value = complaint;
                    } else if (line.includes('Inicio:')) {
                        const onset = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_onset').value = onset;
                    } else if (line.includes('Mecanismo:')) {
                        const mechanism = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_mechanism').value = mechanism;
                    }
                });
            } else if (sectionTitle.includes('HISTORIA MÃ‰DICA')) {
                lines.slice(1).forEach(line => {
                    if (line.includes('Condiciones previas:')) {
                        const conditions = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_previous_conditions').value = conditions;
                    } else if (line.includes('CirugÃ­as:')) {
                        const surgeries = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_surgeries').value = surgeries;
                    } else if (line.includes('MedicaciÃ³n actual:')) {
                        const medications = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_medications').value = medications;
                    } else if (line.includes('Alergias:')) {
                        const allergies = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_allergies').value = allergies;
                    }
                });
            } else if (sectionTitle.includes('ANTECEDENTES FAMILIARES')) {
                const familyHistory = lines.slice(1).join('\n').trim();
                document.getElementById('edit_anamnesis_family_history').value = familyHistory;
            } else if (sectionTitle.includes('ESTILO DE VIDA')) {
                lines.slice(1).forEach(line => {
                    if (line.includes('Actividad fÃ­sica:')) {
                        const activity = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_physical_activity').value = activity;
                    } else if (line.includes('Calidad del sueÃ±o:')) {
                        const sleep = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_sleep').value = sleep;
                    } else if (line.includes('Postura de trabajo:')) {
                        const posture = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_work_posture').value = posture;
                    } else if (line.includes('Nivel de estrÃ©s:')) {
                        const stress = line.split(':')[1].trim().replace('/10', '');
                        document.getElementById('edit_anamnesis_stress_level').value = stress;
                    } else if (line.includes('HÃ¡bitos alimentarios:')) {
                        const diet = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_diet_habits').value = diet;
                    }
                });
            } else if (sectionTitle.includes('DOLOR ACTUAL')) {
                lines.slice(1).forEach(line => {
                    if (line.includes('Escala de dolor:')) {
                        const scale = line.split(':')[1].trim().replace('/10', '');
                        document.getElementById('edit_anamnesis_pain_scale').value = scale;
                    } else if (line.includes('Tipo de dolor:')) {
                        const type = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_pain_type').value = type;
                    } else if (line.includes('LocalizaciÃ³n:')) {
                        const location = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_pain_location').value = location;
                    } else if (line.includes('Factores que empeoran:')) {
                        const triggers = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_pain_triggers').value = triggers;
                    } else if (line.includes('Factores que mejoran:')) {
                        const relievers = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_pain_relievers').value = relievers;
                    }
                });
            } else if (sectionTitle.includes('EXPLORACIÃ“N FUNCIONAL')) {
                lines.slice(1).forEach(line => {
                    if (line.includes('Limitaciones funcionales:')) {
                        const limitations = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_functional_limitations').value = limitations;
                    } else if (line.includes('Limitaciones ROM:')) {
                        const rom = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_rom_limitations').value = rom;
                    } else if (line.includes('DÃ©ficits de fuerza:')) {
                        const strength = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_strength_deficits').value = strength;
                    } else if (line.includes('Pruebas especiales:')) {
                        const tests = line.split(':')[1].trim();
                        document.getElementById('edit_anamnesis_special_tests').value = tests;
                    }
                });
            }
        });
    }

    // Form validation and handling
    document.addEventListener('DOMContentLoaded', function() {
        // Parse existing anamnesis data
        parseExistingAnamnesis();
        
        const form = document.querySelector('form');
        
        form.addEventListener('submit', function(e) {
            console.log('DEBUG: Form submit triggered for edit patient');
            
            // ALWAYS compile anamnesis before submitting - this is critical!
            const compiledAnamnesis = compileAnamnesis();
            console.log('DEBUG: Anamnesis compilation result:', compiledAnamnesis ? 'SUCCESS' : 'FAILED');
            
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                    console.log('DEBUG: Required field missing:', field.id || field.name);
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Also validate that if email is provided, it's a valid format (basic)
            const emailInput = document.getElementById('patient_email');
            if (emailInput && emailInput.value.trim() && !emailInput.checkValidity()) {
                 isValid = false;
                 emailInput.classList.add('is-invalid');
                 console.log('DEBUG: Invalid email format');
                 // Optionally add a specific message near the email field
            } else if (emailInput) {
                 emailInput.classList.remove('is-invalid');
            }
            
            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required fields correctly.');
                console.log('DEBUG: Form validation failed - submission prevented');
                return false;
            }
            
            console.log('DEBUG: Form validation passed - submitting form');
            return true;
        });

        // Initialize edit form anamnesis functionality
        initializeEditAnamnesisForm();
    });

    // Edit form anamnesis functions
    function initializeEditAnamnesisForm() {
        // Parse existing anamnesis data if available
        const anamnesisField = document.getElementById('edit_compiled_anamnesis');
        if (anamnesisField && anamnesisField.value) {
            try {
                const existingData = JSON.parse(anamnesisField.value);
                populateEditFormFromAnamnesis(existingData);
            } catch (e) {
                console.log('Legacy anamnesis format, keeping as-is');
            }
        }
        
        // Initial progress update
        updateEditProgress();
    }

    function populateEditFormFromAnamnesis(data) {
        // Essential Information
        if (data.chief_complaint) document.getElementById('edit_anamnesis_chief_complaint').value = data.chief_complaint;
        if (data.pain_scale !== undefined) {
            document.getElementById('edit_anamnesis_pain_scale').value = data.pain_scale;
            updateEditPainDisplay(data.pain_scale);
        }
        if (data.onset_date) document.getElementById('edit_anamnesis_onset_date').value = data.onset_date;
        if (data.mechanism) document.getElementById('edit_anamnesis_mechanism').value = data.mechanism;
        
        // Personal Information
        if (data.personal_data.age) document.getElementById('edit_anamnesis_age').value = data.personal_data.age;
        if (data.personal_data.gender) document.getElementById('edit_anamnesis_gender').value = data.personal_data.gender;
        if (data.personal_data.occupation) document.getElementById('edit_anamnesis_occupation').value = data.personal_data.occupation;
        if (data.personal_data.emergency_contact) document.getElementById('edit_anamnesis_emergency_contact').value = data.personal_data.emergency_contact;
        
        // Medical History
        if (data.medical_history.previous_conditions) document.getElementById('edit_anamnesis_previous_conditions').value = data.medical_history.previous_conditions;
        if (data.medical_history.surgeries) document.getElementById('edit_anamnesis_surgeries').value = data.medical_history.surgeries;
        if (data.medical_history.medications) document.getElementById('edit_anamnesis_medications').value = data.medical_history.medications;
        if (data.medical_history.allergies) document.getElementById('edit_anamnesis_allergies').value = data.medical_history.allergies;
        
        // Pain Details
        if (data.pain_details.pain_type) document.getElementById('edit_anamnesis_pain_type').value = data.pain_details.pain_type;
        if (data.pain_details.pain_location) document.getElementById('edit_anamnesis_pain_location').value = data.pain_details.pain_location;
        if (data.pain_details.pain_triggers) document.getElementById('edit_anamnesis_pain_triggers').value = data.pain_details.pain_triggers;
        if (data.pain_details.pain_relievers) document.getElementById('edit_anamnesis_pain_relievers').value = data.pain_details.pain_relievers;
        
        // Functional Assessment
        if (data.functional_assessment.functional_limitations) document.getElementById('edit_anamnesis_functional_limitations').value = data.functional_assessment.functional_limitations;
        if (data.functional_assessment.onset_date) document.getElementById('edit_anamnesis_onset_date').value = data.functional_assessment.onset_date;
        if (data.physical_activity) document.getElementById('edit_anamnesis_physical_activity').value = data.physical_activity;
        if (data.work_posture) document.getElementById('edit_anamnesis_work_posture').value = data.work_posture;
        if (data.sleep) document.getElementById('edit_anamnesis_sleep').value = data.sleep;
    }

    function updateEditProgress() {
        const essentialFields = [
            'edit_anamnesis_chief_complaint',
            'edit_anamnesis_pain_scale'
        ];
        
        const importantFields = [
            'edit_diagnosis',
            'edit_treatment_plan',
            'edit_anamnesis_onset_date',
            'edit_anamnesis_mechanism',
            'edit_anamnesis_previous_conditions',
            'edit_anamnesis_medications'
        ];
        
        const helpfulFields = [
            'edit_clinical_notes',
            'edit_assessment_date',
            'edit_anamnesis_pain_type',
            'edit_anamnesis_pain_location',
            'edit_anamnesis_pain_triggers',
            'edit_anamnesis_pain_relievers'
        ];
        
        const optionalFields = [
            'edit_anamnesis_gender',
            'edit_anamnesis_occupation',
            'edit_anamnesis_functional_limitations',
            'edit_anamnesis_physical_activity',
            'edit_anamnesis_age'  // Moved age to end of optional fields - not prioritized
        ];
        
        let essentialCount = 0;
        let importantCount = 0;
        let helpfulCount = 0;
        let optionalCount = 0;
        
        essentialFields.forEach(id => {
            const field = document.getElementById(id);
            if (field && field.value.trim()) essentialCount++;
        });
        
        importantFields.forEach(id => {
            const field = document.getElementById(id);
            if (field && field.value.trim()) importantCount++;
        });
        
        helpfulFields.forEach(id => {
            const field = document.getElementById(id);
            if (field && field.value.trim()) helpfulCount++;
        });
        
        optionalFields.forEach(id => {
            const field = document.getElementById(id);
            if (field && field.value.trim()) optionalCount++;
        });
        
        const totalFields = essentialFields.length + importantFields.length + helpfulFields.length + optionalFields.length;
        const filledFields = essentialCount + importantCount + helpfulCount + optionalCount;
        const percentage = Math.round((filledFields / totalFields) * 100);
        
        const progressBar = document.getElementById('edit-anamnesis-progress-bar');
        const progressText = document.getElementById('edit-progress-percentage');
        
        if (progressBar) {
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
        }
        
        if (progressText) {
            progressText.textContent = percentage + '%';
            progressText.className = 'badge ' + (percentage >= 70 ? 'bg-success' : percentage >= 40 ? 'bg-warning' : 'bg-danger');
        }
        
        updateEditSummary();
        updateEditCompiledAnamnesis();
    }

    function updateEditPainDisplay(value) {
        const display = document.getElementById('edit-pain-display');
        const description = document.getElementById('edit-pain-description');
        
        if (!display || !description) return;
        
        const painLevels = [
            { range: [0, 0], label: 'No pain', class: 'bg-success', emoji: 'ðŸ˜Š' },
            { range: [1, 3], label: 'Mild pain', class: 'bg-info', emoji: 'ðŸ˜' },
            { range: [4, 6], label: 'Moderate pain', class: 'bg-warning', emoji: 'ðŸ˜Ÿ' },
            { range: [7, 8], label: 'Severe pain', class: 'bg-danger', emoji: 'ðŸ˜«' },
            { range: [9, 10], label: 'Extreme pain', class: 'bg-dark', emoji: 'ðŸ˜µ' }
        ];
        
        const level = painLevels.find(l => value >= l.range[0] && value <= l.range[1]);
        
        display.textContent = value;
        display.className = 'badge fs-6 ' + level.class;
        description.textContent = level.emoji + ' ' + level.label;
    }

    function updateEditSummary() {
        const chiefComplaint = document.getElementById('edit_anamnesis_chief_complaint').value.trim();
        const painScale = document.getElementById('edit_anamnesis_pain_scale').value;
        const diagnosis = document.getElementById('edit_diagnosis').value.trim();
        const treatmentPlan = document.getElementById('edit_treatment_plan').value.trim();
        const onset = document.getElementById('edit_anamnesis_onset_date').value;
        const mechanism = document.getElementById('edit_anamnesis_mechanism').value.trim();
        
        const summaryElement = document.getElementById('edit-summary-content');
        if (!summaryElement) return;
        
        if (!chiefComplaint && !diagnosis && !painScale) {
            summaryElement.innerHTML = '<em class="text-muted">Complete the essential information above to see a summary...</em>';
            return;
        }
        
        let summary = '<div class="row g-2">';
        
        if (diagnosis) {
            summary += `<div class="col-md-6"><strong>ðŸ©º Diagnosis:</strong> ${diagnosis}</div>`;
        }
        
        if (chiefComplaint) {
            summary += `<div class="col-md-6"><strong>ðŸ’¬ Chief complaint:</strong> ${chiefComplaint.substring(0, 50)}${chiefComplaint.length > 50 ? '...' : ''}</div>`;
        }
        
        if (painScale) {
            const painLevel = painScale == 0 ? 'No pain' : painScale <= 3 ? 'Mild' : painScale <= 6 ? 'Moderate' : painScale <= 8 ? 'Severe' : 'Extreme';
            summary += `<div class="col-md-6"><strong>âš¡ Pain level:</strong> ${painScale}/10 (${painLevel})</div>`;
        }
        
        if (treatmentPlan) {
            summary += `<div class="col-md-6"><strong>ðŸ“‹ Treatment:</strong> ${treatmentPlan.substring(0, 50)}${treatmentPlan.length > 50 ? '...' : ''}</div>`;
        }
        
        if (onset) {
            summary += `<div class="col-md-6"><strong>ðŸ“… Onset:</strong> ${new Date(onset).toLocaleDateString()}</div>`;
        }
        
        if (mechanism) {
            summary += `<div class="col-md-6"><strong>âš™ï¸ Mechanism:</strong> ${mechanism}</div>`;
        }
        
        summary += '</div>';
        summaryElement.innerHTML = summary;
    }

    function updateEditCompiledAnamnesis() {
        const compiledField = document.getElementById('edit_compiled_anamnesis');
        if (!compiledField) return;
        
        const anamnesisData = {
            // Clinical Assessment
            diagnosis: document.getElementById('edit_diagnosis').value.trim(),
            treatment_plan: document.getElementById('edit_treatment_plan').value.trim(),
            clinical_notes: document.getElementById('edit_clinical_notes').value.trim(),
            assessment_date: document.getElementById('edit_assessment_date').value,
            
            // Essential Information
            chief_complaint: document.getElementById('edit_anamnesis_chief_complaint').value.trim(),
            pain_scale: parseInt(document.getElementById('edit_anamnesis_pain_scale').value) || 0,
            onset_date: document.getElementById('edit_anamnesis_onset_date').value,
            mechanism: document.getElementById('edit_anamnesis_mechanism').value.trim(),
            
            // Personal Information
            age: document.getElementById('edit_anamnesis_age').value,
            gender: document.getElementById('edit_anamnesis_gender').value,
            occupation: document.getElementById('edit_anamnesis_occupation').value.trim(),
            emergency_contact: document.getElementById('edit_anamnesis_emergency_contact').value.trim(),
            
            // Medical History
            previous_conditions: document.getElementById('edit_anamnesis_previous_conditions').value.trim(),
            surgeries: document.getElementById('edit_anamnesis_surgeries').value.trim(),
            medications: document.getElementById('edit_anamnesis_medications').value.trim(),
            allergies: document.getElementById('edit_anamnesis_allergies').value.trim(),
            
            // Pain Details
            pain_type: document.getElementById('edit_anamnesis_pain_type').value.trim(),
            pain_location: document.getElementById('edit_anamnesis_pain_location').value.trim(),
            pain_triggers: document.getElementById('edit_anamnesis_pain_triggers').value.trim(),
            pain_relievers: document.getElementById('edit_anamnesis_pain_relievers').value.trim(),
            
            // Functional Assessment
            functional_limitations: document.getElementById('edit_anamnesis_functional_limitations').value.trim(),
            physical_activity: document.getElementById('edit_anamnesis_physical_activity').value,
            work_posture: document.getElementById('edit_anamnesis_work_posture').value.trim(),
            sleep: document.getElementById('edit_anamnesis_sleep').value,
            
            // Metadata
            timestamp: new Date().toISOString(),
            version: '2.0'
        };
        
        compiledField.value = JSON.stringify(anamnesisData);
    }

    // Date validation - prevent future dates for date of birth
    const dateOfBirthInput = document.getElementById('date_of_birth');
    const today = new Date().toISOString().split('T')[0];
    dateOfBirthInput.setAttribute('max', today);

    // Merge Patient functionality
    let selectedTargetPatientId = null;
    let searchTimeout = null;

    // Search for patients
    document.getElementById('targetPatientSearch').addEventListener('input', function() {
        const searchTerm = this.value.trim();
        const searchResults = document.getElementById('searchResults');
        const patientSearchResults = document.getElementById('patientSearchResults');
        
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (searchTerm.length < 2) {
            searchResults.style.display = 'none';
            return;
        }
        
        // Debounce search
        searchTimeout = setTimeout(() => {
            fetch('/api/patients/search?q=' + encodeURIComponent(searchTerm))
                .then(response => response.json())
                .then(patients => {
                    // Filter out the current patient
                    const mergeButton = document.querySelector('[data-patient-id]');
                    const currentPatientId = parseInt(mergeButton.getAttribute('data-patient-id'));
                    patients = patients.filter(p => p.id != currentPatientId);
                    
                    if (patients.length > 0) {
                        patientSearchResults.innerHTML = '';
                        patients.forEach(patient => {
                            const item = document.createElement('div');
                            item.className = 'list-group-item list-group-item-action';
                            
                            const contactInfo = patient.contact || 'No contact info';
                            const diagnosisInfo = patient.diagnosis || 'No diagnosis';
                            
                            item.innerHTML = 
                                '<div class="d-flex justify-content-between align-items-center">' +
                                    '<div>' +
                                        '<strong>' + patient.name + '</strong><br>' +
                                        '<small class="text-muted">' +
                                            contactInfo + ' | ' +
                                            diagnosisInfo + ' | ' +
                                            patient.status +
                                        '</small>' +
                                    '</div>' +
                                    '<button class="btn btn-sm btn-outline-primary" onclick="selectTargetPatient(' + patient.id + ', \'' + patient.name.replace(/'/g, '\\\'') + '\', \'' + contactInfo.replace(/'/g, '\\\'') + '\', \'' + diagnosisInfo.replace(/'/g, '\\\'') + '\', \'' + patient.status + '\')">' +
                                        'Select' +
                                    '</button>' +
                                '</div>';
                            patientSearchResults.appendChild(item);
                        });
                        searchResults.style.display = 'block';
                    } else {
                        patientSearchResults.innerHTML = '<div class="list-group-item text-muted">No patients found</div>';
                        searchResults.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error searching patients:', error);
                    patientSearchResults.innerHTML = '<div class="list-group-item text-danger">Error searching patients</div>';
                    searchResults.style.display = 'block';
                });
        }, 300);
    });

    // Select target patient
    function selectTargetPatient(id, name, contact, diagnosis, status) {
        selectedTargetPatientId = id;
        
        // Hide search results
        document.getElementById('searchResults').style.display = 'none';
        
        // Show selected target info
        const selectedTarget = document.getElementById('selectedTarget');
        const targetPatientInfo = document.getElementById('targetPatientInfo');
        
        targetPatientInfo.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>{{ _('Name') }}:</strong> ${name}<br>
                    <strong>{{ _('Contact') }}:</strong> ${contact || '{{ _("Not provided") }}'}<br>
                    <strong>{{ _('Status') }}:</strong> <span class="badge bg-${status === 'Active' ? 'success' : status === 'Inactive' ? 'secondary' : 'info'}">${status}</span>
                </div>
                <div class="col-md-6">
                    <strong>{{ _('Diagnosis') }}:</strong> ${diagnosis || '{{ _("Not provided") }}'}<br>
                    <strong>{{ _('ID') }}:</strong> ${id}
                </div>
            </div>
        `;
        
        selectedTarget.style.display = 'block';
        
        // Enable confirm button
        document.getElementById('confirmMergeBtn').disabled = false;
        
        // Clear search input
        document.getElementById('targetPatientSearch').value = '';
    }

    // Confirm merge
    document.getElementById('confirmMergeBtn').addEventListener('click', function() {
        if (!selectedTargetPatientId) {
            alert('Please select a target patient first');
            return;
        }
        
        if (confirm('Are you sure you want to merge this patient? This action cannot be undone and will delete the current patient profile.')) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const mergeButton = document.querySelector('[data-patient-id]');
            const currentPatientId = mergeButton.getAttribute('data-patient-id');
            
            fetch('/patient/' + currentPatientId + '/merge', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    target_patient_id: selectedTargetPatientId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Patient merged successfully!');
                    window.location.href = '/patient/' + selectedTargetPatientId;
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error merging patients:', error);
                alert('An error occurred while merging patients');
            });
        }
    });
</script>
{% endblock %}
{% endblock %}