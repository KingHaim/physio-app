{% extends "base.html" %}

{% block title %}{{ _('View Treatment') }} - {{ treatment.treatment_type }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-clipboard-pulse"></i> {{ _('Treatment Details') }}</h2>
                    <div>
                    <a href="{{ url_for('main.edit_treatment', id=treatment.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> {{ _('Edit Treatment') }}
                        </a>
                    <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-arrow-left"></i> {{ _('Back to Patient') }}
                        </a>
                </div>
            </div>
            <p class="text-muted">
                {{ _('Viewing treatment for') }} <strong>{{ patient.name }}</strong> {{ _('on') }} 
                <strong>{{ treatment.created_at.strftime('%Y-%m-%d') if treatment.created_at else _('No date') }}</strong>
            </p>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Left column - Basic Info -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> {{ _('Treatment Information') }}</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 40%">{{ _('Date:') }}</th>
                            <td>{{ treatment.created_at.strftime('%Y-%m-%d %H:%M') if treatment.created_at else _('Not set') }}</td>
                        </tr>
                        <tr>
                            <th>{{ _('Treatment Type:') }}</th>
                            <td>{{ treatment.treatment_type }}</td>
                        </tr>
                        <tr>
                            <th>{{ _('Pain Level:') }}</th>
                            <td>
                                {% if treatment.pain_level is not none %}
                                    {% set width = treatment.pain_level * 10 %}
                                    <div class="progress" style="height: 20px;" title="{{ _('Pain:') }} {{ treatment.pain_level }}/10">
                                        <div class="progress-bar bg-danger" role="progressbar"
                                             data-width="{{ width }}"
                                             aria-valuenow="{{ width }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100">
                                            {{ treatment.pain_level }}/10
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-muted">{{ _('Not recorded') }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>{{ _('Movement Restriction:') }}</th>
                            <td>{{ treatment.movement_restriction if treatment.movement_restriction else _('None specified') }}</td>
                        </tr>
                        <tr>
                            <th>{{ _('Status:') }}</th>
                            <td>
                                {% if treatment.status == 'Completed' %}
                                    <span class="badge bg-success">{{ _('Completed') }}</span>
                                {% elif treatment.status == 'In Progress' %}
                                    <span class="badge bg-warning">{{ _('In Progress') }}</span>
                                {% elif treatment.status == 'Scheduled' %}
                                    <span class="badge bg-primary">{{ _('Scheduled') }}</span>
                                {% elif treatment.status == 'Cancelled' %}
                                    <span class="badge bg-danger">{{ _('Cancelled') }}</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ treatment.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if treatment.provider %}
                        <tr>
                            <th>{{ _('Provider:') }}</th>
                            <td>{{ treatment.provider }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <!-- Right column - Location & Financial Info -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> {{ _('Location & Financial') }}</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 40%">{{ _('Location:') }}</th>
                            <td>{{ treatment.location_name if treatment.location_name else _('Not specified') }}</td>
                        </tr>
                        {% if treatment.visit_type %}
                        <tr>
                            <th>{{ _('Visit Type:') }}</th>
                            <td>{{ treatment.visit_type }}</td>
                        </tr>
                        {% endif %}
                        {% if treatment.fee_charged %}
                        <tr>
                            <th>{{ _('Fee Charged:') }}</th>
                            <td>€{{ treatment.fee_charged }}</td>
                        </tr>
                        {% endif %}
                        {% if treatment.payment_method %}
                        <tr>
                            <th>{{ _('Payment Method:') }}</th>
                            <td>{{ treatment.payment_method }}</td>
                        </tr>
                        {% endif %}
                        {% if treatment.clinic_share %}
                        <tr>
                            <th>{{ _('Clinic Share:') }}</th>
                            <td>€{{ treatment.clinic_share }}</td>
                        </tr>
                        {% endif %}
                        {% if treatment.therapist_share %}
                        <tr>
                            <th>{{ _('Therapist Share:') }}</th>
                            <td>€{{ treatment.therapist_share }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Body Chart and Trigger Points -->
    {% if treatment.evaluation_data or treatment.trigger_points or treatment.body_chart_url %}
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person"></i> {{ _('Body Chart & Trigger Points') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>{{ _('Trigger Points Map') }}</h6>
                            <div class="body-map-container">
                                <img src="{{ url_for('static', filename='images/bodychart.svg') }}" class="body-map" alt="{{ _('Body chart') }}">
                                <svg class="body-map-overlay" viewBox="0 0 500 800" xmlns="http://www.w3.org/2000/svg">
                                    <!-- Plot recorded trigger points -->
                                    {% if treatment.evaluation_data %}
                                        {% for point in treatment.evaluation_data %}
                                        <circle cx="{{ point.x }}"
                                               cy="{{ point.y }}"
                                               r="7"
                                               class="trigger-point {{ point.type }}"
                                               data-toggle="tooltip"
                                               title="{{ point.muscle }} (Intensity: {{ point.intensity }}/10)"/>
                                        {% endfor %}
                                    {% else %}
                                        {% for point in treatment.trigger_points %}
                                        <circle cx="{{ point.location_x }}"
                                               cy="{{ point.location_y }}"
                                               r="7"
                                               class="trigger-point {{ point.type }}"
                                               data-toggle="tooltip"
                                               title="{{ point.muscle }} (Intensity: {{ point.intensity }}/10)"/>
                                        {% endfor %}
                                    {% endif %}
                                </svg>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Trigger Points Details -->
                            <h6>{{ _('Trigger Points Analysis') }}</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>{{ _('Type') }}</th>
                                            <th>{{ _('Muscle') }}</th>
                                            <th>{{ _('Intensity') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if treatment.evaluation_data %}
                                            {% for point in treatment.evaluation_data %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if point.type == 'active' 
                                                                            else 'warning' if point.type == 'latent' 
                                                                            else 'info' }}">
                                                        {{ point.type }}
                                                    </span>
                                                </td>
                                                <td>{{ point.muscle }}</td>
                                                <td>{{ point.intensity }}/10</td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            {% for point in treatment.trigger_points %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if point.type == 'active' 
                                                                            else 'warning' if point.type == 'latent' 
                                                                            else 'info' }}">
                                                        {{ point.type }}
                                                    </span>
                                                </td>
                                                <td>{{ point.muscle }}</td>
                                                <td>{{ point.intensity }}/10</td>
                                            </tr>
                                            {% endfor %}
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Additional Chart Info -->
        <div class="col-md-4">
            {% if treatment.body_chart_url %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">{{ _('Additional Body Chart') }}</h6>
                </div>
                <div class="card-body">
                    <img src="{{ treatment.body_chart_url }}" alt="{{ _('Body Chart') }}" class="img-fluid border">
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
                    
    <!-- Notes Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-journal-text"></i> {{ _('Notes') }}</h5>
                </div>
                <div class="card-body">
                        <div class="p-3 bg-light rounded">
                        {% if treatment.notes %}
                            <p>{{ treatment.notes|replace('\n', '<br>')|safe }}</p>
                        {% else %}
                            <p class="text-muted">{{ _('No notes recorded for this treatment.') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
                    </div>
                    
    <!-- Actions Row -->
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <button class="btn btn-danger" data-treatment-id="{{ treatment.id }}" onclick="confirmDelete(this.dataset.treatmentId)">
                            <i class="bi bi-trash"></i> {{ _('Delete Treatment') }}
                        </button>
                <div>
                    <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> {{ _('Back to Patient') }}
                    </a>
                        <a href="{{ url_for('main.edit_treatment', id=treatment.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> {{ _('Edit Treatment') }}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

<style>
    .body-map-container {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        position: relative;
        cursor: crosshair;
    }

    .body-map {
        width: 100%;
        height: auto;
        display: block;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
    }

    .body-map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    }

    .trigger-point {
        cursor: pointer;
        pointer-events: all;
    }

    .trigger-point.active {
        fill: #dc3545;
    }

    .trigger-point.latent {
        fill: #ffc107;
    }

    .trigger-point.satellite {
        fill: #17a2b8;
    }
    
    .trigger-points-display .point-item {
        background: #f8f9fa;
    }
</style>

<script>
    function confirmDelete(treatmentId) {
        if (confirm('{{ _("Are you sure you want to delete this treatment? This action cannot be undone.") }}')) {
            // Create a form to submit the delete request
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/treatment/${treatmentId}/delete`;
            
            // Add CSRF token
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrf_token';
            csrfToken.value = '{{ csrf_token() }}';
            form.appendChild(csrfToken);
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips for trigger points
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Set progress bar widths from data attributes
        document.querySelectorAll('.progress-bar[data-width]').forEach(function(bar) {
            var width = bar.getAttribute('data-width');
            bar.style.width = width + '%';
        });
    });
</script>
{% endblock %} 