{% extends "base.html" %}

{% block title %}Edit Treatment Session{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            {# Pass the flag to the JS via a data attribute #}
            <div class="card" data-has-past-treatments="{{ has_past_treatments | tojson }}">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-plus"></i> Edit Treatment Session
                    </h5>
                    <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Patient
                    </a>
                </div>
                <div class="card-body">
                    <div style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4><i class="bi bi-info-circle"></i> Editing Treatment for {{ patient.name }}</h4>
                        <p>You are editing the treatment session from <strong>{{ treatment.created_at.strftime('%Y-%m-%d') }}</strong>.</p>
                    </div>
                    
                    <form action="{{ url_for('main.edit_treatment', id=treatment.id) }}" method="POST" id="editTreatmentForm">
                        {# Correctly place the token in a hidden input #}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        {# Hidden inputs remain part of the form #}
                        <input type="hidden" id="location" name="location" value="{{ treatment.location or '' }}">
                        <input type="hidden" id="visit_type" name="visit_type" value="{{ treatment.visit_type or '' }}">
                        <input type="hidden" id="payment_method" name="payment_method" value="{{ treatment.payment_method or '' }}">
                        {# Hidden div for trigger points moved inside form, keep input separate or generated by JS #}
                        <input type="hidden" id="trigger_points_data_hidden" name="trigger_points_data" value=''>
                        <div id="initialDataContainer" data-points='{{ treatment.evaluation_data | tojson | safe }}' style="display: none;"></div>

                        {# Tab Navigation #}
                        <ul class="nav nav-tabs mb-3" id="treatmentTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="clinical-tab" data-bs-toggle="tab" data-bs-target="#clinical" type="button" role="tab" aria-controls="clinical" aria-selected="true">Clinical Details</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab" aria-controls="financial" aria-selected="false">Financial & Scheduling</button>
                            </li>
                        </ul>

                        {# Tab Content #}
                        <div class="tab-content" id="treatmentTabContent">
                            {# Clinical Details Tab Pane #}
                            <div class="tab-pane fade show active" id="clinical" role="tabpanel" aria-labelledby="clinical-tab">
                        <div class="row">
                                    <!-- Left Column: Clinical Fields -->
                            <div class="col-md-6">
                                        <h5 class="mb-3">Clinical Information</h5>
                                        <div class="mb-3"> <label for="date" class="form-label">Treatment Date</label> <input type="date" class="form-control" id="date" name="date" value="{{ treatment.created_at.strftime('%Y-%m-%d') }}" required> </div>
                                        <div class="mb-3"> <label for="treatment_type" class="form-label">Treatment Description</label> <input type="text" class="form-control" id="treatment_type" name="treatment_type" value="{{ treatment.description }}" required> </div>
                                        <div class="mb-3"> <label for="status" class="form-label">Status</label> <select class="form-select" id="status" name="status"> <option value="Scheduled" {% if treatment.status == 'Scheduled' %}selected{% endif %}>Scheduled</option> <option value="In Progress" {% if treatment.status == 'In Progress' %}selected{% endif %}>In Progress</option> <option value="Completed" {% if treatment.status == 'Completed' %}selected{% endif %}>Completed</option> <option value="Cancelled" {% if treatment.status == 'Cancelled' %}selected{% endif %}>Cancelled</option> </select> </div>
                                        <div class="mb-3"> <label for="pain_level" class="form-label">Pain Level (1-10)</label> <input type="number" class="form-control" id="pain_level" name="pain_level" min="1" max="10" value="{{ treatment.pain_level or '' }}"> </div>
                                        <div class="mb-3"> <label for="movement_restriction" class="form-label">Movement Restriction</label> <input type="text" class="form-control" id="movement_restriction" name="movement_restriction" value="{{ treatment.movement_restriction or '' }}"> </div>
                                <div class="mb-3">
                                            <label for="notes" class="form-label mb-0">Progress Notes</label>
                                            <div class="btn-group" role="group" aria-label="Voice note actions">
                                                <button type="button" id="recordNoteBtn" class="btn btn-sm btn-outline-secondary">
                                                    <i class="bi bi-mic-fill"></i> Record
                                                </button>
                                                <div class="btn-group" role="group">
                                                    <button id="languageSelectBtn" type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-current-lang="en-GB">
                                                        EN
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end" id="languageDropdownMenu" aria-labelledby="languageSelectBtn">
                                                        <li><a class="dropdown-item lang-option" href="#" data-lang="en-GB">EN (UK)</a></li>
                                                        <li><a class="dropdown-item lang-option" href="#" data-lang="es-ES">ES (Spain)</a></li>
                                                        <li><a class="dropdown-item lang-option" href="#" data-lang="fr-FR">FR (France)</a></li>
                                                        <li><a class="dropdown-item lang-option" href="#" data-lang="it-IT">IT (Italy)</a></li>
                                                    </ul>
                                </div>
                                                <span id="recordingStatus" class="text-muted small ms-2 align-self-center" style="display: none;"></span>
                                            </div>
                                        </div>
                                        <textarea class="form-control" id="notes" name="notes" rows="6">{{ treatment.progress_notes }}</textarea>
                                    </div>
                                    <!-- Right Column: Body Chart -->
                                    <div class="col-md-6">
                                        <h5 class="mb-3">Body Chart & Trigger Points</h5>
                                        <div class="card mb-3"> <!-- Body Map Card -->
                                            <div class="card-header"> <div class="d-flex justify-content-between align-items-center"> <h6 class="mb-0">Body Map</h6> <div class="btn-group btn-group-sm" role="group"> <button type="button" class="btn btn-outline-danger active" data-point-type="active">Active</button> <button type="button" class="btn btn-outline-warning" data-point-type="latent">Latent</button> <button type="button" class="btn btn-outline-info" data-point-type="satellite">Satellite</button> </div> </div> </div>
                                            <div class="card-body"> <div class="body-map-container"> <img src="{{ url_for('static', filename='images/bodychart.svg') }}" class="body-map" id="bodyMapImage" alt="Body chart"> <svg class="body-map-overlay" viewBox="0 0 300 500" xmlns="http://www.w3.org/2000/svg"><g id="triggerPoints"></g></svg> </div> <div class="text-muted small mt-2">Click on the body map to add trigger points</div> </div>
                                        </div>
                                        <div class="card"> <!-- Trigger Points Table Card -->
                                             <div class="card-header"> <h6 class="mb-0">Trigger Points</h6> </div>
                                             <div class="card-body"> <div class="table-responsive"> <table class="table table-sm"> <thead><tr><th>Type</th><th>Muscle</th><th>Intensity</th><th>Symptoms</th><th>Referral</th><th></th></tr></thead> <tbody id="pointsTableBody"></tbody> </table> </div> </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                
                            {# Financial & Scheduling Tab Pane #}
                            <div class="tab-pane fade" id="financial" role="tabpanel" aria-labelledby="financial-tab">
                                <h5 class="mb-3">Financial & Scheduling Information</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        {# --- Location Selection --- #}
                                        <div class="mb-3"> <label class="form-label">Location</label> <div class="row g-2"> <div class="col"> <div class="location-card card card-body text-center" data-location="{{ current_user.clinic_name }}"> <i class="bi bi-hospital fs-1 mb-2"></i> <div>{{ current_user.clinic_name }}</div> </div> </div> <div class="col"> <div class="location-card card card-body text-center" data-location="Home Visit"> <i class="bi bi-house-door fs-1 mb-2"></i> <div>Home Visit</div> </div> </div> </div> </div>
                                        {# --- Conditional Visit Type/Fee Section --- #}
                                        <div id="costaspineOptions" class="mb-3 border p-3 rounded" style="display: none;">
                                            <label class="form-label">Visit Type ({{ current_user.clinic_name }})</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="costaspine_visit_type" id="firstVisitRadio" value="Initial" data-fee="{{ current_user.clinic_first_session_fee|default(80.00) }}">
                                                <label class="form-check-label" for="firstVisitRadio">First Visit (€{{ current_user.clinic_first_session_fee|default(80.00) }})</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="costaspine_visit_type" id="followUpRadio" value="Follow-up" data-fee="{{ current_user.clinic_subsequent_session_fee|default(70.00) }}">
                                                <label class="form-check-label" for="followUpRadio">Follow-up (€{{ current_user.clinic_subsequent_session_fee|default(70.00) }})</label>
                                            </div>
                                        </div>
                                        {# --- Fee Charged --- #}
                                        <div class="mb-3"> <label for="fee_charged" class="form-label">Fee Charged (€)</label> <input type="number" step="0.01" class="form-control" id="fee_charged" name="fee_charged" value="{{ treatment.fee_charged or '' }}" placeholder="Select location first"> </div>
                                    </div>
                                    <div class="col-md-6">
                                        {# --- Payment Method Selection --- #}
                                        <div class="mb-3"> <label class="form-label">Payment Method</label> <div class="row g-2"> <div class="col"> <div class="location-card payment-card card card-body text-center" data-payment="Cash"> <i class="bi bi-cash-coin fs-1 mb-2"></i> <div>Cash</div> </div> </div> <div class="col"> <div class="location-card payment-card card card-body text-center" data-payment="Card"> <i class="bi bi-credit-card fs-1 mb-2"></i> <div>Card</div> </div> </div> </div> </div>
                                        {# --- Next Appointment --- #}
                                        <div class="mb-3"> <label for="next_appointment" class="form-label">Next Appointment Date</label> <input type="date" class="form-control" id="next_appointment" name="next_appointment" value="{{ treatment.created_at.strftime('%Y-%m-%d') if treatment.created_at else '' }}"> <div class="form-text">Optional: Leave blank if no follow-up is scheduled yet</div> </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {# End Tab Content #}
                        
                        {# Submit Button (outside tabs, inside form) #}
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Save Changes
                            </button>
                        </div>
                    </form>
                    
                    {# Initial data container remains outside form, but JS needs to ensure hidden input is IN form #}
                    <div id="initialDataContainer" data-points='{{ treatment.evaluation_data | tojson | safe }}' style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .body-map-container {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        position: relative;
        cursor: crosshair;
    }
    
    .body-map {
        width: 100%;
        height: auto;
        display: block;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
    }
    
    .body-map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10; /* Ensure overlay is above the image */
    }
    
    .trigger-point {
        cursor: pointer;
        transition: r 0.2s ease;
        pointer-events: all;
    }
    
    .muscle-select {
        min-width: 120px;
    }

    /* New styles for location cards (Copied from new_treatment_page) */
    .location-card {
        cursor: pointer;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: 2px solid transparent;
    }

    .location-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,.1);
    }

    .location-card.selected {
        border-color: var(--bs-primary); /* Bootstrap primary color */
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), .5);
        background-color: var(--bs-light);
    }

    .location-card i {
        color: var(--bs-secondary);
    }
    .location-card.selected i {
         color: var(--bs-primary);
    }
</style>

<script>
    // Store initial treatment data passed from Flask
    const initialTreatmentData = {
        location: "{{ treatment.location | default('', true) }}",
        visit_type: "{{ treatment.visit_type | default('', true) }}",
        fee_charged: "{{ treatment.fee_charged | default('', true) }}",
        payment_method: "{{ treatment.payment_method | default('', true) }}"
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Get the past treatment flag
        const cardElement = document.querySelector('.card[data-has-past-treatments]');
        const hasPastTreatments = cardElement ? cardElement.dataset.hasPastTreatments === 'true' : false;
        console.log("Patient Has Past Treatments (Edit Page):", hasPastTreatments);

        // Trigger point management
        let triggerPoints = [];
        let pointIdCounter = 1;
        let currentPointType = 'active';
        
        // Load existing trigger points from data attribute
        let initialPoints = []; // Default to empty array
        const initialDataContainer = document.getElementById('initialDataContainer');
        if (initialDataContainer && initialDataContainer.dataset.points) {
            try {
                initialPoints = JSON.parse(initialDataContainer.dataset.points);
                if (!Array.isArray(initialPoints)) { // Ensure it's an array
                    console.error('Initial trigger points data is not an array:', initialPoints);
                    initialPoints = []; // Reset to empty if not array
                }
            } catch (e) {
                console.error('Error parsing initial trigger points data:', e, initialDataContainer.dataset.points);
                // Keep initialPoints as empty array
            }
        }

        // Load the parsed points using the addPoint function
        console.log(`Found ${initialPoints.length} initial points to load.`);
        initialPoints.forEach((point, index) => {
            console.log(`Loading point ${index + 1}:`, point);
            if (typeof point === 'object' && point !== null) {
                addPoint(point.x, point.y, point.type, point);
            } else {
                console.error(`Invalid point data found at index ${index}:`, point);
            }
        });
        console.log('Finished loading initial points. Current JS array:', triggerPoints);
        
        // Point type selection
        const pointTypeButtons = document.querySelectorAll('[data-point-type]');
        pointTypeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                pointTypeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPointType = this.dataset.pointType;
            });
        });
        
        // Get color for point type
        function getPointColor(type) {
            switch(type) {
                case 'active': return '#dc3545';
                case 'latent': return '#ffc107';
                case 'satellite': return '#17a2b8';
                default: return '#dc3545';
            }
        }
        
        // Create table row for a point
        function createTableRow(point) {
            const row = document.createElement('tr');
            row.dataset.pointId = point.id;
            
            row.innerHTML = `
                <td>
                    <span class="badge bg-${point.type === 'active' ? 'danger' : (point.type === 'latent' ? 'warning' : 'info')}">
                        ${point.type}
                    </span>
                </td>
                <td>
                    <select class="form-select form-select-sm muscle-select" onchange="updatePointData('${point.id}', 'muscle', this.value)">
                        <option value="">Select muscle</option>
                        <option value="Trapezius" ${point.muscle === 'Trapezius' ? 'selected' : ''}>Trapezius</option>
                        <option value="Levator Scapulae" ${point.muscle === 'Levator Scapulae' ? 'selected' : ''}>Levator Scapulae</option>
                        <option value="Rhomboids" ${point.muscle === 'Rhomboids' ? 'selected' : ''}>Rhomboids</option>
                        <option value="Deltoid" ${point.muscle === 'Deltoid' ? 'selected' : ''}>Deltoid</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" min="1" max="10" 
                           onchange="updatePointData('${point.id}', 'intensity', this.value)" value="${point.intensity || ''}"
                           placeholder="1-10">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           onchange="updatePointData('${point.id}', 'symptoms', this.value)" value="${point.symptoms || ''}"
                           placeholder="Symptoms">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           onchange="updatePointData('${point.id}', 'referral', this.value)" value="${point.referral || ''}"
                           placeholder="Referral">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removePoint('${point.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }
        
        // Function to update the hidden form input
        function updateFormData() {
            let dataInput = document.getElementById('trigger_points_data_hidden');
            if (!dataInput) {
                dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.id = 'trigger_points_data_hidden';
                dataInput.name = 'trigger_points_data';
                document.getElementById('editTreatmentForm').appendChild(dataInput);
            }
            try {
                dataInput.value = JSON.stringify(triggerPoints);
            } catch (e) {
                console.error('Error stringifying trigger points:', e);
                dataInput.value = '[]'; 
            }
        }
        
        // Add point to both SVG and table - Standardized (Existing code, adjusted to use global triggerPoints)
        function addPoint(x, y, type = currentPointType, existingData = null) {
            console.log('addPoint called with:', x, y, type, existingData);
            
            const pointId = existingData && existingData.id ? existingData.id : `point-${pointIdCounter++}`;
            
            const pointData = {
                id: pointId,
                x: parseFloat(existingData?.x ?? x) || 0,
                y: parseFloat(existingData?.y ?? y) || 0,
                type: existingData?.type ?? type ?? 'active',
                intensity: existingData?.intensity ?? '',
                muscle: existingData?.muscle ?? '',
                symptoms: existingData?.symptoms ?? '',
                referral: existingData?.referral ?? ''
            };
            pointData.intensity = pointData.intensity !== '' ? parseInt(pointData.intensity, 10) : '';
            if (isNaN(pointData.intensity)) pointData.intensity = '';

            console.log('Processing pointData:', pointData);

            const existingIndex = triggerPoints.findIndex(p => p.id === pointId);
            if (existingIndex === -1) {
                console.log(`Adding new point ${pointId} to JS array.`);
                triggerPoints.push(pointData);
            } else {
                console.log(`Updating existing point ${pointId} in JS array.`);
                triggerPoints[existingIndex] = pointData;
            }

            const pointsGroup = document.getElementById('triggerPoints');
            let circle = pointsGroup.querySelector(`circle[data-point-id="${pointId}"]`);
            if (!circle) {
                console.log(`Creating SVG circle for ${pointId}`);
                circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("data-point-id", pointId);
                circle.setAttribute("class", "trigger-point");
                circle.addEventListener('mouseover', () => circle.setAttribute("r", "5"));
                circle.addEventListener('mouseout', () => circle.setAttribute("r", "3"));
                    pointsGroup.appendChild(circle);
            } else {
                 console.log(`Updating SVG circle for ${pointId}`);
            }
            circle.setAttribute("cx", pointData.x);
            circle.setAttribute("cy", pointData.y);
            circle.setAttribute("r", "3");
            circle.setAttribute("fill", getPointColor(pointData.type));
            circle.setAttribute("stroke", "none");
            circle.setAttribute("stroke-width", "0");

            const tbody = document.getElementById('pointsTableBody');
            let row = tbody.querySelector(`tr[data-point-id="${pointId}"]`);
            const newRowContent = createTableRow(pointData);
            if (row) {
                 console.log(`Updating table row for ${pointId}`);
                 row.innerHTML = newRowContent.innerHTML;
            } else {
                 console.log(`Creating table row for ${pointId}`);
                 tbody.appendChild(newRowContent);
            }
            
            updateFormData(); 
        }
        
        // Update existing point data
        window.updatePointData = function(pointId, field, value) {
            const point = triggerPoints.find(p => p.id === pointId);
            if (point) {
                if (field === 'intensity') {
                    point[field] = value ? parseInt(value, 10) : '';
                } else {
                    point[field] = value;
                }
                updateFormData();
            }
        };
        
        // Remove point
        window.removePoint = function(pointId) {
            const index = triggerPoints.findIndex(p => p.id === pointId);
            if (index > -1) {
                triggerPoints.splice(index, 1);
                document.querySelector(`circle[data-point-id="${pointId}"]`)?.remove();
                document.querySelector(`tr[data-point-id="${pointId}"]`)?.remove();
                updateFormData();
            }
        };
        
        // Setup SVG click handler
        const bodyMapContainer = document.querySelector('.body-map-container');
        const bodyMapImage = document.getElementById('bodyMapImage');
        const bodyMapOverlay = document.querySelector('.body-map-overlay');
        
        if (bodyMapOverlay) {
            bodyMapOverlay.style.pointerEvents = 'all';
            bodyMapOverlay.addEventListener('click', function(evt) {
                evt.preventDefault();
                evt.stopPropagation();
                
                const pt = bodyMapOverlay.createSVGPoint();
                pt.x = evt.clientX;
                pt.y = evt.clientY;
                const svgP = pt.matrixTransform(bodyMapOverlay.getScreenCTM().inverse());
                
                console.log(`SVG click at (${svgP.x}, ${svgP.y})`);
                addPoint(svgP.x, svgP.y);
            });
        }

        // --- Location/Fee Logic (Copied from new_treatment_page, with adaptations for edit) ---
        const locationCards = document.querySelectorAll('.location-card[data-location]');
        const costaspineOptionsDiv = document.getElementById('costaspineOptions');
        const feeInput = document.getElementById('fee_charged');
        const hiddenLocationInput = document.getElementById('location');
        const hiddenVisitTypeInput = document.getElementById('visit_type');
        const costaspineRadios = document.querySelectorAll('input[name="costaspine_visit_type"]');
        const followUpRadio = document.getElementById('followUpRadio');
        const firstVisitRadio = document.getElementById('firstVisitRadio');

        // Function to set initial state based on loaded data
        function setInitialLocationFeeState() {
            const initialLocation = hiddenLocationInput.value; 
            const initialVisitType = hiddenVisitTypeInput.value;

            console.log("Initial Edit State:", { initialLocation, initialVisitType, fee: feeInput.value });

            if (initialLocation) {
                const selectedCard = document.querySelector(`.location-card[data-location="${initialLocation}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected'); 

                    if (initialLocation === '{{ current_user.clinic_name }}') {
                        costaspineOptionsDiv.style.display = 'block';
                        feeInput.readOnly = true; 
                        feeInput.placeholder = 'Select visit type above';
                        
                        // Check the correct radio button based on *saved* visit type first
                        let radioToCheck = document.querySelector(`input[name="costaspine_visit_type"][value="${initialVisitType}"]`);
                        
                        // If no visit type saved OR if it was 'Follow-up', AND they have past treatments, default to Follow-up
                        if ((!initialVisitType || initialVisitType === 'Follow-up') && hasPastTreatments && followUpRadio) {
                            console.log("Setting initial state to Follow-up based on history.")
                            radioToCheck = followUpRadio;
                        }
                        // If somehow 'Initial' was saved, respect that even if they have history
                        else if (initialVisitType === 'Initial' && firstVisitRadio) {
                             console.log("Setting initial state to Initial based on saved value.")
                             radioToCheck = firstVisitRadio;
                        } // If 'Follow-up' was saved, use that (covered by first condition essentially)
                        
                        if (radioToCheck) {
                            radioToCheck.checked = true;
                            // Manually update hidden input and fee just in case it wasn't pre-filled correctly
                            hiddenVisitTypeInput.value = radioToCheck.value;
                            feeInput.value = radioToCheck.dataset.fee;
                        } else {
                             feeInput.placeholder = 'Select visit type'; // Default placeholder if no match
                             console.warn("Could not determine initial radio state for CostaSpine.");
                        }
                    } else { // Home Visit
                        costaspineOptionsDiv.style.display = 'none';
                        feeInput.readOnly = false; 
                        feeInput.placeholder = 'Enter fee for home visit';
                    }
                } else {
                     console.warn("Initial location value doesn't match any card:", initialLocation);
                     feeInput.readOnly = false; 
                     feeInput.placeholder = 'Enter fee';
                }
            } else {
                 feeInput.readOnly = false;
                 feeInput.placeholder = 'Select location first';
            }
        }

        // Add Event Listeners (Handle clicks after page load)
        locationCards.forEach(card => {
            card.addEventListener('click', function() {
                locationCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                const selectedLocation = this.dataset.location;
                hiddenLocationInput.value = selectedLocation;

                if (selectedLocation === '{{ current_user.clinic_name }}') {
                    costaspineOptionsDiv.style.display = 'block';
                    costaspineRadios.forEach(radio => radio.checked = false);
                    feeInput.value = ''; 
                    feeInput.readOnly = true;
                    feeInput.placeholder = 'Select visit type above';
                    hiddenVisitTypeInput.value = '';
                    // *** Check for past treatments on CLICK ***
                    if (hasPastTreatments && followUpRadio) {
                        console.log("Auto-selecting Follow-up on click due to past treatments.");
                        followUpRadio.checked = true;
                        followUpRadio.dispatchEvent(new Event('change')); 
                    }
                     // *** End check ***
                } else { 
                    costaspineOptionsDiv.style.display = 'none';
                    costaspineRadios.forEach(radio => radio.checked = false);
                    feeInput.readOnly = false; 
                    feeInput.placeholder = 'Enter fee for home visit';
                    hiddenVisitTypeInput.value = '';
                    // On Edit: When switching TO home visit, we should probably keep the existing fee?
                    // Let's keep feeInput.value as is unless manually cleared.
                }
            });
        });

        costaspineRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    feeInput.value = this.dataset.fee;
                    feeInput.readOnly = true;
                    hiddenVisitTypeInput.value = this.value;
                }
            });
        });

        // --- Payment Method Logic --- 
        const paymentCards = document.querySelectorAll('.payment-card'); 
        const hiddenPaymentInput = document.getElementById('payment_method');

        // Function to set initial payment state
        function setInitialPaymentState() {
            const initialPaymentMethod = hiddenPaymentInput.value; // Get from hidden input
            console.log("Initial Payment Method:", initialPaymentMethod);
            if (initialPaymentMethod) {
                const selectedCard = document.querySelector(`.payment-card[data-payment="${initialPaymentMethod}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                } else {
                    console.warn("Initial payment method doesn't match any card:", initialPaymentMethod);
                }
            }
        }

        // Add Event Listeners for Payment Cards
        paymentCards.forEach(card => {
            card.addEventListener('click', function() {
                paymentCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                hiddenPaymentInput.value = this.dataset.payment; 
                console.log('Payment Method Selected:', hiddenPaymentInput.value);
            });
        });
        // --- End Payment Method Logic ---

        // Set initial states after setting up listeners
        setInitialLocationFeeState();
        setInitialPaymentState();

        // --- Trigger point management (Existing code) ---
        // ... (rest of trigger point code) ...

        updateFormData(); // Initialize hidden field for trigger points
    });
</script>
{% endblock %} 