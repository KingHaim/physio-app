{% extends "base.html" %}

{% block title %}Edit Treatment Session{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-plus"></i> Edit Treatment Session
                    </h5>
                    <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Patient
                    </a>
                </div>
                <div class="card-body">
                    <div style="background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <h4><i class="bi bi-info-circle"></i> Editing Treatment for {{ patient.name }}</h4>
                        <p>You are editing the treatment session from <strong>{{ treatment.created_at.strftime('%Y-%m-%d') }}</strong>.</p>
                    </div>
                    
                    <form action="{{ url_for('main.edit_treatment', id=treatment.id) }}" method="POST" id="editTreatmentForm">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <h5 class="mb-3">Treatment Information</h5>
                                
                                <div class="mb-3">
                                    <label for="date" class="form-label">Treatment Date</label>
                                    <input type="date" class="form-control" id="date" name="date" 
                                           value="{{ treatment.created_at.strftime('%Y-%m-%d') }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="treatment_type" class="form-label">Treatment Description</label>
                                    <input type="text" class="form-control" id="treatment_type" name="treatment_type" 
                                           value="{{ treatment.description }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="Scheduled" {% if treatment.status == 'Scheduled' %}selected{% endif %}>Scheduled</option>
                                        <option value="In Progress" {% if treatment.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                        <option value="Completed" {% if treatment.status == 'Completed' %}selected{% endif %}>Completed</option>
                                        <option value="Cancelled" {% if treatment.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                                    </select>
                                    <div class="form-text text-muted">
                                        Tip: Mark treatments as "Completed" after they're done to improve AI-generated reports.
                                    </div>
                                </div>

                                {# New Financial Fields #}
                                <div class="mb-3">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="location" name="location" 
                                           value="{{ treatment.location or '' }}" placeholder="e.g., CostaSpine Clinic, Home Visit">
                                </div>

                                <div class="mb-3">
                                    <label for="visit_type" class="form-label">Visit Type</label>
                                    <select class="form-select" id="visit_type" name="visit_type">
                                        <option value="" {% if not treatment.visit_type %}selected{% endif %}>Select Type</option>
                                        <option value="Initial" {% if treatment.visit_type == 'Initial' %}selected{% endif %}>Initial Visit</option>
                                        <option value="Follow-up" {% if treatment.visit_type == 'Follow-up' %}selected{% endif %}>Follow-up</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="fee_charged" class="form-label">Fee Charged (â‚¬)</label>
                                    <input type="number" step="0.01" class="form-control" id="fee_charged" name="fee_charged" 
                                           value="{{ treatment.fee_charged or '' }}" placeholder="e.g., 70.00">
                                </div>

                                <div class="mb-3">
                                    <label for="payment_method" class="form-label">Payment Method</label>
                                    <select class="form-select" id="payment_method" name="payment_method">
                                        <option value="" {% if not treatment.payment_method %}selected{% endif %}>Select Method</option>
                                        <option value="Cash" {% if treatment.payment_method == 'Cash' %}selected{% endif %}>Cash</option>
                                        <option value="Card" {% if treatment.payment_method == 'Card' %}selected{% endif %}>Card</option>
                                        <option value="Transfer" {% if treatment.payment_method == 'Transfer' %}selected{% endif %}>Transfer</option>
                                        <option value="Other" {% if treatment.payment_method == 'Other' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                {# End New Financial Fields #}
                                
                                <div class="mb-3">
                                    <label for="next_appointment" class="form-label">Next Appointment Date</label>
                                    <input type="date" class="form-control" id="next_appointment" name="next_appointment" 
                                           value="{{ treatment.created_at.strftime('%Y-%m-%d') if treatment.created_at else '' }}">
                                    <div class="form-text">Leave blank if no follow-up is scheduled</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="pain_level" class="form-label">Pain Level (1-10)</label>
                                    <input type="number" class="form-control" id="pain_level" name="pain_level" 
                                           min="1" max="10" value="{{ treatment.pain_level or '' }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="movement_restriction" class="form-label">Movement Restriction</label>
                                    <input type="text" class="form-control" id="movement_restriction" name="movement_restriction" 
                                           value="{{ treatment.movement_restriction or '' }}">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Progress Notes</label>
                                    <textarea class="form-control" id="notes" name="notes" 
                                              rows="6">{{ treatment.progress_notes }}</textarea>
                                </div>
                            </div>
                            
                            <!-- Right Column - Body Chart -->
                            <div class="col-md-6">
                                <h5 class="mb-3">Body Chart & Trigger Points</h5>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">Body Map</h6>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-danger active" data-point-type="active">Active</button>
                                                <button type="button" class="btn btn-outline-warning" data-point-type="latent">Latent</button>
                                                <button type="button" class="btn btn-outline-info" data-point-type="satellite">Satellite</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="body-map-container">
                                            <img src="{{ url_for('static', filename='images/bodychart.svg') }}" class="body-map" id="bodyMapImage" alt="Body chart">
                                            <svg class="body-map-overlay" viewBox="0 0 300 500" xmlns="http://www.w3.org/2000/svg">
                                                <g id="triggerPoints"></g>
                                            </svg>
                                        </div>
                                        <div class="text-muted small mt-2">Click on the body map to add trigger points</div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Trigger Points</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Muscle</th>
                                                        <th>Intensity</th>
                                                        <th>Symptoms</th>
                                                        <th>Referral</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="pointsTableBody">
                                                    <!-- Trigger points will be added here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{{ url_for('main.patient_detail', id=patient.id) }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Save Changes
                            </button>
                        </div>
                    </form>

                    {# Hidden div to store initial trigger points data #}
                    <div id="initialDataContainer" 
                         data-points='{{ treatment.evaluation_data | tojson | safe }}'
                         style="display: none;">
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .body-map-container {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        position: relative;
        cursor: crosshair;
    }
    
    .body-map {
        width: 100%;
        height: auto;
        display: block;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f8f9fa;
    }
    
    .body-map-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10; /* Ensure overlay is above the image */
    }
    
    .trigger-point {
        cursor: pointer;
        transition: r 0.2s ease;
        pointer-events: all;
    }
    
    .muscle-select {
        min-width: 120px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Trigger point management
        let triggerPoints = [];
        let pointIdCounter = 1;
        let currentPointType = 'active';
        
        // Load existing trigger points from data attribute
        let initialPoints = []; // Default to empty array
        const initialDataContainer = document.getElementById('initialDataContainer');
        if (initialDataContainer && initialDataContainer.dataset.points) {
            try {
                initialPoints = JSON.parse(initialDataContainer.dataset.points);
                if (!Array.isArray(initialPoints)) { // Ensure it's an array
                    console.error('Initial trigger points data is not an array:', initialPoints);
                    initialPoints = []; // Reset to empty if not array
                }
            } catch (e) {
                console.error('Error parsing initial trigger points data:', e, initialDataContainer.dataset.points);
                // Keep initialPoints as empty array
            }
        }

        // Load the parsed points using the addPoint function
        console.log(`Found ${initialPoints.length} initial points to load.`);
        initialPoints.forEach((point, index) => {
            console.log(`Loading point ${index + 1}:`, point);
            if (typeof point === 'object' && point !== null) {
                addPoint(point.x, point.y, point.type, point);
            } else {
                console.error(`Invalid point data found at index ${index}:`, point);
            }
        });
        console.log('Finished loading initial points. Current JS array:', triggerPoints);

        // Point type selection
        const pointTypeButtons = document.querySelectorAll('[data-point-type]');
        pointTypeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                pointTypeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPointType = this.dataset.pointType;
            });
        });
        
        // Get color for point type
        function getPointColor(type) {
            switch(type) {
                case 'active': return '#dc3545';
                case 'latent': return '#ffc107';
                case 'satellite': return '#17a2b8';
                default: return '#dc3545';
            }
        }
        
        // Create table row for a point
        function createTableRow(point) {
            const row = document.createElement('tr');
            row.dataset.pointId = point.id;
            
            row.innerHTML = `
                <td>
                    <span class="badge bg-${point.type === 'active' ? 'danger' : (point.type === 'latent' ? 'warning' : 'info')}">
                        ${point.type}
                    </span>
                </td>
                <td>
                    <select class="form-select form-select-sm muscle-select" onchange="updatePointData('${point.id}', 'muscle', this.value)">
                        <option value="">Select muscle</option>
                        <option value="Trapezius" ${point.muscle === 'Trapezius' ? 'selected' : ''}>Trapezius</option>
                        <option value="Levator Scapulae" ${point.muscle === 'Levator Scapulae' ? 'selected' : ''}>Levator Scapulae</option>
                        <option value="Rhomboids" ${point.muscle === 'Rhomboids' ? 'selected' : ''}>Rhomboids</option>
                        <option value="Deltoid" ${point.muscle === 'Deltoid' ? 'selected' : ''}>Deltoid</option>
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" min="1" max="10" 
                           onchange="updatePointData('${point.id}', 'intensity', this.value)" value="${point.intensity || ''}"
                           placeholder="1-10">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           onchange="updatePointData('${point.id}', 'symptoms', this.value)" value="${point.symptoms || ''}"
                           placeholder="Symptoms">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           onchange="updatePointData('${point.id}', 'referral', this.value)" value="${point.referral || ''}"
                           placeholder="Referral">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removePoint('${point.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }
        
        // Function to update the hidden form input
        function updateFormData() {
            let dataInput = document.getElementById('trigger_points_data_hidden');
            if (!dataInput) {
                dataInput = document.createElement('input');
                dataInput.type = 'hidden';
                dataInput.id = 'trigger_points_data_hidden';
                dataInput.name = 'trigger_points_data';
                document.getElementById('editTreatmentForm').appendChild(dataInput);
            }
            try {
                dataInput.value = JSON.stringify(triggerPoints);
            } catch (e) {
                console.error('Error stringifying trigger points:', e);
                dataInput.value = '[]'; 
            }
        }
        
        // Add point to both SVG and table - Standardized (Existing code, adjusted to use global triggerPoints)
        function addPoint(x, y, type = currentPointType, existingData = null) {
            console.log('addPoint called with:', x, y, type, existingData);
            
            const pointId = existingData && existingData.id ? existingData.id : `point-${pointIdCounter++}`;
            
            const pointData = {
                id: pointId,
                x: parseFloat(existingData?.x ?? x) || 0,
                y: parseFloat(existingData?.y ?? y) || 0,
                type: existingData?.type ?? type ?? 'active',
                intensity: existingData?.intensity ?? '',
                muscle: existingData?.muscle ?? '',
                symptoms: existingData?.symptoms ?? '',
                referral: existingData?.referral ?? ''
            };
            pointData.intensity = pointData.intensity !== '' ? parseInt(pointData.intensity, 10) : '';
            if (isNaN(pointData.intensity)) pointData.intensity = '';

            console.log('Processing pointData:', pointData);

            const existingIndex = triggerPoints.findIndex(p => p.id === pointId);
            if (existingIndex === -1) {
                console.log(`Adding new point ${pointId} to JS array.`);
                triggerPoints.push(pointData);
            } else {
                console.log(`Updating existing point ${pointId} in JS array.`);
                triggerPoints[existingIndex] = pointData;
            }

            const pointsGroup = document.getElementById('triggerPoints');
            let circle = pointsGroup.querySelector(`circle[data-point-id="${pointId}"]`);
            if (!circle) {
                console.log(`Creating SVG circle for ${pointId}`);
                circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("data-point-id", pointId);
                circle.setAttribute("class", "trigger-point");
                circle.addEventListener('mouseover', () => circle.setAttribute("r", "5"));
                circle.addEventListener('mouseout', () => circle.setAttribute("r", "3"));
                pointsGroup.appendChild(circle);
            } else {
                 console.log(`Updating SVG circle for ${pointId}`);
            }
            circle.setAttribute("cx", pointData.x);
            circle.setAttribute("cy", pointData.y);
            circle.setAttribute("r", "3");
            circle.setAttribute("fill", getPointColor(pointData.type));
            circle.setAttribute("stroke", "none");
            circle.setAttribute("stroke-width", "0");

            const tbody = document.getElementById('pointsTableBody');
            let row = tbody.querySelector(`tr[data-point-id="${pointId}"]`);
            const newRowContent = createTableRow(pointData);
            if (row) {
                 console.log(`Updating table row for ${pointId}`);
                 row.innerHTML = newRowContent.innerHTML;
            } else {
                 console.log(`Creating table row for ${pointId}`);
                 tbody.appendChild(newRowContent);
            }
            
            updateFormData(); 
        }
        
        // Update existing point data
        window.updatePointData = function(pointId, field, value) {
            const point = triggerPoints.find(p => p.id === pointId);
            if (point) {
                if (field === 'intensity') {
                    point[field] = value ? parseInt(value, 10) : '';
                } else {
                    point[field] = value;
                }
                updateFormData();
            }
        };
        
        // Remove point
        window.removePoint = function(pointId) {
            const index = triggerPoints.findIndex(p => p.id === pointId);
            if (index > -1) {
                triggerPoints.splice(index, 1);
                document.querySelector(`circle[data-point-id="${pointId}"]`)?.remove();
                document.querySelector(`tr[data-point-id="${pointId}"]`)?.remove();
                updateFormData();
            }
        };
        
        // Setup SVG click handler
        const bodyMapContainer = document.querySelector('.body-map-container');
        const bodyMapImage = document.getElementById('bodyMapImage');
        const bodyMapOverlay = document.querySelector('.body-map-overlay');
        
        if (bodyMapOverlay) {
            bodyMapOverlay.style.pointerEvents = 'all';
            bodyMapOverlay.addEventListener('click', function(evt) {
                evt.preventDefault();
                evt.stopPropagation();
                
                const pt = bodyMapOverlay.createSVGPoint();
                pt.x = evt.clientX;
                pt.y = evt.clientY;
                const svgP = pt.matrixTransform(bodyMapOverlay.getScreenCTM().inverse());
                
                console.log(`SVG click at (${svgP.x}, ${svgP.y})`);
                addPoint(svgP.x, svgP.y);
            });
        }

        // Initialize form data just once after loading points
        updateFormData();
    });
</script>
{% endblock %} 